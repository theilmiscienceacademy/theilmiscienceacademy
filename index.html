<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I.L.M.I. Academy - Unified Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- UNIFIED & ENHANCED STYLES --- */
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; background-color: #f3f4f6; }
        .printable-area { font-family: 'Tinos', serif; }
        .urdu { font-family: 'Noto Nastaliq Urdu', serif; direction: rtl; }

        /* Smoother Page Transitions */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }

        .page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; overflow-y: auto; }
        .page.active { display: flex; animation: fadeIn 0.4s ease-out forwards; }
        .page.exiting { animation: fadeOut 0.4s ease-in forwards; }

        /* Redesigned Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: 1px solid transparent; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }

        .btn-primary { background-color: #1f2937; color: white; border-color: #1f2937; }
        .btn-primary:hover { background-color: #111827; }
        .btn-secondary { background-color: white; color: #1f2937; border-color: #d1d5db; }
        .btn-secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .btn-success { background-color: #059669; color: white; border-color: #059669;}
        .btn-success:hover { background-color: #047857; }
        .btn-danger { background-color: #be123c; color: white; border-color: #be123c; }
        .btn-danger:hover { background-color: #9f1239; }

        /* Card & UI Styles */
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .action-card { text-align: left; padding: 0.8rem; border-radius: 1rem; transition: all 0.2s ease; border: 1px solid #e5e7eb; }
        .action-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); border-color: transparent; }
        .status-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: white; padding: 12px 24px; border-radius: 0.75rem; z-index: 1000; font-weight: 500; opacity: 0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transition: opacity 0.5s, transform 0.5s; pointer-events: none; }
        .status-toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        .modal-backdrop { background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); }
        .input-group { margin-bottom: 1.25rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: #1f2937; box-shadow: 0 0 0 2px rgba(31, 41, 55, 0.2); outline: none; }
        .academy-header { text-align: center; border-bottom: 2px solid #27272a; padding-bottom: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 1.25rem; animation: fadeIn 0.8s ease-out; }
        .academy-header img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid #e4e4e7; }
        .academy-name { font-size: 26px; font-weight: 700; color: #18181b; }
        .academy-address { font-size: 13px; color: #52525b; }

		/* --- NEW STYLES FOR POLISHED CHECKBOX LISTS --- */
		.checkbox-item {
			display: flex;
			align-items: center;
			padding: 6px 8px; /* Added padding to make the area larger */
			border-radius: 4px;
			cursor: pointer;
			transition: background-color 0.15s ease;
		}

		.checkbox-item:hover {
			background-color: #f3f4f6; /* Light gray background on hover */
		}

		/* Hide the default checkbox input */
		.checkbox-item input[type="checkbox"] {
			appearance: none;
			-webkit-appearance: none;
			-moz-appearance: none;
			width: 1rem;
			height: 1rem;
			border: 2px solid #9ca3af; /* Default border color */
			border-radius: 4px;
			margin-right: 0.5rem;
			cursor: pointer;
			position: relative;
			top: 1px; /* Align checkmark vertically */
		}

		/* Style for the checked state (blue background and white tick) */
		.checkbox-item input[type="checkbox"]:checked {
			background-color: #3b82f6; /* Blue background */
			border-color: #3b82f6;
		}

		.checkbox-item input[type="checkbox"]:checked::after {
			content: '✓';
			font-size: 1rem;
			color: white;
			position: absolute;
			top: -2px;
			left: 1px;
			font-weight: bold;
		}

        /* --- STYLES SPECIFIC TO RESULT APP --- */
        .result-card-container { max-width: 8.5in; min-height: 11in; margin: 2rem auto; padding: 0.5in; background: white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); display: flex; flex-direction: column; }
        .student-details-table { width: 100%; margin-bottom: 1.5rem; border-collapse: collapse; }
        .student-details-table td { padding: 0.3rem 0.25rem; font-size: 12px; vertical-align: bottom; }
        .student-details-table .label-cell { font-weight: 700; color: #3f3f46; width: 110px; }
        .student-details-table .value-cell { border-bottom: 1px solid #d4d4d8; }
        .result-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .result-table th, .result-table td { border: 1px solid #d4d4d8; padding: 0.4rem; text-align: center; }
        .result-table thead { background-color: #f4f4f5; color: #18181b; font-weight: 600; }
        .result-table td:first-child { text-align: left; font-weight: 500; }
        .signature-section { margin-top: auto; padding-top: 2rem; display: flex; justify-content: space-between; }
        .signature-line { width: 250px; text-align: center; border-top: 1px solid #71717a; padding-top: 0.5rem; font-size: 13px; }
        .grade-A-plus, .grade-A { color: #15803d; font-weight: 600; } .grade-F { color: #b91c1c; font-weight: 600; }
        .page-break { page-break-after: always; }

        /* --- STYLES SPECIFIC TO ATTENDANCE APP (FIXED LAYOUT) --- */
        .attendance-container { background: white; padding: 2rem; margin: 2rem auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 0.5rem;}
        .attendance-table {
             width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            table-layout: auto; /* CRITICAL FIX: Changed from fixed to auto */
            white-space: nowrap; /* Prevents text wrapping */
        }
        .attendance-table caption { font-size: 1.75rem; font-weight: bold; padding-bottom: 1.5rem; font-family: 'Tinos', serif; text-align: left; }
        .attendance-table th, .attendance-table td { border: 1px solid #d1d5db; padding: 4px; text-align: center; }
        .attendance-table thead th { background-color: #f3f4f6; position: sticky; top: 0; font-size: 11px; padding: 8px 4px;}

        /* Give specific columns guidance on their width */
        .attendance-table .sno-info { width: 3%; } /* CRITICAL FIX: Small percentage width */
        .attendance-table .student-details-col { width: 25%; text-align: left; padding: 6px 8px; vertical-align: top; white-space: normal; } /* Let student details wrap if needed */
        .attendance-table .summary-col { width: 4%; } /* CRITICAL FIX: Small percentage width */

        .student-name-main { font-weight: 600; color: #111827; font-size: 11px; }
        .student-meta-info { font-size: 9px; color: #6b7280; }
        .attendance-table .day-col input { width: 100%; border: none; background: transparent; text-align: center; text-transform: uppercase; }
        .attendance-table .day-col input:focus { outline: none; background: #fffbeb; }
        .status-P { background-color: #dcfce7; color: #166534; font-weight: bold; }
        .status-A { background-color: #fee2e2; color: #991b1b; font-weight: bold; }
        .status-L { background-color: #fef9c3; color: #854d0e; font-weight: bold; }
        .status-H { background-color: #e0f2fe; color: #075985; font-weight: bold; }
        .wizard-student-card { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.75rem; }
        .wizard-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: 2px solid transparent; }
        .wizard-btn.selected { border-color: #16a34a; }
        .contact-input { color: #6b7280; font-style: italic; border: none !important; box-shadow: none !important; padding-left: 0 !important; margin-top: -5px; }
        .contact-input:focus { outline: none; }

        /* --- STYLES FOR NEW REPORTING FEATURES --- */
        .full-report-container { background: white; padding: 2rem; margin: 2rem auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 0.5rem;}
        .full-report-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .full-report-table caption { font-size: 1.75rem; font-weight: bold; padding-bottom: 1.5rem; font-family: 'Tinos', serif; text-align: left; }
        .full-report-table th, .full-report-table td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: center; }
        .full-report-table thead th { background-color: #f3f4f6; position: sticky; top: 0; white-space: nowrap; }
        .full-report-table tbody tr:nth-child(even) { background-color: #f9fafb; }
		/* --- STYLES FOR NEW REPORTING FEATURES --- */
		/* ... */
		.full-report-table .student-name-col {
			text-align: left;
			font-weight: 600; /* Change from 500 (medium) to 600 (semibold) or 700 (bold) */
			color: #111827; /* Darker color for emphasis */
		}
        .full-report-table .summary-col { font-weight: bold; background-color: #f8fafc; }
        .pos-1 { background-color: #fffbeb !important; border-left: 4px solid #facc15; } /* Gold */
        .pos-2 { background-color: #f8fafc !important; border-left: 4px solid #d1d5db; } /* Silver */
        .pos-3 { background-color: #fff7ed !important; border-left: 4px solid #fb923c; } /* Bronze */

        /* --- STYLES SPECIFIC TO ANALYTICS APP --- */
        .analytics-container { max-width: 1200px; margin: 2rem auto; }
        .chart-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .subject-rank-1 { background-image: linear-gradient(135deg, #fef08a, #facc15); color: #422006; }
        .subject-rank-2 { background-image: linear-gradient(135deg, #e5e7eb, #9ca3af); color: #1f2937; }
        .subject-rank-3 { background-image: linear-gradient(135deg, #ffedd5, #fb923c); color: #431407; }
        .subject-rank-weak { background-image: linear-gradient(135deg, #fee2e2, #f87171); color: #7f1d1d; }

        /* --- STYLES FOR FEEDBACK SYSTEM --- */
        .feedback-card {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            border-left-width: 4px;
            /* border-left-color is set dynamically */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease-in-out;
        }
        .feedback-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07);
        }

        /* --- STYLES FOR STUDENT REGISTRATION --- */
        .subject-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.2s;
            animation: popIn 0.3s ease-out forwards;
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }


        /* --- STYLES FOR ORGANIZATION MANAGEMENT --- */
        .role-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 600; font-size: 0.8rem; text-align: center; display: inline-block; }
        .role-tag-admin { background-color: #fee2e2; color: #b91c1c; } /* Red */
        .role-tag-editor { background-color: #fef9c3; color: #854d0e; } /* Yellow */
        .role-tag-viewer { background-color: #dcfce7; color: #166534; } /* Green */

		/* --- STYLES SPECIFIC TO TEST GENERATOR --- */
        .wizard-step { display: none; }
        .question-block { background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem; }
        .question-block h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; color: #111827; }
        .sub-block { background-color: #fff; border: 1px solid #d1d5db; padding: 1rem; border-radius: 0.75rem; margin-top: 1.25rem;}

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7, 0 0 20px #6d28d9, 0 0 30px #6d28d9; }
            50% { transform: scale(1.03); box-shadow: 0 0 10px #c084fc, 0 0 20px #c084fc, 0 0 30px #7e22ce, 0 0 40px #7e22ce; }
        }
        .btn-ai { background: linear-gradient(90deg, #a855f7, #6d28d9); color: white; font-weight: 700; text-shadow: 0 0 2px rgba(255,255,255,0.7); animation: pulse-glow 2.5s infinite ease-in-out; }

        /* --- Paper & Print Styles --- */
        .paper-container { border: 1px solid #ccc; padding: 40px; background-color: #ffffff; font-family: 'Tinos', serif; font-size: 14px; margin: 0 auto; max-width: 8.5in; }
        .paper-page { position: relative; overflow: hidden; page-break-after: always; min-height: 11in; }
        .paper-page:last-child { page-break-after: auto; }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: auto; opacity: 0.08; z-index: 0; pointer-events: none; }
        .main-header-table { width: 100%; margin-bottom: 20px; border-bottom: 1px solid #ddd; position: relative; z-index: 1; }
        .logo-cell { width: 100px; padding-right: 20px; vertical-align: middle; }
        .academy-header-print { text-align: center; vertical-align: middle; }
        .details-header-table { width: 100%; border: 2px solid black; border-collapse: collapse; margin-bottom: 30px; font-size: 16px; position: relative; z-index: 1; }
        .details-header-table td { border: 1px solid #aaa; padding: 8px; }
        .section-title { font-weight: bold; font-size: 22px; text-align: center; margin-top: 30px; margin-bottom: 15px; text-decoration: underline; }
        .question-title { font-weight: bold; font-size: 16px; margin-top: 20px; margin-bottom: 10px; position: relative; z-index: 1; overflow: hidden; }
        .marks { float: right; }
        .urdu .marks { float: left; }
        .question-content { margin-top: 5px; line-height: 1.8; clear: both; }
        .question-item { margin-bottom: 8px; }
        .long-question-part { margin-left: 20px; margin-bottom: 5px; }
        .urdu .long-question-part { margin-right: 20px; margin-left: 0; }

        /* --- Special Print Rule for Blank Page --- */
        body.printing-blank-page > *:not(#blank-page-for-printing-wrapper) {
            display: none !important;
        }

        /* --- ENHANCED PRINT STYLES --- */
        .print-footer {
            display: none;
            /* Hidden by default */
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
                /* Force no margins from the browser */
             }

            /* This new rule forces ALL elements (including your logo) to print in full color */
            * {
                -webkit-print-color-adjust: exact !important;
                 print-color-adjust: exact !important;
            }

            /* This keeps the page background white for printing */
            body {
                 background-color: #fff !important;
            }

            /* Hide all buttons, controls, and pages that are not being printed */
            .no-print,
            .page:not(.printing) {
                display: none !important;
            }

            /* Reset the layout of the page being printed to a simple block */
            .page.printing {
                display: block !important;
                position: static !important;
                width: 100%;
                height: auto;
                overflow: visible;
                box-shadow: none;
                border: none;
            }

            .page.printing>main {
                padding: 0 !important;
                margin: 0 !important;
            }

            /* This is the key rule that cleans up the result card for paper */
            .result-card-container {
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0.25in !important;     /* Adds a small internal margin for safety */
                page-break-inside: avoid;
                height: 10.6in;                 /* A height that fits within A4 margins */
                min-height: auto !important;    /* CRITICAL: Overrides the screen min-height */
                box-sizing: border-box;         /* Ensures padding is included in the height */
                display: flex !important;           /* Ensures flexbox is active */
                flex-direction: column !important;    /* Ensures vertical layout */
            }

            /* This rule ensures the signature section is always pushed to the bottom */
            .signature-section {
            margin-top: auto !important;
            }

            .print-footer {
                display: block !important;
                position: fixed;
                bottom: 10px;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 10px;
                color: #888;
            }
        }
    </style>
</head>
<body class="bg-white">

    <div id="page-1-login" class="page active items-center justify-center p-4">
        <div class="text-center space-y-6 w-full max-w-md card p-8 md:p-12">
            <img src="https://i.postimg.cc/Dzz5bbVt/Picture1.jpg" alt="Logo" class="w-28 h-28 mx-auto rounded-full object-cover shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/112x112';">
            <div>
                <h1 class="text-4xl font-bold text-gray-900">I.L.M.I. Academy Portal</h1>
                <p class="text-gray-500 mt-2 text-lg">Unified Results & Attendance System</p>
            </div>
            <div id="auth-form" class="space-y-4 pt-4">
                <input id="auth-email" type="email" placeholder="Enter your email" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-gray-800 outline-none transition">
                <input id="auth-password" type="password" placeholder="Enter your password" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-gray-800 outline-none transition">
                <p id="auth-status" class="text-red-500 text-sm h-5"></p>
                <div class="flex gap-4">
                    <button onclick="signInWithEmail()" class="btn btn-primary text-lg w-full">🔑 Login</button>
                </div>
            </div>
            <div id="user-profile" class="hidden items-center justify-center flex-col space-y-4 pt-4">
                <p id="user-name" class="font-semibold text-gray-700 text-xl"></p>
                <button id="proceed-btn" onclick="navigateTo('page-2-main-dashboard')" class="btn btn-success text-lg py-3 w-full" disabled>🚀 Proceed to Portal</button>
                <button onclick="signOutUser()" class="text-sm text-gray-500 hover:underline">Sign Out</button>
            </div>
        </div>
    </div>

    <div id="page-2-main-dashboard" class="page items-center justify-start p-4">
		<main class="w-full max-w-4xl mx-auto p-4 md:p-6"> <header class="academy-header">
				<img src="https://i.postimg.cc/Dzz5bbVt/Picture1.jpg" alt="Logo" class="w-16 h-16">
				<div>
					<div class="academy-name" style="font-size: 28px;">The I.L.M.I Academy Science & Commerce</div>
					<div class="academy-address">Kahna Nau, Lahore</div>
				</div>
			</header>
			<hr class="mb-6 border-gray-200"> <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-left">

				<button onclick="navigateTo('page-student-registration')" class="action-card bg-indigo-50 hover:bg-indigo-100">
					<p class="text-3xl mb-2">🧑‍🎓</p>
					<h3 class="text-base font-bold text-indigo-800">Student Registration</h3>
					<p class="text-xs text-indigo-600">Register new students.</p>
				</button>
				<button onclick="navigateTo('page-results-dashboard')" class="action-card bg-yellow-50 hover:bg-yellow-100 sm:col-span-2">
					<p class="text-3xl mb-2">🏆</p>
					<h3 class="text-base font-bold text-yellow-800">Results System</h3>
					<p class="text-xs text-yellow-600">Manage grades, marks, and batch reports.</p>
				</button>
				<button onclick="navigateTo('page-attendance-classes')" class="action-card bg-green-50 hover:bg-green-100">
					<p class="text-3xl mb-2">✅</p>
					<h3 class="text-base font-bold text-green-800">Attendance System</h3>
					<p class="text-xs text-green-600">Track daily attendance.</p>
				</button>

				<button onclick="navigateTo('page-analytics-dashboard')" class="action-card bg-purple-50 hover:bg-purple-100">
					<p class="text-3xl mb-2">📊</p>
					<h3 class="text-base font-bold text-purple-800">Subject Analytics</h3>
					<p class="text-xs text-purple-600">Analyze class performance.</p>
				</button>
				<button onclick="navigateTo('page-feedback-system')" class="action-card bg-pink-50 hover:bg-pink-100">
					<p class="text-3xl mb-2">🗣️</p>
					<h3 class="text-base font-bold text-pink-800">Feedback System</h3>
					<p class="text-xs text-pink-600">Manage feedback forms.</p>
				</button>
				<button onclick="window.navigateTo('page-teacher-feedback')" class="action-card bg-violet-50 hover:bg-violet-100 relative">
					<p class="text-3xl mb-2">💡</p>
					<h3 class="text-base font-bold text-violet-800">Teacher Suggestions</h3>
					<p class="text-xs text-violet-600">Submit anonymous feedback.</p>
					<span id="feedback-notification-badge" class="absolute top-3 right-3 hidden h-5 w-5 items-center justify-center rounded-full bg-red-600 text-xs font-bold text-white">0</span>
				</button>
				<div class="action-card bg-cyan-50 hover:bg-cyan-100 relative p-0">
					<div class="absolute top-2 right-2 flex gap-2 z-10">
						<button onclick="navigateTo('page-student-sheets-class-select')" class="btn btn-secondary !p-1 text-xs" title="Download Sheet for a Specific Class">📄</button>
						<button onclick="generateAllStudentSheets()" class="btn btn-secondary !p-1 text-xs" title="Download All Student Lists">📥</button>
					</div>
					<button onclick="navigateTo('page-student-management')" class="w-full h-full p-4 text-left">
						<p class="text-3xl mb-2">📚</p>
						<h3 class="text-base font-bold text-cyan-800">Student Management</h3>
						<p class="text-xs text-cyan-600">Edit records and hierarchies.</p>
					</button>
				</div>
				<button onclick="navigateTo('page-teacher-dashboard')" class="action-card bg-orange-50 hover:bg-orange-100 sm:col-span-2">
					<p class="text-3xl mb-2">👨‍🏫</p>
					<h3 class="text-base font-bold text-orange-800">Teacher Logs & Submissions</h3>
					<p class="text-xs text-orange-600">Maintain weekly records and manage faculty.</p>
				</button>
				<button onclick="navigateTo('page-student-term-report')" class="action-card bg-fuchsia-50 hover:bg-fuchsia-100 sm:col-span-2">
					<p class="text-3xl mb-2">📈</p>
					<h3 class="text-base font-bold text-fuchsia-800">Student Term Growth</h3>
					<p class="text-xs text-fuchsia-600">Compare individual student performance.</p>
				</button>

				<div class="sm:col-span-2 md:col-span-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
					<button onclick="navigateTo('page-data-settings')" class="action-card bg-slate-50 hover:bg-slate-100">
						<p class="text-3xl mb-2">⚙️</p>
						<h3 class="text-base font-bold text-slate-800">App Data & Settings</h3>
						<p class="text-xs text-slate-600">Backup and restore data.</p>
					</button>
					<button id="org-management-btn" onclick="navigateTo('page-organization-management')" class="action-card bg-zinc-50 hover:bg-zinc-100 hidden">
						<p class="text-3xl mb-2">🏫</p>
						<h3 class="text-base font-bold text-zinc-800">Org Management</h3>
						<p class="text-xs text-zinc-600">Manage user roles.</p>
					</button>
					<button onclick="signOutUser()" class="action-card bg-stone-50 hover:bg-stone-100">
						<p class="text-3xl mb-2">🚪</p>
						<h3 class="text-base font-bold text-stone-800">Logout</h3>
						<p class="text-xs text-stone-600">Sign out from the portal.</p>
					</button>
				</div>
			</div>
		</main>
    </div>

    <div id="page-results-dashboard" class="page items-center justify-center p-4">
        <main class="w-full max-w-lg mx-auto card p-8 md:p-12 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">🏆 Results Dashboard</h1>
            <div class="grid grid-cols-1 gap-6">
                <button onclick="navigateTo('page-results-class-select')" class="btn btn-primary text-lg py-6">➕ Create New Result (Manual)</button>
                <button onclick="navigateTo('page-results-class-select-batch')" class="btn btn-primary text-lg py-6">✍️ Batch Marks Entry</button>
                <button onclick="navigateTo('page-results-batch-report-generator')" class="btn btn-primary text-lg py-6">📄 Batch Report & Downloads</button>
                <button onclick="openSavedResults()" class="btn btn-secondary text-lg py-6">📂 View Saved Results</button>
            </div>
            <button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary mt-12 w-1/2 mx-auto">⬅️ Back to Portal</button>
        </main>
    </div>

    <div id="page-results-class-select" class="page items-center justify-center p-4">
        <main class="w-full max-w-lg mx-auto card p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Select Student Group for Manual Entry</h1>
            <div class="space-y-4 text-left">
                <div class="input-group">
                    <label for="manual-entry-class-select">🎓 Select Class</label>
                    <select id="manual-entry-class-select" onchange="populateStreamSelect('manual-entry-class-select', 'manual-entry-stream-select', 'manual-entry-group-select', false)"></select>
                </div>
                <div class="input-group">
                    <label for="manual-entry-stream-select">🧮 Select Academic Stream</label>
                    <select id="manual-entry-stream-select" onchange="populateGroupSelect('manual-entry-class-select', 'manual-entry-stream-select', 'manual-entry-group-select', false)" disabled></select>
                </div>
                <div class="input-group">
                    <label for="manual-entry-group-select">📘 Select Subject Group</label>
                    <select id="manual-entry-group-select" disabled></select>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                 <button onclick="navigateTo('page-results-dashboard')" class="btn btn-secondary">⬅️ Back</button>
                 <button id="manual-entry-proceed-btn" onclick="startManualEntry()" class="btn btn-success">Proceed ➡️</button>
            </div>
        </main>
    </div>

    <div id="page-results-class-select-batch" class="page items-center justify-center p-4">
         <main class="w-full max-w-lg mx-auto card p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Select Group for Batch Entry</h1>
            <div class="space-y-4 text-left">
                <div class="input-group">
                    <label for="batch-entry-class-select">🎓 Select Class</label>
                    <select id="batch-entry-class-select" onchange="populateStreamSelect('batch-entry-class-select', 'batch-entry-stream-select', 'batch-entry-group-select', true)"></select>
                </div>
                <div class="input-group">
                    <label for="batch-entry-stream-select">🧮 Select Academic Stream</label>
                    <select id="batch-entry-stream-select" onchange="populateGroupSelect('batch-entry-class-select', 'batch-entry-stream-select', 'batch-entry-group-select', true)" disabled></select>
                </div>
                <div class="input-group">
                    <label for="batch-entry-group-select">📘 Select Subject Group</label>
                    <select id="batch-entry-group-select" disabled></select>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                 <button onclick="navigateTo('page-results-dashboard')" class="btn btn-secondary">⬅️ Back</button>
                 <button onclick="startBatchEntry()" class="btn btn-success">Proceed ➡️</button>
            </div>
        </main>
    </div>

    <div id="page-results-entry" class="page items-center p-4">
        <main class="w-full max-w-4xl mx-auto card p-8">
            <h1 id="entry-heading" class="text-3xl font-bold text-gray-800 mb-8 text-center">Enter Details</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 border-b pb-6 mb-6">
                <div class="input-group"><label for="student-name">Student Name</label><input type="text" id="student-name" placeholder="e.g., Ahmed Ali"></div>
                <div class="input-group"><label for="father-name">Father's Name</label><input type="text" id="father-name" placeholder="e.g., Raza Khan"></div>
                <div class="input-group"><label for="roll-number">Roll Number</label><input type="text" id="roll-number" placeholder="e.g., 2514"></div>
                <div class="input-group"><label for="test-term">Test Term / Exam Name</label><input type="text" id="test-term" placeholder="e.g., Final Term 2025"></div>
            </div>
            <div id="marks-entry-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4"></div>
            <div class="mt-8 pt-6 border-t flex items-center justify-center">
                <div class="flex items-center gap-3 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                    <input type="checkbox" id="include-attendance-summary" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="include-attendance-summary" class="font-medium text-indigo-800">Include Attendance Summary on Result Card</label>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                <button onclick="navigateTo('page-results-class-select')" class="btn btn-secondary">⬅️ Back to Selection</button>
                <div class="flex gap-4">
                    <button onclick="saveResultDirectly()" class="btn btn-primary">☁️ Save & Next</button>
                    <button onclick="generateResult()" class="btn btn-success">Generate & Preview ➡️</button>
                </div>
            </div>
        </main>
    </div>

    <div id="page-results-result" class="page">
        <main class="flex-grow p-4 md:p-8">
            <div id="preview-controls" class="max-w-4xl mx-auto mb-8 p-6 bg-gray-100 border-2 border-dashed border-gray-400 rounded-xl text-center no-print">
                <h2 class="text-2xl font-bold text-slate-800">🎉 Result Generated!</h2>
                <p class="text-slate-600 mb-6">Preview the result card below. You can print, save, or go back to edit.</p>
                <div class="flex justify-center gap-4 flex-wrap">
                    <button onclick="navigateTo('page-results-entry')" class="btn btn-secondary">✏️ Go Back & Edit</button>
                    <button onclick="startNewResultForSameClass()" class="btn btn-secondary">✨ New (Same Group)</button>
                    <button id="save-to-cloud-btn" onclick="saveResultToCloud()" class="btn btn-primary">☁️ Save to Cloud</button>
                    <button onclick="triggerPrint('page-results-result', false)" class="btn btn-success">🖨️ Print / Save as PDF</button>
                    <button id="add-attendance-btn" onclick="addAttendanceToPreview()" class="btn btn-secondary">➕ Add Attendance</button>
                </div>
                <button onclick="navigateTo('page-results-dashboard')" class="text-sm text-gray-500 hover:underline mt-6">Return to Results Dashboard</button>
            </div>
            <div id="final-result-display" class="printable-area"></div>
        </main>
    </div>

    <div id="page-results-saved-results" class="page items-center justify-center modal-backdrop">
        <div class="w-full max-w-3xl card p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">📂 Saved Results</h1>
            <div class="input-group">
                <label for="class-filter">Filter by Class</label>
                <select id="class-filter" onchange="filterAndDisplaySavedResults()" class="w-full p-3 border rounded-lg"></select>
            </div>
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="select-all-checkbox" class="text-sm font-medium text-gray-700">Select All</label>
                </div>
                <div id="batch-actions-container" class="hidden flex gap-2">
                    <button onclick="printSelectedResults(false)" class="btn btn-secondary !p-2 text-sm">🖨️ Print Selected</button>
                    <button onclick="printSelectedResults(true)" class="btn btn-secondary !p-2 text-sm">🖨️ Print w/ Attendance</button>
                    <button onclick="deleteSelectedResults()" class="btn btn-danger !p-2 text-sm">🗑️ Delete Selected</button>
                </div>
            </div>
            <div id="saved-results-list" class="max-h-96 overflow-y-auto border rounded-lg bg-gray-50 p-2 space-y-2"></div>
            <div class="mt-8 flex justify-end">
                <button onclick="navigateTo('page-results-dashboard')" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="page-results-batch-entry" class="page p-4 md:p-8">
        <main class="w-full max-w-5xl mx-auto card p-8">
            <h1 id="batch-entry-heading" class="text-3xl font-bold text-gray-800 mb-6">Batch Marks Entry</h1>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end p-4 border rounded-lg bg-gray-50 mb-6">
                <div class="input-group !mb-0"><label for="batch-subject-select">Select Subject Group</label><select id="batch-subject-select" onchange="renderBatchMarksTable()"></select></div>
                <div class="input-group !mb-0"><label for="batch-test-term">Test Term</label><input type="text" id="batch-test-term" placeholder="e.g., Mid-Term Exam"></div>
                <div class="input-group !mb-0"><label for="batch-total-marks">Total Marks for All</label><input type="number" id="batch-total-marks"></div>
                <button onclick="fetchExistingMarksForBatch()" class="btn btn-secondary h-12">Fetch Existing Marks</button>
            </div>
            <div class="max-h-[50vh] overflow-y-auto">
                <table class="w-full text-sm text-left text-gray-500">
						<thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
							<tr>
								<th class="px-2 py-3 w-10">Sr.</th>
								<th class="px-2 py-3 w-1/4">Student Info</th>
								<th class="px-2 py-3 w-1/4">Contact Info</th>
								<th class="px-2 py-3">Class</th>
								<th class="px-2 py-3">Stream</th>
								<th class="px-2 py-3">Group</th>
								<th class="px-2 py-3 w-20 text-center">Actions</th>
							</tr>
						</thead>
                    <tbody id="batch-marks-table-body"></tbody>
                </table>
            </div>
            <div class="mt-8 flex justify-between">
                <button onclick="navigateTo('page-results-dashboard')" class="btn btn-secondary">⬅️ Back to Dashboard</button>
                <button onclick="saveAllMarks()" class="btn btn-success">💾 Save All Marks</button>
            </div>
        </main>
    </div>

    <div id="page-results-batch-report-generator" class="page items-center justify-center p-4">
        <main class="w-full max-w-3xl mx-auto card p-8 md:p-12">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">📄 Batch Report & Downloads</h1>
                <p class="text-gray-600 mb-8">Generate and download reports for an entire class or group.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 border-b pb-6 mb-6 items-end">
                <div class="input-group !mb-0 col-span-2">
                    <label for="batch-report-class-select">🎓 Select Class</label>
                    <select id="batch-report-class-select" onchange="populateStreamSelect('batch-report-class-select', 'batch-report-stream-select', 'batch-report-group-select', true, populateTermAndSubjectDropdowns)"></select>
                </div>
                <div class="input-group !mb-0">
                    <label for="batch-report-stream-select">🧮 Select Academic Stream</label>
                    <select id="batch-report-stream-select" onchange="populateGroupSelect('batch-report-class-select', 'batch-report-stream-select', 'batch-report-group-select', true, populateTermAndSubjectDropdowns)" disabled></select>
                </div>
                 <div class="input-group !mb-0">
                    <label for="batch-report-group-select">📘 Select Subject Group</label>
                    <select id="batch-report-group-select" onchange="populateTermAndSubjectDropdowns()" disabled></select>
                </div>
                <div class="input-group !mb-0">
                    <label for="batch-report-term-select">🗓️ Select Term</label>
                    <select id="batch-report-term-select" class="w-full p-3 border rounded-lg" disabled></select>
                </div>
                <div class="input-group !mb-0">
                    <label for="batch-report-subject-select">📚 Subject (Optional)</label>
                    <select id="batch-report-subject-select" class="w-full p-3 border rounded-lg" disabled></select>
                </div>
                <div class="flex items-center justify-center gap-3 bg-gray-50 p-3 rounded-lg border h-[52px]">
                    <input type="checkbox" id="batch-report-include-attendance" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                    <label for="batch-report-include-attendance" class="font-medium text-gray-700 m-0">✅ Include Attendance %</label>
                </div>
            </div>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                 <button onclick="generateBatchReport()" class="btn btn-success w-full md:w-auto">🚀 Generate Report</button>
            </div>
             <div class="text-center mt-8">
                <button onclick="navigateTo('page-results-dashboard')" class="btn btn-secondary w-1/2 mx-auto">⬅️ Back to Dashboard</button>
            </div>
        </main>
    </div>

    <div id="page-results-batch-report-display" class="page">
         <main class="flex-grow p-2 md:p-4">
            <div class="max-w-7xl mx-auto mb-4 p-4 bg-gray-100 border-2 border-dashed border-gray-400 rounded-xl no-print">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <div>
                             <h2 id="batch-report-heading" class="text-xl font-bold text-slate-800 text-left"></h2>
                             <p id="batch-report-subheading" class="text-sm text-slate-600"></p>
                        </div>
                    </div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="navigateTo('page-results-batch-report-generator')" class="btn btn-secondary">⬅️ Back to Selection</button>
                        <button onclick="triggerPrint('page-results-batch-report-display', true)" class="btn btn-primary">🖨️ Print / Save PDF</button>
                        <button onclick="downloadBatchReportImage()" class="btn btn-primary">📸 Download Image</button>
                    </div>
                </div>
            </div>
            <div id="batch-report-table-display" class="printable-area full-report-container"></div>
        </main>
    </div>

    <div id="page-attendance-classes" class="page">
        <main class="flex-grow flex flex-col items-center justify-start md:justify-center p-4">
            <div class="text-center w-full max-w-lg mx-auto card p-6">
                <h1 class="text-4xl font-bold text-gray-900 mb-8">✍️ Select a Class for Attendance</h1>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button onclick="selectClassForAttendance('8th')" class="btn btn-secondary text-xl py-8 flex-col gap-2">🎓 <span class="text-base">8th</span></button>
                    <button onclick="selectClassForAttendance('9th')" class="btn btn-secondary text-xl py-8 flex-col gap-2">📚 <span class="text-base">9th</span></button>
                    <button onclick="selectClassForAttendance('10th')" class="btn btn-secondary text-xl py-8 flex-col gap-2">📝 <span class="text-base">10th</span></button>
                    <button onclick="selectClassForAttendance('11th')" class="btn btn-secondary text-xl py-8 flex-col gap-2">🔬 <span class="text-base">11th</span></button>
                    <button onclick="selectClassForAttendance('12th')" class="btn btn-secondary text-xl py-8 flex-col gap-2">🧑‍🏫 <span class="text-base">12th</span></button>
                    <button onclick="selectClassForAttendance('Special Class')" class="btn btn-secondary text-xl py-8 flex-col gap-2">⭐ <span class="text-base">Special</span></button>
                </div>
                <div class="mt-12 flex flex-col md:flex-row gap-4 justify-center">
                    <button onclick="openHolidayManager()" class="btn btn-secondary w-full md:w-auto">🗓️ Manage Universal Holidays</button>
                    <button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary mt-0 w-full md:w-auto">⬅️ Back to Portal</button>
                </div>
            </div>
        </main>
    </div>

	<div id="page-student-term-report" class="page p-4 md:p-6">
		<main class="w-full analytics-container">
			<div class="card p-6 no-print mb-6">
				<div class="flex flex-wrap justify-between items-center gap-4">
					<div>
						<h1 class="text-3xl font-bold text-gray-900">📈 Student Term Comparison Report</h1>
						<p class="text-gray-600">Track an individual student's growth across multiple academic terms.</p>
					</div>
					<button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary">⬅️ Back to Portal</button>
				</div>
				
				<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6 border-t pt-6 items-end">
					<div class="input-group !mb-0">
						<label for="term-report-class-select">🎓 Select Class</label>
						<select id="term-report-class-select" onchange="termReport_populateStreamSelect(this.value)"></select>
					</div>
					<div class="input-group !mb-0">
						<label for="term-report-stream-select">🧮 Select Stream/Group</label>
						<select id="term-report-stream-select" onchange="termReport_populateStudentAndTerm()"></select>
					</div>
					<div class="input-group !mb-0">
						<label for="term-report-student-select">🧑‍🎓 Select Student</label>
						<select id="term-report-student-select" disabled></select>
					</div>
					<div class="input-group !mb-0">
						<label for="term-report-term-select">🗓️ Select Terms (Multi-Select)</label>
						<div id="term-report-term-select" 
							 class="w-full p-2 border rounded-lg h-32 overflow-y-auto bg-white space-y-1" 
							 disabled>
							 </div>
					</div>
				</div>
				<div class="flex justify-end mt-4">
					 <button onclick="runTermComparisonReport()" class="btn btn-primary w-full md:w-auto">🚀 Generate Comparison Report</button>
				</div>
			</div>

			<div id="term-report-content" class="space-y-8 printable-area bg-white p-8 rounded-lg shadow-xl hidden">
				<h2 id="term-report-title" class="text-2xl font-bold text-gray-800 text-center"></h2>
				
				<div class="chart-card">
					<h3 class="text-xl font-bold text-gray-800 mb-4">Overall Performance Trend (Total %)</h3>
					<canvas id="term-report-overall-chart"></canvas>
				</div>
				
				<div class="chart-card">
					<h3 class="text-xl font-bold text-gray-800 mb-4">Subject-Wise Growth Comparison</h3>
					<div id="term-report-subject-charts" class="grid grid-cols-1 md:grid-cols-2 gap-6">
						</div>
				</div>
				
				 <div class="text-center no-print mt-8">
					 <button onclick="triggerPrint('page-student-term-report', true)" class="btn btn-success">🖨️ Print Report</button>
				 </div>
			</div>

			<div id="term-report-no-data" class="text-center py-16">
				 <p class="text-5xl mb-4">⚠️</p>
				 <h2 class="text-2xl font-bold text-gray-700">Select Options Above</h2>
				 <p class="text-gray-500 mt-2">Choose a student and multiple terms to view the comparison.</p>
			</div>
		</main>
	</div>

    <div id="page-attendance-students" class="page items-center py-8 px-4">
        <main class="w-full max-w-4xl mx-auto card p-8 md:p-12">
            <h1 id="student-list-heading" class="text-3xl font-bold text-gray-900 mb-2 text-center">One-Time Class Setup</h1>
            <p class="text-gray-600 text-center mb-8">No student list found for this class. Add details below to get started.</p>
            <div id="student-list-form" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div class="mt-8 flex justify-between">
                <div>
                    <button onclick="navigateTo('page-attendance-classes')" class="btn btn-secondary">⬅️ Back to Classes</button>
                    <button onclick="addStudentEntryRow('student-list-form')" class="btn btn-secondary ml-4">➕ Add More Students</button>
                </div>
                <button onclick="saveStudentListAndProceed()" class="btn btn-success">Save & Continue ➡️</button>
            </div>
        </main>
    </div>

    <div id="page-attendance-action-wizard" class="page items-center p-4 py-8">
        <main class="w-full max-w-xl mx-auto card p-8 md:p-12 text-center">
            <h1 id="action-wizard-heading" class="text-4xl font-bold text-gray-900 mb-8"></h1>
            <div class="space-y-4">
                <button onclick="openAttendanceWizard()" class="action-card w-full text-left bg-green-50 hover:bg-green-100"><p class="text-2xl">✍️</p><h3 class="text-lg font-bold text-green-800 mt-2">Mark Today's Attendance</h3><p class="text-green-600">Quickly mark students as present or absent.</p></button>
                <button onclick="openStudentEditor()" class="action-card w-full text-left bg-gray-50 hover:bg-gray-100"><p class="text-2xl">✏️</p><h3 class="text-lg font-bold text-gray-800 mt-2">Edit Student List</h3><p class="text-gray-600">Add or remove students from this class.</p></button>
                <button onclick="openMonthSelectionWizard('edit')" class="action-card w-full text-left bg-yellow-50 hover:bg-yellow-100"><p class="text-2xl">🗓️</p><h3 class="text-lg font-bold text-yellow-800 mt-2">Advanced Attendance Edit</h3><p class="text-yellow-600">Manually edit attendance for any past day.</p></button>
                <button onclick="openMonthSelectionWizard('print')" class="action-card w-full text-left bg-blue-50 hover:bg-blue-100"><p class="text-2xl">🖨️</p><h3 class="text-lg font-bold text-blue-800 mt-2">View / Print a Sheet</h3><p class="text-blue-600">Generate an attendance sheet for any month.</p></button>
                <button onclick="openStudentReportWizard()" class="action-card w-full text-left bg-indigo-50 hover:bg-indigo-100"><p class="text-2xl">📊</p><h3 class="text-lg font-bold text-indigo-800 mt-2">View Student Report</h3><p class="text-indigo-600">Calculate a student's total attendance.</p></button>
                <button onclick="openDeleteWizard()" class="action-card w-full text-left bg-red-50 hover:bg-red-100"><p class="text-2xl">🗑️</p><h3 class="text-lg font-bold text-red-800 mt-2">Delete Records</h3><p class="text-red-600">Permanently delete a month's attendance data.</p></button>
            </div>
            <button onclick="navigateTo('page-attendance-classes')" class="btn btn-secondary mt-12 w-full md:w-1/2 mx-auto">⬅️ Back to Classes</button>
        </main>
    </div>

    <div id="page-attendance-sheet" class="page">
        <main class="flex-grow p-2 md:p-4">
            <div class="max-w-7xl mx-auto mb-4 p-4 bg-gray-100 border-2 border-dashed border-gray-400 rounded-xl text-center no-print">
                <div class="flex justify-between items-center">
                    <div><h2 id="sheet-heading" class="text-2xl font-bold text-slate-800 text-left"></h2></div>
                    <div id="sheet-controls" class="flex justify-center gap-4 flex-wrap">
                        <button onclick="returnToDashboard()" class="btn btn-secondary">⬅️ Back to Dashboard</button>
                        <button id="print-sheet-btn" onclick="triggerPrint('page-attendance-sheet', true)" class="btn btn-primary">🖨️ Print</button>
                        <button id="download-sheet-btn" onclick="downloadSheetAsImage()" class="btn btn-primary">🖼️ Download Image</button>
                        <button id="save-sheet-btn" onclick="saveAdvancedAttendanceChanges()" class="btn btn-success hidden">💾 Save Changes</button>
                    </div>
                </div>
            </div>
            <div id="attendance-sheet-display" class="printable-area attendance-container"></div>
        </main>
    </div>

    <div id="page-attendance-wizard" class="page items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-2xl card p-8 m-4">
            <h1 id="wizard-heading" class="text-2xl font-bold text-gray-900 mb-6"></h1>
            <div class="flex justify-between mb-6"><button onclick="markAll('P')" class="btn btn-secondary">Mark All Present</button><button onclick="markAll('A')" class="btn btn-secondary">Mark All Absent</button></div>
            <div id="wizard-student-list" class="max-h-96 overflow-y-auto"></div>
            <div class="mt-8 flex justify-end gap-4">
                <button onclick="returnToDashboard()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveWizardAttendance()" class="btn btn-success">Save Attendance</button>
            </div>
        </div>
    </div>

    <div id="page-attendance-month-wizard" class="page items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-md card p-8 m-4 text-center">
            <h1 id="month-wizard-heading" class="text-2xl font-bold text-gray-900 mb-6"></h1>
            <div class="flex gap-4">
                <select id="month-select" class="w-full p-3 border rounded-lg"></select>
                <select id="year-select" class="w-full p-3 border rounded-lg"></select>
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button onclick="returnToDashboard()" class="btn btn-secondary">Cancel</button>
                <button id="month-wizard-continue-btn" class="btn btn-success">Continue ➡️</button>
            </div>
        </div>
    </div>

    <div id="page-attendance-edit-students" class="page items-center py-8 px-4">
        <main class="w-full max-w-4xl mx-auto card p-8 md:p-12">
            <h1 id="edit-student-list-heading" class="text-3xl font-bold text-gray-900 mb-8 text-center"></h1>
            <div id="edit-student-list-form" class="max-h-[60vh] overflow-y-auto pr-2"></div>
            <div class="mt-6 flex justify-between">
                <button onclick="addStudentEntryRow('edit-student-list-form', true)" class="btn btn-secondary">➕ Add New Student</button>
                <div>
                    <button onclick="navigateTo('page-attendance-action-wizard')" class="btn btn-secondary mr-4">Cancel</button>
                    <button onclick="saveStudentChanges()" class="btn btn-success">💾 Save Changes</button>
                </div>
            </div>
        </main>
    </div>

    <div id="page-attendance-delete-wizard" class="page items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-md card p-8 m-4 text-center">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">🗑️ Delete Monthly Records</h1>
            <p class="text-gray-600 mb-6">Select a month and year to permanently delete all attendance records for this class in that period. This action cannot be undone.</p>
            <div class="flex gap-4">
                <select id="delete-month-select" class="w-1/2 p-3 border rounded-lg"></select>
                <select id="delete-year-select" class="w-1/2 p-3 border rounded-lg"></select>
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button onclick="returnToDashboard()" class="btn btn-secondary">Cancel</button>
                <button onclick="confirmDeleteRecords()" class="btn btn-danger">Delete Records</button>
            </div>
        </div>
    </div>

    <div id="page-attendance-manage-holidays" class="page items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-lg card p-8 m-4">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">🗓️ Manage Universal Holidays</h1>
             <p class="text-gray-600 mb-6">Holidays added here will apply to all of your classes automatically.</p>
            <div class="space-y-4">
                <input id="holiday-name-input" type="text" placeholder="Holiday Name (e.g., Eid al-Fitr)" class="w-full p-3 border rounded-lg">
                <input id="holiday-date-input" type="date" class="w-full p-3 border rounded-lg">
                <button onclick="addHoliday()" class="btn btn-primary w-full">✨ Add Holiday</button>
                <p class="pt-4 font-semibold text-gray-700">Upcoming Holidays:</p>
                <div id="holidays-list" class="max-h-60 overflow-y-auto border rounded-lg p-2 bg-gray-50"></div>
            </div>
            <div class="mt-8 flex justify-end">
                <button onclick="navigateTo('page-attendance-classes')" class="btn btn-secondary">Done</button>
            </div>
        </div>
    </div>

    <div id="page-attendance-student-report" class="page items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-md card p-8 m-4 text-center">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">📊 Generate Student Report</h1>
            <p class="text-gray-600 mb-6">Select a student to calculate their complete attendance history for this class.</p>
            <select id="student-report-select" class="w-full p-3 border rounded-lg mb-4"></select>
            <button onclick="generateFullStudentReport()" class="btn btn-primary w-full">Generate Report</button>
            <div id="student-report-results" class="mt-6 text-left p-4 bg-gray-50 rounded-lg min-h-[100px]"></div>
            <div class="mt-8 flex justify-end">
                <button onclick="returnToDashboard()" class="btn btn-secondary">Done</button>
            </div>
        </div>
    </div>

    <div id="page-student-sheets-class-select" class="page items-center justify-center p-4">
        <main class="w-full max-w-lg mx-auto card p-8 md:p-12 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">🧑‍🎓 Download Student Sheet</h1>
            <p class="text-gray-600 mb-8 -mt-4">Select a class to generate a branded student list.</p>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <button onclick="generateStudentSheetForClass('8th')" class="btn btn-secondary text-xl py-8">8th</button>
                <button onclick="generateStudentSheetForClass('9th')" class="btn btn-secondary text-xl py-8">9th</button>
                <button onclick="generateStudentSheetForClass('10th')" class="btn btn-secondary text-xl py-8">10th</button>
                <button onclick="generateStudentSheetForClass('11th')" class="btn btn-secondary text-xl py-8">11th</button>
                <button onclick="generateStudentSheetForClass('12th')" class="btn btn-secondary text-xl py-8">12th</button>
                <button onclick="generateStudentSheetForClass('Special Class')" class="btn btn-secondary text-xl py-8">Special</button>
            </div>
            <button onclick="generateAllStudentSheets()" class="btn btn-primary mt-8 w-full">📄 Download All Student Lists</button>
            <button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary mt-4 w-1/2 mx-auto">⬅️ Back to Portal</button>
        </main>
    </div>

    <div id="page-student-sheets-preview" class="page">
        <main class="flex-grow p-2 md:p-4">
            <div class="max-w-7xl mx-auto mb-4 p-4 bg-gray-100 border-2 border-dashed border-gray-400 rounded-xl no-print">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h2 id="student-sheet-heading" class="text-xl font-bold text-slate-800 text-left"></h2>
                    </div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="navigateTo('page-student-sheets-class-select')" class="btn btn-secondary">⬅️ Back to Selection</button>
                        <button onclick="triggerPrint('page-student-sheets-preview', true)" class="btn btn-primary">🖨️ Print / Save PDF</button>
                        <button onclick="downloadStudentSheetImage()" class="btn btn-primary">📸 Download Image</button>
                    </div>
                </div>
            </div>
            <div id="student-sheet-display-area" class="printable-area full-report-container"></div>
        </main>
    </div>

    <div id="page-student-registration" class="page items-center p-4">
        <main class="w-full max-w-4xl mx-auto card p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">🧑‍🎓 New Student Registration</h1>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-b pb-6 mb-6">
                <div class="input-group">
                    <label for="reg-class-select">🎓 Select Class</label>
                    <select id="reg-class-select" onchange="populateClassTypeDropdown()"></select>
                </div>
                <div id="reg-class-type-wrapper" class="input-group hidden">
                    <label for="reg-class-type-select">🧮 Select Class Type</label>
                    <select id="reg-class-type-select" onchange="populateSubgroupDropdown()"></select>
                </div>
                <div id="reg-subgroup-wrapper" class="input-group hidden">
                    <label for="reg-subgroup-select">📘 Select Subgroup</label>
                    <select id="reg-subgroup-select" onchange="displaySubjects()"></select>
                </div>
            </div>

            <div id="reg-subjects-wrapper" class="hidden mb-6">
                <h3 class="font-semibold text-lg text-gray-700 mb-3">📚 Assigned Subjects:</h3>
                <div id="reg-subjects-display" class="flex flex-wrap gap-2">
                    </div>
            </div>

            <div id="reg-student-info-form" class="hidden">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                    <div class="input-group"><label for="reg-student-name">Student's Full Name</label><input type="text" id="reg-student-name" placeholder="e.g., Ahmed Ali" required></div>
                    <div class="input-group"><label for="reg-father-name">Father's Name</label><input type="text" id="reg-father-name" placeholder="e.g., Raza Khan" required></div>
                    <div class="input-group"><label for="reg-roll-number">Assign Roll Number</label><input type="text" id="reg-roll-number" placeholder="e.g., 2514" required></div>
                    <div class="input-group"><label for="reg-gender-select">Gender</label>
                        <select id="reg-gender-select">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="input-group"><label for="reg-dob">Date of Birth</label><input type="date" id="reg-dob"></div>
                    <div class="input-group"><label for="reg-contact-number">Contact Number</label><input type="tel" id="reg-contact-number" placeholder="e.g., 0300-1234567"></div>
                </div>
            </div>

            <div class="mt-8 flex justify-between">
                <button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary">⬅️ Back to Portal</button>
                <div class="flex gap-4">
                    <button id="reg-submit-add-new-btn" onclick="handleRegistrationAndAddNew()" class="btn btn-primary" disabled>💾 Save & Add New</button>
                    <button id="reg-submit-btn" onclick="handleRegistrationSubmit()" class="btn btn-success" disabled>✅ Register Student</button>
                </div>
            </div>
        </main>
    </div>

	<div id="page-student-management" class="page p-4 md:p-8">
		<main class="w-full max-w-7xl mx-auto card p-6 md:p-8">
			<div class="flex flex-wrap justify-between items-center gap-4 mb-6 no-print">
				<div>
					<h1 class="text-3xl font-bold text-gray-900">📚 Student Master Management</h1>
					<p class="text-gray-600">Complete list of all registered students with inline editing.</p>
				</div>
				<button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary">⬅️ Back to Portal</button>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 border-b pb-4">
				<div class="input-group !mb-0">
					<label for="mgmt-class-filter">Filter by Class</label>
					<select id="mgmt-class-filter" onchange="filterStudentsList()" class="w-full p-3 border rounded-lg"></select>
				</div>
				<div class="input-group !mb-0">
					<label for="mgmt-search-filter">Search by Name/Roll No.</label>
					<input type="text" id="mgmt-search-filter" onkeyup="filterStudentsList()" placeholder="Start typing name or roll number..." class="w-full p-3 border rounded-lg">
				</div>
				<div class="flex items-end">
					<button onclick="saveAllStudentChanges()" class="btn btn-success w-full h-12" id="save-student-changes-btn">💾 Save All Changes</button>
				</div>
			</div>

			<div class="overflow-x-auto max-h-[70vh] overflow-y-auto">
				<table class="w-full text-sm text-left text-gray-600 border border-gray-300">
					<thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
						<tr>
							<th class="px-4 py-3 w-10">Sr.</th>
							<th class="px-4 py-3 w-16">Roll No.</th>
							<th class="px-4 py-3 w-1/5">Name</th>
							<th class="px-4 py-3 w-1/5">Father Name</th>
							<th class="px-4 py-3 w-1/5">Class / Program</th>
							<th class="px-4 py-3 w-16">Contact</th>
							<th class="px-4 py-3 w-20 text-center">Actions</th>
						</tr>
					</thead>
					<tbody id="student-management-table-body">
						<tr><td colspan="7" class="text-center p-4">Loading student data...</td></tr>
					</tbody>
				</table>
			</div>
		</main>
	</div>

    <div id="page-analytics-dashboard" class="page p-4 md:p-6">
        <main class="w-full analytics-container">
            <div class="card p-6 no-print mb-6">
                 <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">📊 Subject Performance Analytics</h1>
                        <p class="text-gray-600">Analyze subject-wise performance for any class, stream, or group.</p>
                    </div>
                     <button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary">⬅️ Back to Portal</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 border-t pt-6">
                    <div class="input-group !mb-0">
                        <label for="analytics-class-select">🎓 Select Class</label>
                        <select id="analytics-class-select" onchange="populateStreamSelect('analytics-class-select', 'analytics-stream-select', 'analytics-group-select', true, populateAnalyticsTermDropdown)"></select>
                    </div>
                    <div class="input-group !mb-0">
                        <label for="analytics-stream-select">🧮 Select Academic Stream</label>
                        <select id="analytics-stream-select" onchange="populateGroupSelect('analytics-class-select', 'analytics-stream-select', 'analytics-group-select', true, populateAnalyticsTermDropdown)" disabled></select>
                    </div>
                    <div class="input-group !mb-0">
                        <label for="analytics-group-select">📘 Select Subject Group</label>
                        <select id="analytics-group-select" onchange="populateAnalyticsTermDropdown()" disabled></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                     <div class="input-group !mb-0 col-span-1 md:col-span-2">
                        <label for="analytics-term-select">🗓️ Select Term</label>
                        <select id="analytics-term-select" onchange="runAnalytics()" class="w-full p-3 border rounded-lg" disabled></select>
                    </div>
                    <div class="flex items-end">
                         <button onclick="runAnalytics()" class="btn btn-success w-full h-12">🚀 Analyze</button>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-6 mt-4">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="analytics-include-attendance" onchange="runAnalytics()" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="analytics-include-attendance" class="text-sm font-medium text-gray-700">Include Attendance %</label>
                    </div>
                </div>
            </div>

            <div id="analytics-export-container" class="space-y-6 printable-area bg-gray-50 p-6 rounded-lg">
                <div id="analytics-header-export" class="hidden">
                     <header class="academy-header">
                        <img src="https://i.postimg.cc/Dzz5bbVt/Picture1.jpg" alt="Logo">
                        <div>
                            <div class="academy-name">The I.L.M.I Academy</div>
                            <div class="academy-address">Subject Performance Report</div>
                        </div>
                    </header>
                </div>
                <div id="analytics-report-info" class="text-center mb-4"></div>

                <div id="analytics-content" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-3 chart-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Average Marks per Subject</h3>
                            <canvas id="subject-avg-chart"></canvas>
                        </div>
                        <div class="lg:col-span-2 chart-card">
                             <h3 class="text-xl font-bold text-gray-800 mb-4">Performance Distribution</h3>
                             <canvas id="performance-dist-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Subject Ranking (Highest to Lowest Average)</h3>
                        <div id="subject-ranking-list" class="space-y-3"></div>
                    </div>

                    <div class="chart-card mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Performance Summary</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3">Subject</th>
                                        <th class="px-4 py-3">Class Avg.</th>
                                        <th class="px-4 py-3">Highest</th>
                                        <th class="px-4 py-3">Lowest</th>
                                        <th class="px-4 py-3">Passed</th>
                                        <th class="px-4 py-3">Failed</th>
                                        <th class="px-4 py-3 attendance-col hidden">Avg. Attendance</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-summary-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mt-8 text-center no-print">
                        <button onclick="downloadAnalytics('pdf')" class="btn btn-primary">📥 Download as PDF</button>
                        <button onclick="downloadAnalytics('image')" class="btn btn-secondary">🖼️ Download as Image</button>
                    </div>
                </div>

                <div id="analytics-no-data" class="text-center py-16">
                     <p class="text-5xl mb-4">⚠️</p>
                    <h2 class="text-2xl font-bold text-gray-700">No Data Found</h2>
                    <p class="text-gray-500 mt-2">Please select a class and term with saved results to view analytics.</p>
                </div>
            </div>
        </main>
    </div>


    <div id="page-feedback-system" class="page p-4 md:p-6">
		<main class="w-full max-w-7xl mx-auto">
			 <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
				<div>
					<h1 class="text-3xl font-bold text-gray-900">Feedback System 🗣️</h1>
					<p class="text-gray-600">Manage classes and review submissions.</p>
				</div>
				<button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary">⬅️ Back to Portal</button>
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

				<div class="lg:col-span-1 space-y-6">

					<div class="card p-6">
						<h3 class="text-xl font-bold text-gray-800 mb-4">🎓 Class Management</h3>
						<div class="input-group">
							<label for="feedback-class-select">Add New Class</label>
							<select id="feedback-class-select" onchange="toggleCustomClassInput()">
								<option value="">-- Select a Predefined Class --</option>
								<option value="9th">9th</option>
								<option value="10th">10th</option>
								<option value="11th">11th</option>
								<option value="12th">12th</option>
								<option value="custom">Add Custom Class...</option>
							</select>
						</div>
						<div id="custom-class-input-wrapper" class="input-group hidden">
							<label for="new-class-name">Custom Class Name</label>
							<input type="text" id="new-class-name" placeholder="e.g., Summer Camp Group">
						</div>
						<button onclick="addFeedbackClass()" class="btn btn-success w-full">Add Selected Class</button>
						<div id="feedback-classes-list" class="space-y-2 max-h-48 overflow-y-auto mt-4 pt-4 border-t">
							</div>
					</div>

					<div class="card p-6">
						<h3 class="text-xl font-bold text-gray-800 mb-4">🔗 Your Feedback Link</h3>
						<div class="input-group">
							<label>Your public feedback link is:</label>
							<input type="text" value="https://theilmiscienceacademy.github.io/theilmiscienceacademy/Feedback%20Form.html" readonly class="bg-gray-100 cursor-pointer" onclick="copyFeedbackLink()">
						</div>
						<button onclick="copyFeedbackLink()" class="btn btn-primary w-full">Copy Feedback Link</button>
					</div>

				</div>

				<div class="lg:col-span-2 card p-6">
					<h3 class="text-xl font-bold text-gray-800 mb-4">📥 Received Feedback</h3>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4 mb-4">
						<div class="input-group !mb-0">
							<label for="feedback-class-filter">Filter by Class</label>
							<select id="feedback-class-filter" onchange="loadFeedback()"></select>
						</div>
						<div class="input-group !mb-0">
							<label for="feedback-subject-filter">Filter by Subject</label>
							<select id="feedback-subject-filter" onchange="loadFeedback()"></select>
						</div>
						<div class="flex items-end gap-2">
							<button onclick="exportFeedback()" title="Export as CSV" class="btn btn-secondary w-full h-12">Export CSV</button>
							<button onclick="deleteAllFeedbackForClass()" title="Delete All visible" class="btn btn-danger !px-4 h-12">🗑️</button>
						</div>
					</div>
					<div id="feedback-list" class="max-h-[75vh] overflow-y-auto pr-2">
						</div>
				</div>

			</div>
		</main>
	</div>

	<div id="page-teacher-feedback" class="page p-4 md:p-6">
		<main class="w-full max-w-4xl mx-auto card p-8">
			<div class="flex flex-wrap justify-between items-center gap-4 mb-6">
				<h1 class="text-3xl font-bold text-gray-900">🗣️ Anonymous Suggestion Box</h1>
				<button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary">⬅️ Back to Portal</button>
			</div>

			<div id="teacher-feedback-submission" class="p-6 border rounded-lg bg-indigo-50 mb-8">
				<h2 class="text-xl font-bold text-indigo-800 mb-4">Submit a Suggestion/Concern</h2>
				<p class="text-sm text-indigo-600 mb-4">Your submission will be **completely anonymous** to the administration.</p>
				<div class="input-group">
					<label for="suggestion-area">Your Anonymous Feedback</label>
					<textarea id="suggestion-area" rows="4" placeholder="Enter your suggestion or concern here."></textarea>
				</div>
				<button onclick="submitAnonymousFeedback()" class="btn btn-primary w-full">🚀 Submit Suggestion</button>
			</div>

			<div id="teacher-feedback-admin-panel" class="p-6 border rounded-lg bg-white shadow-xl hidden">
				<h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Review Panel</h2>
				<div class="flex justify-between items-center mb-4 border-b pb-4">
					<h3 id="admin-panel-heading" class="font-semibold text-gray-600">Total New Suggestions: 0</h3>
					<button onclick="loadTeacherFeedback()" class="btn btn-secondary !py-2 !px-4">🔄 Refresh List</button>
				</div>
				<div id="admin-feedback-list" class="space-y-4 max-h-[50vh] overflow-y-auto">
					<p class="text-center text-gray-500 p-4">Loading suggestions...</p>
				</div>
			</div>
		</main>
	</div>

	<div id="modal-admin-comment" class="page items-center justify-center modal-backdrop hidden z-40">
		<div class="w-full max-w-lg card p-8 m-4">
			<h1 class="text-2xl font-bold text-gray-900 mb-4">Review & Comment</h1>
			<div class="bg-gray-50 p-4 rounded-lg border mb-4">
				<h3 class="font-semibold text-gray-700">Suggestion:</h3>
				<p id="modal-feedback-content" class="text-gray-600 whitespace-pre-wrap"></p>
			</div>
			<div class="input-group">
				<label for="admin-comment-area">Admin Comment (Visible to Submitter)</label>
				<textarea id="admin-comment-area" rows="3" placeholder="Enter your official response/comment."></textarea>
			</div>
			<div class="mt-6 flex justify-between gap-4">
				<button onclick="closeAdminCommentModal()" class="btn btn-secondary">Cancel</button>
				<button onclick="saveAdminComment('heard')" class="btn btn-primary">✅ Mark as 'Heard'</button>
				<button onclick="saveAdminComment('resolved')" class="btn btn-success">⭐ Mark as 'Resolved'</button>
			</div>
		</div>
	</div>

    <div id="page-data-settings" class="page items-center justify-start p-4">
        <main class="w-full max-w-2xl mx-auto card p-8 md:p-10">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">⚙️ App Data & Settings</h1>
                    <p id="user-email-display" class="text-gray-600">Signed in as: ...</p>
                </div>
                <button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary !py-2 !px-4 text-sm">Back</button>
            </div>

            <div class="p-6 border rounded-lg bg-gray-50 mb-6">
                <h3 class="text-xl font-bold text-gray-800">☁️ Cloud Storage Usage</h3>
                <p class="text-gray-600 mt-1 mb-4">You are using an estimated <b id="storage-usage-text">...</b> of your cloud storage.</p>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="storage-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-2 flex justify-between">
                    <span>0 MB</span>
                    <span id="storage-limit-text">300 MB Limit</span>
                </div>
            </div>

            <div class="space-y-4">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border rounded-lg bg-white hover:bg-gray-50 transition-all gap-4">
                    <div class="flex items-center gap-4">
                        <div class="bg-blue-100 text-blue-600 p-3 rounded-full flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Offline Backup</h3>
                            <p class="text-sm text-gray-500">Download all your data to a single JSON file for safekeeping.</p>
                        </div>
                    </div>
                    <button onclick="downloadOfflineBackup()" class="btn btn-secondary w-full sm:w-auto flex-shrink-0">Download</button>
                </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border rounded-lg bg-white hover:bg-gray-50 transition-all gap-4">
                    <div class="flex items-center gap-4">
                         <div class="bg-green-100 text-green-600 p-3 rounded-full flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Restore from Backup</h3>
                            <p class="text-sm text-gray-500"><strong class="font-medium text-yellow-600">Warning:</strong> This will overwrite all existing cloud data.</p>
                        </div>
                    </div>
                    <input type="file" id="restore-file-input" accept=".json" class="hidden" onchange="handleRestoreFile(event)">
                    <button onclick="document.getElementById('restore-file-input').click()" class="btn btn-secondary w-full sm:w-auto flex-shrink-0">Upload File</button>
                </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border border-red-200 rounded-lg bg-red-50 transition-all gap-4">
                    <div class="flex items-center gap-4">
                        <div class="bg-red-100 text-red-600 p-3 rounded-full flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-red-800">Delete All Data</h3>
                            <p class="text-sm text-red-600">This action is permanent and cannot be undone.</p>
                        </div>
                    </div>
                    <button onclick="deleteAllCloudData()" class="btn btn-danger w-full sm:w-auto flex-shrink-0">Delete All</button>
                </div>
            </div>
        </main>
    </div>

    <div id="page-organization-management" class="page p-4 md:p-6">
        <main class="w-full max-w-5xl mx-auto card p-8 md:p-10">
            <div id="org-management-content" class="hidden">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">🏫 Organization Management</h1>
                    <button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary">⬅️ Back to Portal</button>
                </div>
				<div class="border-b pb-4 mb-6">
					<button onclick="window.navigateTo('modal-invite-user')" class="btn btn-success">➕ Create New User Account</button>
				</div>
                <div class="input-group">
                    <label for="org-user-search">🔍 Search by Email</label>
                    <input type="text" id="org-user-search" onkeyup="orgMgmt_filterUsers()" placeholder="Enter user email to filter..." class="w-full md:w-1/2 p-3 border rounded-lg">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-4 py-3">S.No</th>
                                <th class="px-4 py-3">Email</th>
                                <th class="px-4 py-3">Role</th>
                                <th class="px-4 py-3">Joined On</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="org-management-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
            <div id="org-management-restricted" class="hidden text-center p-8">
                 <p class="text-5xl mb-4">🚫</p>
                <h2 class="text-2xl font-bold text-red-700">Access Restricted</h2>
                <p class="text-gray-600 mt-2">This page is only accessible to the organization's administrator.</p>
                <button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary mt-8">⬅️ Back to Portal</button>
            </div>
        </main>
    </div>


    <div id="modal-assign-hierarchy" class="page items-center justify-center modal-backdrop hidden z-40">
		<div class="w-full max-w-lg card p-8 m-4">
			<h1 id="assign-hierarchy-title" class="text-2xl font-bold text-gray-900 mb-6">Assign Hierarchy</h1>
			<p class="text-gray-600 mb-4">Select the specific classes and subjects this teacher is responsible for.</p>

			<div class="input-group">
				<label for="assign-class-select">Assigned Classes (Multi-Select)</label>
				<select id="assign-class-select" multiple size="5" class="w-full p-2 border rounded-lg h-32"></select>
			</div>

			<div class="input-group">
				<label for="assign-subject-select">Assigned Subjects (Multi-Select)</label>
				<select id="assign-subject-select" multiple size="5" class="w-full p-2 border rounded-lg h-32"></select>
			</div>

			<div class="mt-8 flex justify-end gap-4">
				<button onclick="closeAssignHierarchyModal()" class="btn btn-secondary">Cancel</button>
				<button onclick="saveTeacherHierarchy()" class="btn btn-success">💾 Save Permissions</button>
			</div>
		</div>
	</div>

	<div id="page-teacher-dashboard" class="page items-center justify-center p-4">
		<main class="w-full max-w-lg mx-auto card p-8 md:p-12 text-center">
			<h1 class="text-3xl font-bold text-gray-800 mb-8">👨‍🏫 Teacher Management Portal</h1>
			<div class="grid grid-cols-1 gap-6">
				<button onclick="navigateTo('page-teacher-log-entry')" class="btn btn-primary text-lg py-4">➕ Add Weekly Teaching Log</button>
				<button onclick="loadAndDisplayTeachingLogs()" class="btn btn-secondary text-lg py-4">📂 View Saved Logs</button>
				<button onclick="navigateTo('page-teacher-log-print')" class="btn btn-secondary text-lg py-4">🖨️ Print Saved Logs</button>
				<button onclick="navigateTo('page-teacher-faculty-management')" class="btn btn-secondary text-lg py-4">🧑‍💼 Manage Faculty List</button>
			</div>
			<button onclick="navigateTo('page-2-main-dashboard')" class="btn btn-secondary mt-12 w-full">⬅️ Back to Portal</button>
		</main>
	</div>

	<div id="page-teacher-log-entry" class="page items-center p-4">
		<main class="w-full max-w-4xl mx-auto card p-8">
			<h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">📝 Weekly Subject Submission</h1>

			<div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 border-b pb-6 mb-6">
				<div class="input-group"><label for="log-teacher-select">Teacher Name</label><select id="log-teacher-select" onchange="applySubmissionFilter()"></select></div>
				<div class="input-group"><label for="log-class">Class</label><select id="log-class"></select></div>
				<div class="input-group"><label for="log-subject">Subject</label><select id="log-subject"></select></div>
			</div>

			<h2 class="text-xl font-semibold text-gray-700 mb-4">Weekly Topics Taught (7 Days):</h2>

			<div class="overflow-x-auto">
				<table class="w-full text-sm text-left text-gray-600 border border-gray-300">
					<thead class="text-xs text-gray-700 uppercase bg-gray-100">
						<tr>
							<th class="px-3 py-2 text-center w-1/12">Day</th>
							<th class="px-3 py-2 w-11/12">Topic/Chapter Covered</th>
						</tr>
					</thead>
					<tbody id="weekly-log-body">
						</tbody>
				</table>
			</div>

			<div class="mt-8 flex justify-between">
				<button onclick="navigateTo('page-teacher-dashboard')" class="btn btn-secondary">⬅️ Back to Dashboard</button>
				<button onclick="saveTeachingLog()" class="btn btn-success">💾 Save Weekly Log</button>
			</div>
		</main>
	</div>

	<div id="page-teacher-faculty-management" class="page items-center p-4 py-8">
		<main class="w-full max-w-2xl mx-auto card p-8">
			<h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">🧑‍💼 Manage Faculty Permissions</h1>

		<div class="border p-4 mb-6 rounded-lg bg-gray-50">
			<h2 class="text-xl font-bold mb-4 text-gray-700">Add New Faculty Member:</h2>
			<div class="input-group">
				<label for="new-teacher-name">Teacher's Full Name</label>
				<input type="text" id="new-teacher-name" placeholder="Enter teacher's full name">
			</div>

			<h3 class="text-md font-semibold text-gray-600 mt-4 mb-2">Hierarchies (Select to Assign):</h3>

			<div class="input-group">
				<label class="block font-medium text-gray-700">✅ Step 1: Select Classes Taught</label>
				<div id="new-teacher-classes-container" class="bg-white border rounded-lg p-2 h-32 overflow-y-auto space-y-1">
				</div>
			</div>
			
			<div id="new-teacher-class-subjects-wrapper" class="mt-6 border-t pt-4">
				<h3 class="text-md font-semibold text-gray-600 mb-3">📝 Step 2: Assign Subjects per Class (Check a class above first)</h3>
				<div id="dynamic-subject-containers" class="space-y-4">
					<p class="text-sm text-gray-500 text-center p-4">Select classes above to see subject assignments here.</p>
				</div>
			</div>
			<button onclick="addTeacherWithHierarchy()" class="btn btn-primary w-full mt-6">➕ Add Teacher & Save Permissions</button>
		</div>

			<h2 class="text-xl font-semibold text-gray-700 mb-4">Existing Faculty List:</h2>

			<div id="faculty-list-container" class="max-h-[60vh] overflow-y-auto space-y-3">
				</div>

			<div class="mt-8 flex justify-end">
				<button onclick="navigateTo('page-teacher-dashboard')" class="btn btn-secondary">⬅️ Back</button>
			</div>
		</main>
	</div>

	<div id="modal-assign-hierarchy" class="page items-center justify-center modal-backdrop hidden z-40">
			<div class="w-full max-w-lg card p-8 m-4">
				<h1 id="assign-hierarchy-title" class="text-2xl font-bold text-gray-900 mb-6">Assign Hierarchy</h1>
				<p class="text-gray-600 mb-4">Select the specific classes and subjects this teacher is responsible for.</p>

				<div class="input-group">
					<label for="assign-class-select">Assigned Classes (Multi-Select)</label>
					<select id="assign-class-select" multiple size="5" class="w-full p-2 border rounded-lg h-32"></select>
				</div>

				<div class="input-group">
					<label for="assign-subject-select">Assigned Subjects (Multi-Select)</label>
					<select id="assign-subject-select" multiple size="5" class="w-full p-2 border rounded-lg h-32"></select>
				</div>

				<div class="mt-8 flex justify-end gap-4">
					<button onclick="closeAssignHierarchyModal()" class="btn btn-secondary">Cancel</button>
					<button onclick="saveTeacherHierarchy()" class="btn btn-success">💾 Save Permissions</button>
				</div>
			</div>
		</div>



	<div id="modal-log-filter" class="page items-center justify-center modal-backdrop hidden z-40">
		<div class="w-full max-w-lg card p-8 m-4">
			<h1 class="text-2xl font-bold text-gray-900 mb-6">🔍 Filter Teaching Logs</h1>
			<div class="space-y-4">
				<div class="input-group">
					<label for="filter-teacher-select">👨‍🏫 Select Teacher</label>
					<select id="filter-teacher-select" onchange="applyLogViewFilter(true)" class="w-full p-3 border rounded-lg"></select>
				</div>
				<div class="input-group">
					<label for="filter-class-select">🎓 Select Class</label>
					<select id="filter-class-select" onchange="applyLogViewFilter(false)" disabled class="w-full p-3 border rounded-lg"></select>
				</div>
				<div class="input-group">
					<label for="filter-subject-select">📚 Select Subject</label>
					<select id="filter-subject-select" onchange="applyLogViewFilter(false)" disabled class="w-full p-3 border rounded-lg"></select>
				</div>
				<div class="input-group">
					<label for="filter-week-start">🗓️ Week Starting Date</label>
					<input type="date" id="filter-week-start" onchange="applyLogViewFilter(false)" class="w-full p-3 border rounded-lg">
					<p id="filter-week-display" class="text-sm text-gray-500 mt-1"></p>
				</div>
			</div>
			<div class="mt-8 flex justify-end gap-4">
				<button onclick="document.getElementById('modal-log-filter').classList.add('hidden')" class="btn btn-secondary">Cancel</button>
				<button id="view-logs-button" onclick="queryTeachingLogs()" class="btn btn-primary" disabled>View Logs</button>
			</div>
		</div>
	</div>

        <div id="app-message-box" class="page items-center justify-center modal-backdrop hidden z-50">
    <div class="card max-w-sm w-full p-8 text-center">
        <h3 id="app-message-title" class="text-xl font-bold text-gray-800 mb-2">Notice</h3>
        <p id="app-message-content" class="text-gray-600 mb-6 max-h-60 overflow-y-auto"></p> <button id="app-message-close-btn" class="btn btn-secondary w-1/2 mx-auto" onclick="closeSimpleModal()">Close</button> </div>
    </div>

    <div id="templates" class="hidden">
    <div id="wizard-shell-template">
        <div id="generator-container" class="card max-w-5xl mx-auto p-6 md:p-8">
            <form id="paper-form" onsubmit="return false;">
                </form>
        </div>
        <div id="paper-preview-container" class="hidden">
            <div id="preview-controls" class="max-w-4xl mx-auto my-8 p-6 bg-gray-100 border-2 border-dashed border-gray-400 rounded-xl text-center no-print">
                <h2 class="text-2xl font-bold text-slate-800">🎉 Generation Complete!</h2>
                <p class="text-slate-600 mb-6">Your test paper is ready. You can now print, edit the text directly below, or go back to the form.</p>
                <div class="flex justify-center gap-4 flex-wrap">
                    <button onclick="goBackToEdit(this)" class="btn btn-secondary">✏️ Go Back & Edit</button>
                    <button onclick="window.print()" class="btn btn-success">🖨️ Print / Save as PDF</button>
                </div>
            </div>
            <div id="final-paper-display"></div>
        </div>
    </div>
    </div>

    <div id="status-toast" class="status-toast"></div>

    <div id="print-footer" class="print-footer"></div>

<script type="module">
	
	// --- UNIFIED SUPABASE & APP STATE ---
	const SUPABASE_URL = "https://psjxahilxeagnhwjkqlt.supabase.co";
	// CORRECTED: Using the Anon Key (which starts with eyJ)
	const SUPABASE_KEY = "sb_publishable_37PP584twhFxXdKW0m0Vhg_vluSmQWH";
	const TABLES = ['students', 'results', 'attendance', 'holidays', 'classes', 'feedback_data', 'user_roles', 'teachers', 'teaching_logs', 'teacher_feedback'];
	const USER_DATA_TABLES = ['students', 'results', 'attendance', 'holidays', 'classes', 'feedback_data', 'teachers', 'teaching_logs', 'teacher_feedback'];

	const PERMANENT_ADMIN_EMAIL = 'daxingfahad8@gmail.com';


    let currentFeedbackId = null; // State for the admin modal
	// Global App State
	let supabase, currentUser = null, currentPageId = 'page-1-login';
	// ... (the rest of your script continues from here)
    let localStudentsCache = [];
    let currentUserRole = 'viewer'; // NEW: State for user role
    let allUsersCache = []; // NEW: Cache for org management users
	let allStudentsCache = []; // Keep one good definition
    let filteredStudents = []; // Keep one good definition

	// New helper function to calculate the starting date (Monday) of the current week
	const getWeekStartDate = () => {
		const today = new Date();
		const dayOfWeek = (today.getDay() + 6) % 7; // 0=Mon, 6=Sun
		const weekStartDate = new Date(today);
		weekStartDate.setDate(today.getDate() - dayOfWeek);
		return weekStartDate.toISOString().split('T')[0];
	};

	// Test Generator State
    let navigationHistory = ['page-2-main-dashboard']; // Start history at the dashboard
    let selectedClassInfo = { name: '', colorClass: '' };
    let selectedSubjectInfo = '';
    const createdPages = new Set();
    let currentWizardStep = 1;
    let totalWizardSteps = 0;
    let currentAdvancedStep = 1;

    // Result App State
    let studentData = {}, sessionMarks = {}, allSavedResults = [], currentBatchClass = '';
    let currentSelection = {}; // UPDATED: To hold {class, stream, group}
    let currentBatchReportData = { isLandscape: false };

    // Attendance App State
    let currentAttendanceClass = '', sheetEditMode = false;

    // Analytics App State
    let analyticsChartAvg = null;
    let analyticsChartDist = null;

    // --- Feedback System State ---
    let feedbackRefreshInterval = null;
    let loadedFeedbackData = [];

    // DOM Element Cache
    let authForm, userProfile, authStatus, proceedBtn;

// --- SUBJECT & GRADING CONFIG ---
    const classSubjects = {
        '8th': [{ name: 'English', total: 100 }, { name: 'Urdu', total: 100 }, { name: 'Math', total: 100 }, { name: 'General Science', total: 100 }, { name: 'Social Studies', total: 75 }, { name: 'Islamiat', total: 75 }, { name: 'Tarjama Tul Quran', total: 50 }],
        '9th': [{ name: 'English', total: 100 }, { name: 'Urdu', total: 100 }, { name: 'Math', total: 100 }, { name: 'Physics / General Science', total: 100 }, { name: 'Chemistry / Advanced Islamiat', total: 100 }, { name: 'Biology / Computer / Punjabi', total: 100 }, { name: 'Islamiat / Pakistan Studies', total: 75 }, { name: 'Tarjama Tul Quran', total: 50 }],
        '10th': [{ name: 'English', total: 100 }, { name: 'Urdu', total: 100 }, { name: 'Math', total: 100 }, { name: 'Physics / General Science', total: 100 }, { name: 'Chemistry / Advanced Islamiat', total: 100 }, { name: 'Biology / Computer / Punjabi', total: 100 }, { name: 'Islamiat / Pakistan Studies', total: 75 }, { name: 'Tarjama Tul Quran', total: 50 }],
        '11th': [{ name: 'English', total: 100 }, { name: 'Urdu', total: 100 }, { name: 'Islamiat / Ethics', total: 50 }, { name: 'Math (for Pre-Engg / ICS / I.Com)', total: 100 }, { name: 'Physics / General Science', total: 100 }, { name: 'Biology / Computer / Economics', total: 100 }, { name: 'Chemistry / Principles of Accounting / Civics', total: 100 }, { name: 'Electives (Punjabi / Education / etc.)', total: 100 }, { name: 'Tarjama Tul Quran', total: 50 }],
        '12th': [{ name: 'English', total: 100 }, { name: 'Urdu', total: 100 }, { name: 'Pakistan Studies', total: 50 }, { name: 'Math (for Pre-Engg / ICS / I.Com)', total: 100 }, { name: 'Physics / General Science', total: 100 }, { name: 'Biology / Computer / Economics', total: 100 }, { name: 'Chemistry / Principles of Accounting / Civics', total: 100 }, { name: 'Electives (Punjabi / Education / etc.)', total: 100 }, { name: 'Tarjama Tul Quran', total: 50 }],
    };

    const registrationData = {
        "classes": {
            "9th": {
                "Science": { "subgroups": { "Biology Group": ["English", "Urdu", "Islamiat", "Physics", "Chemistry", "Biology", "Mathematics", "Tarjama Tul Quran"], "Computer Group": ["English", "Urdu", "Islamiat", "Physics", "Chemistry", "Computer Science", "Mathematics", "Tarjama Tul Quran"] } },
                "Arts": { "subgroups": { "General Arts": ["English", "Urdu", "Islamiat", "Civics", "Education", "General Science", "General Mathematics", "Tarjama Tul Quran"] } }
            },
            "10th": {
                "Science": { "subgroups": { "Biology Group": ["English", "Urdu", "Pakistan Studies", "Physics", "Chemistry", "Biology", "Mathematics", "Tarjama Tul Quran"], "Computer Group": ["English", "Urdu", "Pakistan Studies", "Physics", "Chemistry", "Computer Science", "Mathematics", "Tarjama Tul Quran"] } },
                "Arts": { "subgroups": { "General Arts": ["English", "Urdu", "Pakistan Studies", "Civics", "Education", "General Science", "General Mathematics", "Tarjama Tul Quran"] } }
            },
            "11th": {
                "F.Sc": { "subgroups": { "Pre-Medical": ["English", "Urdu", "Islamiat", "Physics", "Chemistry", "Biology", "Tarjama Tul Quran"], "Pre-Engineering": ["English", "Urdu", "Islamiat", "Physics", "Chemistry", "Mathematics", "Tarjama Tul Quran"] } },
                "ICS": { "subgroups": { "Physics Group": ["English", "Urdu", "Islamiat", "Physics", "Mathematics", "Computer Science", "Tarjama Tul Quran"], "Statistics Group": ["English", "Urdu", "Islamiat", "Statistics", "Mathematics", "Computer Science", "Tarjama Tul Quran"] } },
                "I.Com": { "subgroups": { "Commerce": ["English", "Urdu", "Islamiat", "Principles of Accounting", "Principles of Economics", "Business Mathematics", "Principles of Commerce", "Tarjama Tul Quran"] } },
                "F.A": { "subgroups": { "Humanities": ["English", "Urdu", "Islamiat", "Civics", "Education", "Islamic Studies Elective", "Psychology", "Tarjama Tul Quran"] } }
            },
            "12th": {
                "F.Sc": { "subgroups": { "Pre-Medical": ["English", "Urdu", "Pakistan Studies", "Physics", "Chemistry", "Biology", "Tarjama Tul Quran"], "Pre-Engineering": ["English", "Urdu", "Pakistan Studies", "Physics", "Chemistry", "Mathematics", "Tarjama Tul Quran"] } },
                "ICS": { "subgroups": { "Physics Group": ["English", "Urdu", "Pakistan Studies", "Physics", "Mathematics", "Computer Science", "Tarjama Tul Quran"], "Statistics Group": ["English", "Urdu", "Pakistan Studies", "Statistics", "Mathematics", "Computer Science", "Tarjama Tul Quran"] } },
                "I.Com": { "subgroups": { "Commerce": ["English", "Urdu", "Pakistan Studies", "Principles of Accounting", "Principles of Banking", "Business Statistics", "Commercial Geography", "Tarjama Tul Quran"] } },
                "F.A": { "subgroups": { "Humanities": ["English", "Urdu", "Pakistan Studies", "Civics", "Education", "Psychology", "Fine Arts", "Tarjama Tul Quran"] } }
            }
        }
    };

    const gradingScale = [{ percentage: 90, grade: 'A+', remarks: "Exceptional" }, { percentage: 80, grade: 'A', remarks: "Excellent" }, { percentage: 70, grade: 'B', remarks: "Very Good" }, { percentage: 60, grade: 'C', remarks: "Good" }, { percentage: 50, grade: 'D', remarks: "Fair" }, { percentage: 40, grade: 'E', remarks: "Satisfactory (Pass)" }, { percentage: 0, grade: 'F', remarks: "Fail" }];

	// Add this code block to your main script

	document.addEventListener('visibilitychange', () => {
		// This checks if the user has returned to this browser tab
		if (document.visibilityState === 'visible') {
			
			// We only want to refresh the data if the user is on the correct page
			if (currentPageId === 'page-teacher-feedback') {
				console.log("Tab became visible, refreshing feedback...");
				showToast("🔄 Syncing feedback...", "info");
				loadTeacherFeedback();
			}
			// You could add more 'if' statements here for other pages in the future
			// if (currentPageId === 'some-other-page') {
			//     loadSomeOtherData();
			// }
		}
	});

    // --- INITIALIZATION & AUTHENTICATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        authForm = document.getElementById('auth-form');
        userProfile = document.getElementById('user-profile');
        authStatus = document.getElementById('auth-status');
        proceedBtn = document.getElementById('proceed-btn');

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const { data } = await supabase.auth.getSession();
            if (data.session) {
                updateAuthUI(data.session.user);
            }
            supabase.auth.onAuthStateChange((_event, session) => updateAuthUI(session?.user));
        } catch (e) {
            console.error("Supabase init error:", e);
            showToast("Backend connection failed. Check your URL and Key.", "error");
        }
    });

    const updateAuthUI = async (user) => {
        if (user) {
            currentUser = user;

            // --- ROLE DETECTION LOGIC ---
            // The get_user_role() function in Supabase now handles this logic securely.
            const { data, error } = await supabase.rpc('get_user_role', { user_id: user.id });

            if (error || !data) {
                console.warn("Could not fetch user role, defaulting to 'viewer'.", error);
                currentUserRole = 'viewer';
            } else {
                currentUserRole = data; // Will be 'admin', 'editor', or 'viewer'
            }

            // --- Original UI Logic ---
            if (currentPageId === 'page-1-login') {
                authForm.classList.add('hidden');
                userProfile.classList.remove('hidden');
                document.getElementById('user-name').textContent = `Welcome, ${user.email} [${currentUserRole.toUpperCase()}]`; // Optional: Show role
                proceedBtn.disabled = false;
            } else if (currentPageId === 'page-data-settings') {
                document.getElementById('user-email-display').textContent = `Signed in as: ${user.email}`;
            }

            // Apply UI restrictions AFTER role has been determined
            applyRoleBasedUI();

			// REPLACEMENT CODE BLOCK (Includes the UI fix and is syntactically sound)
			} else { // Logged out state logic
				currentUser = null;
				currentUserRole = 'viewer'; // Default for logged-out state

				// --- UI Overrides (Enabled regardless of RBAC default) ---
				const emailInput = document.getElementById('auth-email');
				const passwordInput = document.getElementById('auth-password');
				const loginBtn = document.querySelector('#auth-form button[onclick="signInWithEmail()"]');
				const signupBtn = document.querySelector('#auth-form button[onclick="signUpWithEmail()"]');

				if (emailInput) emailInput.disabled = false;
				if (passwordInput) passwordInput.disabled = false;
				if (loginBtn) { loginBtn.disabled = false; loginBtn.style.opacity = '1'; loginBtn.style.cursor = 'pointer'; }
				if (signupBtn) { signupBtn.disabled = false; signupBtn.style.opacity = '1'; signupBtn.style.cursor = 'pointer'; }

				// --- Navigation/Visibility Logic ---
				if (document.getElementById('auth-form')) {
					authForm.classList.remove('hidden');
					userProfile.classList.add('hidden');
				}
				navigateTo('page-1-login');
			}
	    }; // <-- This closes the entire updateAuthUI function

    window.copyFeedbackLink = () => {
        // Selects the input field containing the hardcoded link.
        const linkInput = document.querySelector('.input-group input[value*="bit.ly"]');

        // 1. Select the text inside the input field.
        linkInput.select();
        linkInput.setSelectionRange(0, 99999); // For mobile device compatibility

        // 2. Use the modern Clipboard API to copy the text.
        try {
            navigator.clipboard.writeText(linkInput.value);
            showToast("✅ Link Copied: " + linkInput.value, "success");
        } catch (err) {
            // Fallback for older browsers.
            document.execCommand('copy');
            showToast("Link copied via fallback method!", "info");
        }
    };

    window.signInWithEmail = async () => {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        if (!email || !password) return authStatus.textContent = "Email and password are required.";
        authStatus.textContent = "Connecting...";
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            authStatus.textContent = error.message;
            if (error.message.toLowerCase().includes('failed to fetch')) {
                authStatus.textContent = "Login failed. Please check your Supabase URL and Key in the code.";
            }
        }
        else {
            authStatus.textContent = "";
            navigateTo('page-2-main-dashboard');
        }
    };

	// ADD THIS NEW, CORRECT FUNCTION
	window.orgMgmt_createNewUser = async () => {
		const email = document.getElementById('invite-email').value;
		const password = document.getElementById('invite-password').value;
		const role = document.getElementById('invite-role').value;

		if (!email || !password || !role) {
			return showToast("Email, password, and role are required.", "error");
		}
		if (password.length < 6) {
			return showToast("Password must be at least 6 characters.", "error");
		}

		showToast(`Creating account for ${email}...`, 'info');

		try {
			// Step 1: Use the PUBLIC signUp function. This is allowed from the browser.
			// Because you turned off "Confirm email" in Supabase, this user will be active immediately.
			const { data: userData, error: userError } = await supabase.auth.signUp({
				email: email,
				password: password 
			});

			if (userError) throw userError;
			
			const newUser = userData.user;
			if (!newUser) throw new Error("User was created but could not be found.");

			// Step 2: Now, use YOUR ADMIN permissions to insert the new user's role.
			// Your RLS policy will check if YOU are an admin and allow this.
			const { error: roleError } = await supabase.from('user_roles').insert({
				user_id: newUser.id,
				email: email,
				role: role
			});

			if (roleError) {
				// This error means your RLS policy is not set up correctly.
				throw new Error("User created, but role could not be set. Check RLS policies.");
			}

			showToast(`Account created for ${email} with role: ${role}.`, 'success');
			navigateTo('page-organization-management');
			orgMgmt_initializePage(); // Refresh the user list

		} catch (error) {
			console.error("Error creating user:", error);
			showToast(`Failed to create user: ${error.message}`, "error");
		}
	};

    window.signOutUser = async () => {
        await supabase.auth.signOut();
    };

	// ADD THIS NEW, REUSABLE FUNCTION TO YOUR SCRIPT

	async function downloadReportAsPDF(elementId, filename = 'report.pdf') {
		const displayArea = document.getElementById(elementId);
		if (!displayArea) {
			console.error(`PDF Error: Element with ID "${elementId}" not found.`);
			return showToast("Failed to generate PDF: Element not found.", "error");
		}

		showToast('Creating PDF... Please wait.', 'info');

		try {
			// 1. Initialize jsPDF
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({
				orientation: 'p', // portrait
				unit: 'mm',
				format: 'a4'
			});

			// 2. Use html2canvas to "photograph" your report
			const canvas = await html2canvas(displayArea, {
				scale: 2, // Higher scale for better quality
				useCORS: true
			});

			// 3. Add the "photograph" to the PDF
			const imgData = canvas.toDataURL('image/png');
			const imgProps = doc.getImageProperties(imgData);
			const pdfWidth = doc.internal.pageSize.getWidth() - 20; // 10mm margin on each side
			const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
			let heightLeft = pdfHeight;
			let position = 10; // 10mm top margin

			doc.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
			heightLeft -= (doc.internal.pageSize.getHeight() - 20);

			// 4. Add new pages if the content is too long
			while (heightLeft > 0) {
				position = heightLeft - pdfHeight - 10; // 10mm margin
				doc.addPage();
				doc.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
				heightLeft -= doc.internal.pageSize.getHeight();
			}

			// 5. Trigger the download
			doc.save(filename);
			
			showToast('🚀 PDF download started!', 'success');

		} catch (e) {
			console.error("Error generating PDF:", e);
			showToast("Failed to generate PDF.", "error");
		}
	}

    // --- UNIFIED NAVIGATION ---
    // RECOMMENDED: This version fixes the local file login issue while keeping security for logged-in users.
	const applyRoleBasedUI = () => {
		// If no one is logged in (e.g., on the login page or when connection fails locally)
		if (!currentUser) {
			// Specifically enable ONLY the login form elements
			const emailInput = document.getElementById('auth-email');
			const passwordInput = document.getElementById('auth-password');
			const loginBtn = document.querySelector('#auth-form button[onclick="signInWithEmail()"]');
			const signupBtn = document.querySelector('#auth-form button[onclick="signUpWithEmail()"]');

			if (emailInput) emailInput.disabled = false;
			if (passwordInput) passwordInput.disabled = false;
			if (loginBtn) { loginBtn.disabled = false; loginBtn.style.opacity = '1'; loginBtn.style.cursor = 'pointer'; }
			if (signupBtn) { signupBtn.disabled = false; signupBtn.style.opacity = '1'; signupBtn.style.cursor = 'pointer'; }
			
			// Stop the function here so the rest of the lockdown doesn't happen
			return;
		}

		// --- If a user IS logged in, proceed with the original security lockdown ---
		
		// --- Define Targets ---
		const allInputs = document.querySelectorAll('input, textarea, select');
		const addSaveButtons = document.querySelectorAll('.btn-success, button[onclick*="save"], button[onclick*="add"], button[onclick*="submit"]');
		const deleteButtons = document.querySelectorAll('.btn-danger, button[onclick*="delete"]');
		const orgMgmtBtn = document.getElementById('org-management-btn');

		// --- Reset All to a Default Restricted State ---
		allInputs.forEach(el => el.disabled = true);
		addSaveButtons.forEach(btn => { btn.disabled = true; btn.style.opacity = '0.6'; btn.style.cursor = 'not-allowed'; });
		deleteButtons.forEach(btn => { btn.disabled = true; btn.style.opacity = '0.6'; btn.style.cursor = 'not-allowed'; });
		if (orgMgmtBtn) orgMgmtBtn.classList.add('hidden');

		// --- Apply Permissions Based on Role ---
		if (currentUserRole === 'viewer') {
			// Viewers can use filter dropdowns and navigation
			document.querySelectorAll('#class-filter, #batch-report-class-select, #batch-report-stream-select, #batch-report-group-select, #batch-report-term-select, #analytics-class-select, #analytics-stream-select, #analytics-group-select, #analytics-term-select, #feedback-class-filter, #feedback-subject-filter, #filter-teacher-select, #filter-class-select, #filter-subject-select, #filter-week-start').forEach(el => el.disabled = false);
		} else if (currentUserRole === 'editor') {
			// Editors can input data and save/add.
			allInputs.forEach(el => el.disabled = false);
			addSaveButtons.forEach(btn => { btn.disabled = false; btn.style.opacity = '1'; btn.style.cursor = 'pointer'; });
		} else if (currentUserRole === 'admin') {
			// Admins can do everything.
			allInputs.forEach(el => el.disabled = false);
			addSaveButtons.forEach(btn => { btn.disabled = false; btn.style.opacity = '1'; btn.style.cursor = 'pointer'; });
			deleteButtons.forEach(btn => { btn.disabled = false; btn.style.opacity = '1'; btn.style.cursor = 'pointer'; });
			if (orgMgmtBtn) orgMgmtBtn.classList.remove('hidden');
		}
	};

    // NEW navigateTo function with improved restriction handling
    window.navigateTo = (pageId) => {
        const currentPageElement = document.getElementById(currentPageId);
        const nextPageElement = document.getElementById(pageId);

        if (!nextPageElement) {
            console.error(`Attempted to navigate to unknown page ID: ${pageId}`);
            return showToast(`Error: Page/Modal '${pageId}' not found.`, 'error');
        }

        // 1. Hide the current page without waiting for animation to prevent the white screen gap.
        if (currentPageElement && currentPageId !== pageId) {
            currentPageElement.classList.remove('active', 'exiting', 'hidden'); // Remove all states first
            currentPageElement.classList.add('hidden'); // Then hide it
        }

        // 2. Activate new page/modal using animation classes.
        nextPageElement.classList.remove('hidden'); // Ensure hidden is removed instantly
        nextPageElement.classList.add('active'); // Trigger animation (fade in)

        currentPageId = pageId;
        window.scrollTo(0, 0);

	    // 3. Run initializations based on the new page ID.
		if (pageId === 'page-data-settings' && currentUser) { updateStorageInfo(); }
		if (pageId === 'page-results-class-select') { populateClassSelect('manual-entry-class-select', false); }
		if (pageId === 'page-results-class-select-batch') { populateClassSelect('batch-entry-class-select', true); }
		if (pageId === 'page-results-batch-report-generator') { initializeBatchReportGenerator(); }
		if (pageId === 'page-analytics-dashboard') { initializeAnalyticsDashboard(); }
		if (pageId === 'page-feedback-system') { initializeFeedbackSystem(); }
		if (pageId === 'page-student-registration') { initializeStudentRegistration(); }
        // ... (around line 1517)
        // ...
		if (pageId === 'page-organization-management') { orgMgmt_initializePage(); }
		
		// 👇 FIX: INSERT CALL FOR TERM REPORT INITIALIZATION HERE 👇
		if (pageId === 'page-student-term-report') { termReport_initialize(); } 
		
		if (pageId === 'page-student-management') { initializeStudentManagement(); } 
		// 👆 END OF INSERT 👆
		
		if (pageId === 'page-teacher-log-print') { initializePrintLogPage(); }
		
		if (pageId === 'page-teacher-log-entry' || pageId === 'page-teacher-faculty-management' || pageId === 'page-teacher-dashboard' || pageId === 'modal-log-filter' || pageId === 'modal-assign-hierarchy') {
        // ...
			initializeTeacherDashboard();
		}

		applyRoleBasedUI();
	};

    // --- HELPER & UTILITY FUNCTIONS ---
    window.showToast = (message, type = 'success') => {
        const toast = document.getElementById('status-toast');
        if (!toast) return;
        toast.textContent = message;
        toast.style.backgroundColor = type === 'error' ? '#be123c' : (type === 'info' ? '#3b82f6' : '#1a202c');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    };

    // *** NEW ***: Function to show the generic message box as a modal
    window.showSimpleModal = (title, htmlContent) => {
        document.getElementById('app-message-title').textContent = title;
        document.getElementById('app-message-content').innerHTML = htmlContent;
        // Use navigateTo to show the modal properly with transitions
        window.navigateTo('app-message-box');
    };

    // *** NEW ***: Function to close the generic message box
    window.closeSimpleModal = () => {
        // Navigate back to the previous main page (assuming it's the dashboard for safety)
        // You might need more sophisticated history tracking if modals can appear over other modals
        window.navigateTo('page-2-main-dashboard'); // Or maybe the page where the modal was opened from?
    };

    // *** NEW ***: Function to display fetched logs in the modal
    window.displayLogsInModal = (logs) => {
        const title = `Teaching Logs Found: ${logs.length}`;
        let content = '<div class="text-left space-y-4">'; // Start of content container

        if (logs.length === 0) {
            content += '<p class="text-gray-500">No logs match the selected criteria.</p>';
        } else {
            logs.forEach(log => {
                const weekStart = new Date(log.week_start_date).toLocaleDateString('en-GB');
                content += `
					<div class="p-3 border rounded-lg bg-gray-50">
						<p class="font-semibold text-sm">${log.teacher_name} - ${log.class_name} - ${log.subject_name}</p>
						<p class="text-xs text-gray-500 mb-2">Week Starting: ${weekStart}</p>
						<ul class="list-disc list-inside text-xs space-y-1">
				`;
                // Display topics, filtering out empty ones
                daysOfWeek.forEach(day => {
                    if (log.weekly_topics[day]) {
                        content += `<li><strong>${day}:</strong> ${log.weekly_topics[day]}</li>`;
                    }
                });
                content += `</ul></div>`;
            });
        }
        content += '</div>'; // End of content container
        showSimpleModal(title, content);
    };

    window.triggerPrint = (pageId, isLandscape = false) => {
        const pageToPrint = document.getElementById(pageId);
        if (!pageToPrint) return;

        // Create a temporary style for the printed page with A4 size and margins
        let style = document.createElement('style');
        style.id = 'print-style-override';
        style.innerHTML = `@page { size: A4 ${isLandscape ? 'landscape' : 'portrait'}; margin: 0.5in; }`;
        document.head.appendChild(style);

        const footer = document.getElementById('print-footer');
        if (footer) {
            footer.textContent = `Generated on: ${new Date().toLocaleString()}`;
        }

        // Add a 'printing' class to the page element, which is used by the CSS
        pageToPrint.classList.add('printing');

        // Call the browser's native print dialog
        window.print();

        // Clean up after printing by removing the class and the style
        setTimeout(() => {
            pageToPrint.classList.remove('printing');
            if (document.head.contains(style)) {
                document.head.removeChild(style);
            }
        }, 500); // A 500ms delay ensures cleanup happens after the print dialog closes
    };


	// --- TEACHER FEEDBACK FUNCTIONS ---

	/**
	 * Submits the anonymous feedback to the database.
	 */
	window.submitAnonymousFeedback = async () => {
		if (!currentUser) return showToast("You must be logged in to submit feedback.", "error");

		const feedbackText = document.getElementById('suggestion-area').value.trim();
		if (feedbackText.length < 10) return showToast("Feedback must be at least 10 characters.", "error");

		showToast("Submitting feedback anonymously...", 'info');

		const { error } = await supabase.from('teacher_feedback').insert({
			user_id: currentUser.id,
			feedback_text: feedbackText,
			admin_status: 'new' // Always starts as 'new'
		});

		if (error) {
			console.error("Feedback submission error:", error);
			return showToast("Failed to submit feedback.", "error");
		}

		document.getElementById('suggestion-area').value = '';
		showToast("✅ Suggestion submitted. Thank you for your input!", "success");
		// Reload admin panel if on the page
		if (currentPageId === 'page-teacher-feedback') loadTeacherFeedback(); 
	};

	/**
	* Loads and displays the feedback list in the Admin Panel.
	* Also updates the notification badge.
	*/
	// --- REPLACE THE ENTIRE window.loadTeacherFeedback FUNCTION (Starts around line 1707) ---
	window.loadTeacherFeedback = async () => {
		const isAdminView = (currentUserRole === 'admin' || currentUserRole === 'editor');
		const panel = document.getElementById('teacher-feedback-admin-panel');
		const badge = document.getElementById('feedback-notification-badge');
		const listContainer = document.getElementById('admin-feedback-list');
		const dashboardCardSubtitle = document.querySelector('#page-2-main-dashboard button[onclick*="page-teacher-feedback"] p.text-sm');


		if (!isAdminView) {
			panel.classList.add('hidden');
			badge.classList.add('hidden');
			if (dashboardCardSubtitle) dashboardCardSubtitle.textContent = "Submit and review anonymous feedback.";
			return;
		}

		panel.classList.remove('hidden');
		listContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Fetching suggestions...</p>';

		// Admin/Editor logic: fetch all feedback
		const { data: allFeedback, error } = await supabase.from('teacher_feedback')
			.select('*')
			.order('submission_date', { ascending: false });

		if (error) {
			console.error("Error fetching admin feedback:", error);
			listContainer.innerHTML = '<p class="text-center text-red-500 p-4">Error loading data.</p>';
			return;
		}
		
		// --- CALCULATE METRICS ---
		const newCount = allFeedback.filter(f => f.admin_status === 'new').length;
		const resolvedCount = allFeedback.filter(f => f.admin_status === 'resolved').length;
		const heardCount = allFeedback.filter(f => f.admin_status === 'heard').length;
		const totalPending = newCount + heardCount; 

		// Update the dashboard badge and heading
		badge.textContent = totalPending;
		badge.classList.toggle('hidden', totalPending === 0);
		document.getElementById('admin-panel-heading').textContent = `New: ${newCount} | Heard: ${heardCount} | Resolved: ${resolvedCount}`;
		if (dashboardCardSubtitle) {
			dashboardCardSubtitle.textContent = `New (${newCount}), Pending (${heardCount}), Resolved (${resolvedCount})`;
		}


		if (allFeedback.length === 0) {
			listContainer.innerHTML = '<p class="text-center text-gray-500 p-4">No suggestions have been submitted yet.</p>';
			return;
		}

		listContainer.innerHTML = allFeedback.map(f => {
			const statusClass = f.admin_status === 'new' ? 'border-red-500' : (f.admin_status === 'heard' ? 'border-yellow-500' : 'border-green-500');
			const statusText = f.admin_status.charAt(0).toUpperCase() + f.admin_status.slice(1);
			const commentPreview = f.admin_comment ? `<p class="text-xs text-gray-400 mt-2">Admin: ${f.admin_comment.substring(0, 50)}...</p>` : '';
			const date = new Date(f.submission_date).toLocaleDateString('en-GB');
			
			// Conditional Delete Button (Only visible if status is 'resolved' AND user is admin/editor)
			const deleteButton = (f.admin_status === 'resolved' && (currentUserRole === 'admin' || currentUserRole === 'editor')) 
				? `<button onclick="deleteTeacherFeedback(${f.id}, '${f.admin_status}')" class="btn btn-danger !p-1 text-xs mt-2 ml-2">🗑️ Delete</button>` 
				: '';

			return `
				<div class="p-3 border-l-4 ${statusClass} bg-gray-50 rounded-lg">
					<div class="flex justify-between items-center">
						<p class="font-bold text-sm text-gray-700">Status: <span class="uppercase text-xs font-extrabold">${statusText}</span></p>
						<p class="text-xs text-gray-500">${date}</p>
					</div>
					<p class="mt-2 text-gray-600 text-sm">${f.feedback_text.substring(0, 100)}...</p>
					${commentPreview}
					<button onclick="openAdminCommentModal(${f.id}, '${btoa(f.feedback_text)}', '${btoa(f.admin_comment || '')}')" class="btn btn-secondary !p-1 text-xs mt-2">
						Review / Comment
					</button>
					${deleteButton}
				</div>
			`;
		}).join('');
	};

	/**
	 * Opens the modal for the admin/editor to review and comment on feedback.
	 */
	window.openAdminCommentModal = (id, encodedFeedback, encodedComment) => {
		if (currentUserRole !== 'admin' && currentUserRole !== 'editor') return showToast("Access denied.", "error");

		currentFeedbackId = id;
		const feedbackText = atob(encodedFeedback);
		const existingComment = atob(encodedComment);

		document.getElementById('modal-feedback-content').textContent = feedbackText;
		document.getElementById('admin-comment-area').value = existingComment;

		window.navigateTo('modal-admin-comment');
	};

	/**
	 * Closes the admin comment modal.
	 */
	window.closeAdminCommentModal = () => {
		currentFeedbackId = null;
		document.getElementById('admin-comment-area').value = '';
		window.navigateTo('page-teacher-feedback');
	};

	/**
	 * Saves the admin's comment and updates the status.
	 */
	window.saveAdminComment = async (newStatus) => {
		if (!currentFeedbackId) return showToast("Error: No feedback selected.", "error");

		const comment = document.getElementById('admin-comment-area').value.trim();
		if (!comment) return showToast("Admin comment is required.", "error");

		showToast(`Marking as '${newStatus}' and saving comment...`, 'info');

		const { error } = await supabase.from('teacher_feedback')
			.update({ 
				admin_status: newStatus,
				admin_comment: comment,
				admin_comment_by: currentUser.id
			})
			.eq('id', currentFeedbackId);

		if (error) {
			console.error("Error saving admin comment:", error);
			return showToast("Failed to save admin comment.", "error");
		}

		showToast("Comment saved and status updated!", "success");
		closeAdminCommentModal();
		loadTeacherFeedback(); 
	};

	// --- NEW FUNCTION: Delete Teacher Feedback ---
	window.deleteTeacherFeedback = async (id, status) => {
		// 1. Enforce Role & Status Constraint
		if (currentUserRole !== 'admin' && currentUserRole !== 'editor') {
			return showToast("Access denied.", "error");
		}
		if (status !== 'resolved') {
			return showToast("🚫 Only 'Resolved' suggestions can be permanently deleted.", "error");
		}

		if (!confirm("Are you sure you want to permanently delete this RESOLVED suggestion?")) {
			return;
		}

		showToast("Deleting resolved suggestion...", 'info');

		// 2. Perform Deletion
		const { error } = await supabase.from('teacher_feedback').delete().eq('id', id);

		if (error) {
			console.error("Deletion error:", error);
			return showToast("Failed to delete suggestion.", "error");
		}

		showToast("Resolved suggestion deleted.", "success");
		loadTeacherFeedback(); // Refresh the list
	};

	// --- Badge Initialization on Load (runs once) ---

	document.addEventListener('DOMContentLoaded', () => {
		// Check if the current user is an admin/editor and update the badge
		if (currentUserRole === 'admin' || currentUserRole === 'editor') {
			const checkBadge = async () => {
				 const { count: newCount } = await supabase.from('teacher_feedback')
					.select('id', { count: 'exact', head: true })
					.eq('admin_status', 'new');
				
				const badge = document.getElementById('feedback-notification-badge');
				if (badge) {
					badge.textContent = newCount;
					badge.classList.toggle('hidden', newCount === 0);
				}
			};
			// Initial check and set an interval for live updates
			checkBadge();
			setInterval(checkBadge, 60000); // Check every 60 seconds
		}
	});

	// Update the navigation handler for the new page
	// You need to add this to the navigation logic, either by adding a new case 
	// or ensuring the existing logic handles 'page-teacher-feedback'.
	// (The navigateTo function in the provided code is already generalized, 
	// but ensure loadTeacherFeedback() runs when the page is entered)

	const originalNavigateTo = window.navigateTo; // Assuming the provided JS has a window.navigateTo
	window.navigateTo = (pageId) => {
		originalNavigateTo(pageId); // Call the original function

		if (pageId === 'page-teacher-feedback') {
			loadTeacherFeedback();
		}
	};

	// --- STUDENT TERM COMPARISON REPORT LOGIC ---
	let termReportChartOverall = null;
	let termReportSubjectCharts = {};
	
	// --- NEW HELPER: Reads values from the rendered checkbox list ---
	function getSelectedTermsFromCheckboxes() {
		return Array.from(
			document.querySelectorAll('#term-report-term-select input[type="checkbox"]:checked')
		).map(checkbox => checkbox.value);
	}

	// --- STUDENT TERM COMPARISON REPORT LOGIC ---
	window.termReport_initialize = () => {
		populateClassSelect('term-report-class-select', false);
		
		document.getElementById('term-report-stream-select').innerHTML = '<option value="">-- Select Stream --</option>';
		document.getElementById('term-report-stream-select').disabled = true;
		document.getElementById('term-report-student-select').innerHTML = '<option value="">-- Select Student --</option>';
		document.getElementById('term-report-student-select').disabled = true;
		document.getElementById('term-report-term-select').innerHTML = ''; 
		document.getElementById('term-report-term-select').setAttribute('disabled', 'true');
		
		document.getElementById('term-report-content').classList.add('hidden');
		document.getElementById('term-report-no-data').classList.remove('hidden');
	};

	window.termReport_populateStreamSelect = (className) => {
		const streamSelect = document.getElementById('term-report-stream-select');
		const studentSelect = document.getElementById('term-report-student-select');
		const termSelect = document.getElementById('term-report-term-select');

		streamSelect.innerHTML = '<option value="">-- Select Stream/Group --</option>';
		studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
		termSelect.innerHTML = '';
		studentSelect.disabled = true;
		termSelect.setAttribute('disabled', 'true');
		
		if (className && registrationData.classes[className]) {
			const streams = Object.keys(registrationData.classes[className]);
			streams.forEach(stream => {
				const subgroups = Object.keys(registrationData.classes[className][stream].subgroups);
				subgroups.forEach(group => {
					 streamSelect.innerHTML += `<option value="${stream}:::${group}">${stream} - ${group}</option>`;
				});
			});
			streamSelect.disabled = false;
		}
		window.termReport_populateStudentAndTerm(); 
	};

	window.termReport_populateStudentAndTerm = async () => {
		const classSelect = document.getElementById('term-report-class-select').value;
		const streamGroupSelect = document.getElementById('term-report-stream-select').value;
		const studentSelect = document.getElementById('term-report-student-select');
		const termSelect = document.getElementById('term-report-term-select');

		studentSelect.innerHTML = '<option value="" selected disabled>-- Loading Students... --</option>';
		termSelect.innerHTML = '';
		studentSelect.disabled = true;
		termSelect.setAttribute('disabled', 'true');
		
		if (!classSelect || !streamGroupSelect) {
			studentSelect.innerHTML = '<option value="">-- Select Stream/Group First --</option>';
			return;
		}
		
		const [stream, group] = streamGroupSelect.split(':::');
		
		// 1. Fetch Students
		const { data: students, error: studentError } = await supabase.from('students')
			.select('name, roll_no')
			.eq('user_id', currentUser.id)
			.eq('class_name', classSelect)
			.eq('class_type', stream)
			.eq('subgroup', group)
			.order('name');
			
		if (studentError) { return showToast("Error loading students.", "error"); }

		if (students && students.length > 0) {
			studentSelect.innerHTML = students.map(s => `<option value="${s.roll_no}">${s.name} (R. ${s.roll_no})</option>`).join('');
			studentSelect.insertAdjacentHTML('afterbegin', '<option value="" selected disabled>-- Select Student --</option>');
			studentSelect.disabled = false;
		} else {
			studentSelect.innerHTML = '<option value="">No Students Found</option>';
		}

		// 2. Fetch Terms (only for the selected class)
		const { data: terms, error: termsError } = await supabase.from('results')
			.select('term')
			.eq('user_id', currentUser.id)
			.eq('class_name', classSelect)
			.order('term'); 
			
		if (termsError) { return showToast("Error loading terms.", "error"); }

		const uniqueTerms = [...new Set(terms.map(t => t.term))].sort(); 

		termSelect.innerHTML = ''; // Clear previous content
		
		if (uniqueTerms.length > 0) {
			// --- NEW LOGIC: RENDER AS CHECKBOX ITEMS ---
			termSelect.innerHTML = uniqueTerms.map(t => `
				<label class="checkbox-item">
					<input type="checkbox" value="${t}">
					<span class="text-sm text-gray-700">${t}</span>
				</label>
			`).join('');
			
			termSelect.removeAttribute('disabled');
			termSelect.style.pointerEvents = 'auto';
		} else {
			termSelect.innerHTML = '<p class="text-sm text-gray-500 p-2">No results found for comparison.</p>';
			termSelect.style.pointerEvents = 'none';
		}
		
		document.getElementById('term-report-no-data').classList.remove('hidden');
		document.getElementById('term-report-content').classList.add('hidden');
	};

	window.runTermComparisonReport = async () => {
		const className = document.getElementById('term-report-class-select').value;
		const rollNo = document.getElementById('term-report-student-select').value;
		
		// --- USING THE NEW HELPER FUNCTION ---
		const selectedTerms = getSelectedTermsFromCheckboxes();
		
		const studentDisplay = document.getElementById('term-report-student-select').options[document.getElementById('term-report-student-select').selectedIndex];
		const studentName = studentDisplay ? studentDisplay.textContent : 'N/A Student';


		if (!rollNo || selectedTerms.length < 2) {
			return showToast("Please select a student and at least two terms for comparison.", "error");
		}

		showToast(`Fetching results for ${studentName} across ${selectedTerms.length} terms...`, "info");
		
		const { data: results, error } = await supabase.from('results')
			.select('term, marks_data')
			.eq('user_id', currentUser.id)
			.eq('class_name', className)
			.eq('student_roll_no', rollNo)
			.in('term', selectedTerms);

		if (error || !results || results.length < selectedTerms.length) {
			 document.getElementById('term-report-content').classList.add('hidden');
			 document.getElementById('term-report-no-data').classList.remove('hidden');
			 return showToast(`Could not find results for all selected terms. Found ${results?.length || 0}/${selectedTerms.length}.`, "error");
		}

		const processedData = processTermReportData(results, selectedTerms);

		document.getElementById('term-report-title').textContent = `Growth Report for ${studentName.split('(')[0].trim()}`;
		document.getElementById('term-report-no-data').classList.add('hidden');
		document.getElementById('term-report-content').classList.remove('hidden');
		
		renderOverallChart(processedData.overallData, selectedTerms);
		renderSubjectCharts(processedData.subjectData, selectedTerms);
		
		showToast("Report generated successfully!", "success");
	};

	function processTermReportData(results, termsOrder) {
		const overallData = {
			labels: termsOrder,
			percentages: [],
			totals: []
		};
		const subjectData = {}; 

		const resultsByTerm = new Map(results.map(r => [r.term, r.marks_data]));

		const allSubjects = new Set();
		results.forEach(r => r.marks_data.forEach(m => allSubjects.add(m.name)));
		
		const sortedSubjects = [...allSubjects].sort();

		termsOrder.forEach(term => {
			const marksData = resultsByTerm.get(term) || [];
			let totalObtained = 0;
			let totalPossible = 0;
			
			const marksMap = new Map(marksData.map(m => [m.name, m]));

			sortedSubjects.forEach(subjectName => {
				const mark = marksMap.get(subjectName);

				if (!subjectData[subjectName]) {
					subjectData[subjectName] = { percentages: [], totals: [] };
				}

				if (mark) {
					totalObtained += mark.obtained;
					totalPossible += mark.total;
					const percentage = mark.total > 0 ? (mark.obtained / mark.total) * 100 : 0;
					subjectData[subjectName].percentages.push(percentage.toFixed(1));
					subjectData[subjectName].totals.push(mark.total);
				} else {
					subjectData[subjectName].percentages.push(0); 
					subjectData[subjectName].totals.push(0);
				}
			});
			
			const overallPercentage = totalPossible > 0 ? (totalObtained / totalPossible) * 100 : 0;
			overallData.percentages.push(overallPercentage.toFixed(1));
			overallData.totals.push(totalPossible);
		});
		
		return { overallData, subjectData: subjectData };
	}


	function renderOverallChart(data, termsOrder) {
		const ctx = document.getElementById('term-report-overall-chart').getContext('2d');
		if (termReportChartOverall) termReportChartOverall.destroy();

		const percentages = data.percentages.map(p => parseFloat(p));
		const expectedGrowth = termsOrder.map((t, i) => (i === 0) ? percentages[i] : (percentages[i - 1] * 1.05).toFixed(1)); 
		
		const fallPoints = percentages.map((p, i) => {
			if (i > 0 && (percentages[i - 1] - p) > 10) {
				return { x: i, y: p, label: `Sudden Drop (${(percentages[i - 1] - p).toFixed(1)}%)` };
			}
			return null;
		}).filter(Boolean);


		termReportChartOverall = new Chart(ctx, {
			type: 'line',
			data: {
				labels: data.labels,
				datasets: [
					{
						label: 'Actual Performance (%)',
						data: percentages,
						borderColor: 'rgb(25, 135, 84)', 
						backgroundColor: 'rgba(25, 135, 84, 0.2)',
						borderWidth: 4, 
						tension: 0.4, 
						pointRadius: 8,
						pointBackgroundColor: 'rgb(25, 135, 84)',
						fill: 'start', 
						pointHoverRadius: 10
					},
					{
						label: 'Target Growth (Est. +5%)',
						data: expectedGrowth,
						borderColor: 'rgb(108, 117, 125, 0.7)', 
						backgroundColor: 'transparent',
						borderDash: [8, 4], 
						pointRadius: 0
					}
				]
			},
			options: {
				responsive: true,
				aspectRatio: 2.5, 
				scales: { 
					y: { 
						beginAtZero: true, 
						max: 100, 
						title: { display: true, text: 'Performance Percentage (%)' } 
					} 
				},
				plugins: { 
					title: { 
						display: true, 
						text: 'Overall Performance Comparison',
						font: { size: 16 }
					},
					tooltip: { 
						mode: 'index', 
						intersect: false, 
						callbacks: {
							 title: (items) => `${items[0].label} Result`,
							 label: (context) => ` ${context.dataset.label}: ${context.parsed.y}%`
						}
					},
				}
			}
		});
	}

	function renderSubjectCharts(subjectData, termsOrder) {
		const container = document.getElementById('term-report-subject-charts');
		container.innerHTML = '';
		
		Object.values(termReportSubjectCharts).forEach(chart => {
			if (chart && typeof chart.destroy === 'function') chart.destroy();
		});
		termReportSubjectCharts = {};

		Object.entries(subjectData).forEach(([subject, data]) => {
			if (data.percentages.every(p => parseFloat(p) === 0)) return; 

			// Create canvas element
			const canvasId = `subject-chart-${subject.replace(/[^a-zA-Z0-9]/g, '-')}`;
			const chartHtml = `
				<div class="chart-card">
					<h4 class="font-semibold text-base text-gray-700 mb-2">Subject: ${subject}</h4>
					<canvas id="${canvasId}"></canvas>
				</div>`;
			container.insertAdjacentHTML('beforeend', chartHtml);

			const ctx = document.getElementById(canvasId).getContext('2d');
			const percentages = data.percentages.map(p => parseFloat(p));

			const expectedGrowth = termsOrder.map((t, i) => (i === 0) ? percentages[i] : (percentages[i - 1] * 1.03).toFixed(1)); 

			termReportSubjectCharts[subject] = new Chart(ctx, {
				type: 'line',
				data: {
					labels: termsOrder,
					datasets: [
						{
							label: 'Actual Subject %',
							data: percentages,
							borderColor: 'rgb(220, 53, 69)', 
							backgroundColor: 'rgba(220, 53, 69, 0.1)',
							borderWidth: 2,
							tension: 0.3,
							pointRadius: 5,
							pointBackgroundColor: 'rgb(220, 53, 69)',
							fill: false
						},
						 {
							label: 'Expected Subject Growth',
							data: expectedGrowth,
							borderColor: 'rgba(100, 100, 100, 0.5)',
							backgroundColor: 'transparent',
							borderDash: [3, 3],
							pointRadius: 0
						}
					]
				},
				options: {
					responsive: true,
					aspectRatio: 1.5, 
					scales: { 
						y: { 
							beginAtZero: true, 
							max: 100,
							title: { display: false }
						} 
					},
					plugins: { 
						legend: { display: false },
						tooltip: {
							 callbacks: {
								label: (context) => ` Score: ${context.parsed.y}%`
							 }
						}
					}
				}
			});
		});
	}

    /**************************************************************************/
    /* RESULTS APP LOGIC (UPDATED WITH HIERARCHY)                             */
    /**************************************************************************/

    window.populateClassSelect = (selectId, includeAll) => {
        const classSelect = document.getElementById(selectId);
        classSelect.innerHTML = '<option value="">-- Select a Class --</option>';
        Object.keys(registrationData.classes).forEach(className => {
            classSelect.innerHTML += `<option value="${className}">${className}</option>`;
        });
        if (includeAll) {
            classSelect.innerHTML += `<option value="all">All Registered Classes</option>`;
        }
    };

    window.populateStreamSelect = (classSelectId, streamSelectId, groupSelectId, includeAll, callback) => {
        const className = document.getElementById(classSelectId).value;
        const streamSelect = document.getElementById(streamSelectId);
        const groupSelect = document.getElementById(groupSelectId);

        streamSelect.innerHTML = '<option value="">-- Select Stream --</option>';
        groupSelect.innerHTML = '<option value="">-- Select Group --</option>';
        streamSelect.disabled = true;
        groupSelect.disabled = true;

        if (className && registrationData.classes[className]) {
            const streams = Object.keys(registrationData.classes[className]);
            if (includeAll) {
                streamSelect.innerHTML += '<option value="all">All Streams</option>';
            }
            streams.forEach(stream => {
                streamSelect.innerHTML += `<option value="${stream}">${stream}</option>`;
            });
            streamSelect.disabled = false;
        }
        if (callback) callback();
    };

    window.populateGroupSelect = (classSelectId, streamSelectId, groupSelectId, includeAll, callback) => {
        const className = document.getElementById(classSelectId).value;
        const streamName = document.getElementById(streamSelectId).value;
        const groupSelect = document.getElementById(groupSelectId);

        groupSelect.innerHTML = '<option value="">-- Select Group --</option>';
        groupSelect.disabled = true;

        // --- FIX IS HERE ---
        // If 'All Streams' is selected, force 'All Groups' and proceed
        if (streamName === 'all') {
            groupSelect.innerHTML = '<option value="all" selected>All Groups</option>';
            groupSelect.disabled = true; // Keep it disabled as it's auto-selected
            if (callback) callback();
            return; // Stop here
        }
        // --- END FIX ---

        if (className && streamName && registrationData.classes[className]?.[streamName]) {
            const subgroups = Object.keys(registrationData.classes[className][streamName].subgroups);
            if (includeAll) {
                groupSelect.innerHTML += '<option value="all">All Groups</option>';
            }
            subgroups.forEach(group => {
                groupSelect.innerHTML += `<option value="${group}">${group}</option>`;
            });
            groupSelect.disabled = false;
        }
        if (callback) callback();
    };

    window.startManualEntry = () => {
        const className = document.getElementById('manual-entry-class-select').value;
        const stream = document.getElementById('manual-entry-stream-select').value;
        const group = document.getElementById('manual-entry-group-select').value;

        if (!className || !stream || !group) {
            return showToast("Please select a class, stream, and group.", "error");
        }

        currentSelection = { class: className, stream, group };
        resetEntryForm();
        studentData = { className }; // Re-initialize studentData with className
        document.getElementById('entry-heading').textContent = `Enter Details for ${group}`;

        const subjects = registrationData.classes[className]?.[stream]?.subgroups?.[group] || [];
        const container = document.getElementById('marks-entry-container');
        container.innerHTML = subjects.map(subjectName => {
            const defaultTotal = (classSubjects[className]?.find(s => s.name.startsWith(subjectName.split(' ')[0]))?.total) || 100;
            const subjectId = subjectName.replace(/[^a-zA-Z0-9]/g, '-');
            return `<div class="bg-gray-50 p-4 rounded-lg border">
                        <p class="font-bold text-lg mb-2">${subjectName}</p>
                        <div class="flex items-center gap-4">
                            <div class="input-group flex-1 !mb-0">
                                <label for="marks-${subjectId}">Obtained</label>
                                <input type="number" id="marks-${subjectId}" placeholder="0">
                            </div>
                            <div class="input-group flex-1 !mb-0">
                                <label for="total-${subjectId}">Total</label>
                                <input type="number" id="total-${subjectId}" value="${defaultTotal}">
                            </div>
                        </div>
                    </div>`;
        }).join('');

        navigateTo('page-results-entry');
    };

    const resetEntryForm = () => {
        document.getElementById('student-name').value = '';
        document.getElementById('father-name').value = '';
        document.getElementById('roll-number').value = '';
        document.getElementById('test-term').value = '';
        document.getElementById('roll-number').disabled = false;
        document.getElementById('include-attendance-summary').checked = false;
        const saveBtn = document.getElementById('save-to-cloud-btn');
        if (saveBtn) saveBtn.disabled = false;
        const addAttBtn = document.getElementById('add-attendance-btn');
        if (addAttBtn) {
            addAttBtn.disabled = false;
            addAttBtn.textContent = '➕ Add Attendance';
        }
        studentData = {}; // Reset studentData
        sessionMarks = {};
    };

    const collectDataFromForm = () => {
        studentData.className = currentSelection.class; // Ensure className is set from currentSelection
        studentData.name = document.getElementById('student-name').value.trim();
        studentData.fname = document.getElementById('father-name').value.trim();
        studentData.roll_no = document.getElementById('roll-number').value.trim();
        studentData.term = document.getElementById('test-term').value.trim();

        const subjects = registrationData.classes[currentSelection.class]?.[currentSelection.stream]?.subgroups?.[currentSelection.group] || [];
        sessionMarks = subjects.map(subjectName => {
            const subjectId = subjectName.replace(/[^a-zA-Z0-9]/g, '-');
            const defaultTotal = (classSubjects[studentData.className]?.find(s => s.name.startsWith(subjectName.split(' ')[0]))?.total) || 100;
            return {
                name: subjectName,
                obtained: parseInt(document.getElementById(`marks-${subjectId}`)?.value) || 0,
                total: parseInt(document.getElementById(`total-${subjectId}`)?.value) || defaultTotal
            };
        });
    };

    const generateAttendanceSummaryHTML = (summary) => {
        if (!summary) return '';
        return `
        <section style="margin-top: 1.5rem; padding: 0.75rem; border: 1px solid #d4d4d8; border-radius: 8px; background-color: #fafafa;">
            <h3 style="text-align: center; font-weight: 700; font-size: 14px; margin-bottom: 0.75rem; color: #18181b;">Attendance Summary</h3>
            <div style="display: flex; justify-content: space-around; font-size: 13px;">
                <span>Total Presents: <span style="font-weight: 600;">${summary.presents}</span></span>
                <span>Total Absents: <span style="font-weight: 600;">${summary.absents}</span></span>
                <span>Total Leaves: <span style="font-weight: 600;">${summary.leaves}</span></span>
                <span>Percentage: <span style="font-weight: 600;">${summary.percentage}%</span></span>
            </div>
        </section>`;
    };

    const generateSingleResultCardHTML = (resultData, attendanceSummary = null) => {
        let totalObtained = 0, totalMarksPossible = 0;
        const studentChoices = resultData.students.subject_choices || {};

        const tableRowsHtml = resultData.marks_data
            .map(subject => {
                totalObtained += subject.obtained;
                totalMarksPossible += subject.total;
                const subjectPercentage = subject.total > 0 ? ((subject.obtained / subject.total) * 100) : 0;
                const subjectGrade = getGradeAndRemarks(subjectPercentage).grade;

                const displayName = studentChoices[subject.name] || subject.name;

                return `<tr><td>${displayName}</td><td>${subject.total}</td><td>${subject.obtained}</td><td>${subjectPercentage.toFixed(2)}%</td><td class="${getGradeClass(subjectGrade)}">${subjectGrade}</td></tr>`;
            }).join('');

        const overallPercentage = totalMarksPossible > 0 ? ((totalObtained / totalMarksPossible) * 100) : 0;
        const { grade: overallGrade, remarks: overallRemarks } = getGradeAndRemarks(overallPercentage);
        const resultDate = new Date(resultData.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
        const attendanceHtml = generateAttendanceSummaryHTML(attendanceSummary);

        return `<div class="result-card-container">
        <header class="academy-header">
            <img src="https://i.postimg.cc/Dzz5bbVt/Picture1.jpg?v=${new Date().getTime()}" alt="Logo" crossorigin="anonymous">
                 <div>
                     <div class="academy-name">The I.L.M.I Academy Science & Commerce</div>
                     <div class="academy-address">Kahna Nau, Lahore</div>
                 </div>
            </header>
            <h2 class="text-center text-2xl font-bold uppercase tracking-wider mb-4">Result Card</h2>
            <table class="student-details-table">
                <tr><td class="label-cell">Student Name:</td><td class="value-cell">${resultData.students.name}</td><td class="label-cell" style="padding-left: 1.5rem;">Class:</td><td class="value-cell">${resultData.class_name}</td></tr>
                <tr><td class="label-cell">Father's Name:</td><td class="value-cell">${resultData.students.fname}</td><td class="label-cell" style="padding-left: 1.5rem;">Roll No:</td><td class="value-cell">${resultData.student_roll_no}</td></tr>
                <tr><td class="label-cell">Term:</td><td class="value-cell">${resultData.term}</td><td class="label-cell" style="padding-left: 1.5rem;">Date:</td><td class="value-cell">${resultDate}</td></tr>
            </table>
            <table class="result-table"><thead><tr><th>Subject</th><th>Total</th><th>Obtained</th><th>%</th><th>Grade</th></tr></thead><tbody>${tableRowsHtml}</tbody></table>
            <section style="margin-top: 1.5rem; padding-top: 0.75rem; border-top: 2px solid #27272a; display: flex; justify-content: space-around; font-weight: 700; font-size: 14px;">
                <span>Total: <span style="font-weight: 500;">${totalMarksPossible}</span></span>
                <span>Obtained: <span style="font-weight: 500;">${totalObtained}</span></span>
                <span>Percentage: <span style="font-weight: 500;">${overallPercentage.toFixed(2)}%</span></span>
                <span>Grade: <span class="${getGradeClass(overallGrade)}" style="font-weight: 700;">${overallGrade}</span></span>
            </section>
            ${attendanceHtml}
            <section class="remarks-section" style="text-align:center; margin-top:1.5rem;"><p>Remarks: <span class="${getGradeClass(overallGrade)}">${overallRemarks}</span></p></section>
            <footer class="signature-section"><div class="signature-line">Parents / Guardian</div><div class="signature-line">Principal</div></footer>
        </div>`;
    };

    window.generateResult = async () => {
        collectDataFromForm();
        if (!studentData.name || !studentData.roll_no) return showToast("Student Name and Roll Number are required.", "error");

        const studentDetails = await getStudentFromSupabase(studentData.className, studentData.roll_no);

        let attendanceSummary = null;
        if (document.getElementById('include-attendance-summary').checked) {
            showToast("Fetching attendance summary...", 'info');
            attendanceSummary = await getAttendanceSummaryForStudent(studentData.className, studentData.roll_no);
            if (!attendanceSummary) showToast("No attendance records found for this student.", "info");
        }

        const previewData = {
            students: {
                name: studentData.name,
                fname: studentData.fname,
                subject_choices: studentDetails ? studentDetails.subject_choices : {}
            },
            class_name: studentData.className,
            student_roll_no: studentData.roll_no,
            term: studentData.term,
            marks_data: sessionMarks,
            created_at: new Date().toISOString()
        };
        document.getElementById('final-result-display').innerHTML = generateSingleResultCardHTML(previewData, attendanceSummary);
        navigateTo('page-results-result');
        const addAttBtn = document.getElementById('add-attendance-btn');
        if (addAttBtn) {
            addAttBtn.disabled = false;
            addAttBtn.textContent = '➕ Add Attendance';
        }
    };

window.addAttendanceToPreview = async () => {
        const btn = document.getElementById('add-attendance-btn');
        btn.disabled = true;
        btn.textContent = 'Adding...';
        showToast("Fetching attendance summary...", 'info');
        const studentDetails = await getStudentFromSupabase(studentData.className, studentData.roll_no);
        const attendanceSummary = await getAttendanceSummaryForStudent(studentData.className, studentData.roll_no);
        if (!attendanceSummary) showToast("No attendance records found.", "info");

        const previewData = {
            students: {
                name: studentData.name,
                fname: studentData.fname,
                subject_choices: studentDetails ? studentDetails.subject_choices : {}
            },
            class_name: studentData.className,
            student_roll_no: studentData.roll_no,
            term: studentData.term,
            marks_data: sessionMarks,
            created_at: new Date().toISOString()
        };
        document.getElementById('final-result-display').innerHTML = generateSingleResultCardHTML(previewData, attendanceSummary);
        showToast("Attendance summary added to preview.", "success");
        btn.textContent = '✅ Added';
    };

    async function _saveToSupabase() {
        if (!currentUser) { showToast("You must be logged in to save.", "error"); return { success: false }; }
        const { error: studentError } = await supabase.from('students').upsert({ user_id: currentUser.id, class_name: studentData.className, roll_no: studentData.roll_no, name: studentData.name, fname: studentData.fname }, { onConflict: 'user_id,class_name,roll_no' });
        if (studentError) { showToast("Error saving student details.", "error"); console.error(studentError); return { success: false, error: studentError }; }
        const { error: resultError } = await supabase.from('results').upsert({ user_id: currentUser.id, class_name: studentData.className, student_roll_no: studentData.roll_no, term: studentData.term, marks_data: sessionMarks }, { onConflict: 'user_id,class_name,student_roll_no,term' });
        if (resultError) { showToast("Error saving result data.", "error"); console.error(resultError); return { success: false, error: resultError }; }
        return { success: true };
    }

    window.saveResultToCloud = async () => {
        const saveBtn = document.getElementById('save-to-cloud-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";
        const { success } = await _saveToSupabase();
        if (success) showToast("Result saved to cloud successfully!");
        saveBtn.disabled = false;
        saveBtn.textContent = "☁️ Save to Cloud";
    };

    window.saveResultDirectly = async () => {
        collectDataFromForm();
        if (!studentData.name || !studentData.roll_no) return showToast("Student Name and Roll Number are required before saving.", "error");
        showToast("Saving to cloud...");
        const { success } = await _saveToSupabase();
        if (success) {
            showToast(`Result for ${studentData.name} saved successfully!`, 'success');
            clearStudentInputs();
        }
    };

    const clearStudentInputs = () => {
        document.getElementById('student-name').value = '';
        document.getElementById('father-name').value = '';
        document.getElementById('roll-number').value = '';
        document.getElementById('include-attendance-summary').checked = false;
        document.getElementById('marks-entry-container').querySelectorAll('input[id^="marks-"]').forEach(input => input.value = '');
        document.getElementById('student-name').focus();
    };

    window.startNewResultForSameClass = () => {
        clearStudentInputs();
        navigateTo('page-results-entry');
    };

    window.openSavedResults = async () => {
        if (!currentUser) return showToast("Please log in first.", "error");
        showToast("Fetching saved results...", 'info');

        // --- REQUEST 1: FETCH RESULTS ---
        const { data: resultsData, error: resultsError } = await supabase
            .from('results')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (resultsError) {
            console.error("Error fetching RESULTS:", resultsError);
            return showToast("Could not fetch results data.", "error");
        }
        console.log("Successfully fetched results:", resultsData); // Debugging

        // --- REQUEST 2: FETCH STUDENTS ---
        const { data: studentsData, error: studentsError } = await supabase
            .from('students')
            .select('name, fname, class_name, roll_no, subject_choices')
            .eq('user_id', currentUser.id);

        if (studentsError) {
            console.error("Error fetching STUDENTS:", studentsError); // This will now show the specific error
            return showToast("Could not fetch student data. Check RLS policies.", "error");
        }
        console.log("Successfully fetched students:", studentsData); // Debugging

        // --- COMBINE AND RENDER ---
        allSavedResults = resultsData.map(result => {
            const studentInfo = studentsData.find(s =>
                s.class_name === result.class_name && s.roll_no === result.student_roll_no
            );
            const finalStudentData = studentInfo || {
                name: `(Deleted Student)`,
                fname: '',
                subject_choices: {}
            };
            return { ...result, students: finalStudentData };
        });

        const classFilter = document.getElementById('class-filter');
        const uniqueClasses = [...new Set(allSavedResults.map(r => r.class_name))].sort();
        classFilter.innerHTML = '<option value="All">All Classes</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');

        filterAndDisplaySavedResults();
        navigateTo('page-results-saved-results');
    };

    window.filterAndDisplaySavedResults = () => {
        const filterValue = document.getElementById('class-filter').value;
        const filteredResults = filterValue === 'All' ? allSavedResults : allSavedResults.filter(r => r.class_name === filterValue);
        const listContainer = document.getElementById('saved-results-list');
        if (filteredResults.length === 0) {
            listContainer.innerHTML = `<p class="text-center text-gray-500 p-4">No results found for this filter.</p>`;
            return;
        }
        listContainer.innerHTML = filteredResults.map(result => {
            const savedDate = new Date(result.created_at).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
            return `<div class="flex items-center justify-between p-3 bg-white border rounded-md">
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="result-checkbox h-4 w-4 rounded border-gray-300" value="${result.id}" onchange="updateBatchActionVisibility()">
                    <div>
                        <p class="font-bold text-gray-800">${result.students.name} <span class="font-normal text-gray-500">(Roll: ${result.student_roll_no})</span></p>
                        <p class="text-sm text-gray-600">Class ${result.class_name} - ${result.term} <span class="text-gray-400">(${savedDate})</span></p>
                    </div>
                </div>
                <div class="flex gap-2"><button class="btn btn-secondary !p-2" onclick='editSavedResult(${JSON.stringify(result)})'>✏️ Edit</button></div>
            </div>`;
        }).join('');
        document.getElementById('select-all-checkbox').checked = false;
        updateBatchActionVisibility();
    };

    window.editSavedResult = (result) => {
        // Set current selection based on the result being edited
        currentSelection = { class: result.class_name, stream: result.class_type, group: result.subgroup }; // Assuming result has these props, adjust if needed

        const subjects = result.marks_data.map(m => ({ name: m.name, total: m.total }));
        const container = document.getElementById('marks-entry-container');
        container.innerHTML = subjects.map(subject => {
            const subjectId = subject.name.replace(/[^a-zA-Z0-9]/g, '-');
            return `<div class="bg-gray-50 p-4 rounded-lg border">
                <p class="font-bold text-lg mb-2">${subject.name}</p>
                <div class="flex items-center gap-4">
                    <div class="input-group flex-1 !mb-0"><label for="marks-${subjectId}">Obtained</label><input type="number" id="marks-${subjectId}"></div>
                    <div class="input-group flex-1 !mb-0"><label for="total-${subjectId}">Total</label><input type="number" id="total-${subjectId}" value="${subject.total}"></div>
                </div>
            </div>`;
        }).join('');

        document.getElementById('student-name').value = result.students.name;
        document.getElementById('father-name').value = result.students.fname;
        document.getElementById('roll-number').value = result.student_roll_no;
        document.getElementById('roll-number').disabled = true; // Keep roll number disabled when editing
        document.getElementById('test-term').value = result.term;
        result.marks_data.forEach(subject => {
            const subjectId = subject.name.replace(/[^a-zA-Z0-9]/g, '-');
            const obtainedInput = document.getElementById(`marks-${subjectId}`);
            if (obtainedInput) obtainedInput.value = subject.obtained;
        });
        showToast(`Editing result for ${result.students.name}`);
        navigateTo('page-results-entry');
    };


    window.startBatchEntry = async () => {
        const className = document.getElementById('batch-entry-class-select').value;
        const stream = document.getElementById('batch-entry-stream-select').value;
        const group = document.getElementById('batch-entry-group-select').value;

        if (!className || !stream || !group) {
            return showToast("Please select a class, stream, and group.", "error");
        }

        currentSelection = { class: className, stream, group };
        document.getElementById('batch-entry-heading').textContent = `Batch Entry for ${className} > ${stream} > ${group}`;

        let subjects = [];

        // --- START CORRECTED SUBJECT GATHERING LOGIC ---
        // 1. Determine which streams to process (All or just the selected one)
        const streamsToProcess = stream === 'all'
            ? Object.keys(registrationData.classes[className] || {})
            : [stream];

        // 2. Iterate through the relevant streams and groups
        streamsToProcess.forEach(s => {
            const streamData = registrationData.classes[className]?.[s];
            if (streamData?.subgroups) {
                const groupsToProcess = group === 'all'
                    ? Object.keys(streamData.subgroups)
                    : [group];

                groupsToProcess.forEach(g => {
                    const groupSubjects = streamData.subgroups[g] || [];
                    subjects = subjects.concat(groupSubjects);
                });
            }
        });

        // 3. Clean up and sort
        subjects = [...new Set(subjects)].sort();
        // --- END CORRECTED SUBJECT GATHERING LOGIC ---

        const subjectSelect = document.getElementById('batch-subject-select');
        // NOTE: The map function inside this HTML template needs to look up the total marks correctly.
        subjectSelect.innerHTML = subjects.map(sName => {
            // Look up total marks based on the class (using the first part of the subject name)
            const defaultTotal = classSubjects[className]?.find(cs => sName.includes(cs.name.split(' ')[0]))?.total || 100;
            return `<option value="${sName}" data-total="${defaultTotal}">${sName}</option>`;
        }).join('');

        // --- Fetch Students Logic (Original code) ---
        showToast(`Fetching students for the selected group...`, 'info');

        let query = supabase.from('students').select('*').eq('user_id', currentUser.id);
        if (className !== 'all') query = query.eq('class_name', className);
        if (stream !== 'all') query = query.eq('class_type', stream);
        if (group !== 'all') query = query.eq('subgroup', group);

        const { data: students, error } = await query.order('roll_no');
        if (error) { return showToast("Error fetching students.", "error"); }

        localStudentsCache = students;

        if (!students || students.length === 0) {
            document.getElementById('batch-marks-table-body').innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">No students found for this selection.</td></tr>`;
        } else {
            renderBatchMarksTable();
        }

        updateBatchFormInputs();
        navigateTo('page-results-batch-entry');
    };

    window.renderBatchMarksTable = () => {
        const tableBody = document.getElementById('batch-marks-table-body');
        const subjectSelect = document.getElementById('batch-subject-select');
        const selectedSubject = subjectSelect.value;
        const isSubjectValid = selectedSubject && selectedSubject !== '';

        if (!localStudentsCache || localStudentsCache.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">No students found for this selection.</td></tr>`;
            return;
        }

        const displaySubject = isSubjectValid ? selectedSubject : "Select Subject Above";

        tableBody.innerHTML = localStudentsCache.map(student => {
            // Filter students only if a specific subject is actively selected (and not the 'All' option)
            if (isSubjectValid && (!student.subjects || !student.subjects.includes(selectedSubject))) {
                return '';
            }

            return `
				<tr data-roll-no="${student.roll_no}">
					<td class="px-6 py-4">${student.roll_no}</td>
					<td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${student.name}</td>
					<td class="px-6 py-4">${displaySubject}</td>
					<td class="px-6 py-4">
						<input type="number" class="batch-mark-input w-full p-2 border rounded-lg" placeholder="Enter marks">
					</td>
				</tr>
			`;
        }).join('');
    };

    window.updateBatchFormInputs = () => {
        const subjectSelect = document.getElementById('batch-subject-select');
        if (subjectSelect.options.length > 0) {
            const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
            document.getElementById('batch-total-marks').value = selectedOption.dataset.total;
        }
        renderBatchMarksTable(); // Call renderBatchMarksTable here to update the table content
    };


    window.fetchExistingMarksForBatch = async () => {
        const term = document.getElementById('batch-test-term').value.trim();
        const subjectName = document.getElementById('batch-subject-select').value;
        if (!term) return showToast("Please enter a Test Term to fetch marks.", "error");
        showToast(`Fetching marks for ${subjectName} in ${term}...`, 'info');
        const { data: results, error } = await supabase.from('results').select('student_roll_no, marks_data').eq('user_id', currentUser.id).eq('class_name', currentSelection.class).eq('term', term);
        if (error) { console.error(error); return showToast("Failed to fetch marks.", "error"); }
        let marksFound = false;
        document.querySelectorAll('#batch-marks-table-body tr').forEach(row => {
            const rollNo = row.dataset.rollNo;
            const res = results.find(r => r.student_roll_no === rollNo);
            const input = row.querySelector('.batch-mark-input');
            input.value = '';
            if (res?.marks_data) {
                const mark = res.marks_data.find(m => m.name === subjectName);
                if (mark) { input.value = mark.obtained; marksFound = true; }
            }
        });
        showToast(marksFound ? "Existing marks loaded." : "No existing marks found for this term.", marksFound ? "success" : "info");
    };

    window.saveAllMarks = async () => {
        const subjectName = document.getElementById('batch-subject-select').value;
        const term = document.getElementById('batch-test-term').value.trim();
        const globalTotal = parseInt(document.getElementById('batch-total-marks').value);
        if (!term || isNaN(globalTotal)) return showToast("Term and Total Marks are required.", "error");

        const { data: existingResults, error: fetchError } = await supabase.from('results').select('*').eq('user_id', currentUser.id).eq('class_name', currentSelection.class).eq('term', term);
        if (fetchError) { console.error(fetchError); return showToast("Could not fetch records to update.", "error"); }

        const recordsToUpsert = [];

        for (const row of document.querySelectorAll('#batch-marks-table-body tr[data-roll-no]')) {
            const mark = row.querySelector('.batch-mark-input').value;
            if (mark === '') continue;

            const rollNo = row.dataset.rollNo;
            const obtained = parseInt(mark);
            if (isNaN(obtained) || obtained < 0 || obtained > globalTotal) return showToast(`Invalid mark for Roll No ${rollNo}.`, "error");

            let existingRecord = existingResults.find(r => r.student_roll_no === rollNo);
            let newMarksData = existingRecord ? [...existingRecord.marks_data] : (localStudentsCache.find(s => s.roll_no === rollNo)?.subjects || []).map(s => ({ name: s, obtained: 0, total: 100 })); // Default total 100 if no record
            const subjectIndex = newMarksData.findIndex(s => s.name === subjectName);

            if (subjectIndex > -1) {
                newMarksData[subjectIndex] = { name: subjectName, obtained, total: globalTotal };
            } else {
                newMarksData.push({ name: subjectName, obtained, total: globalTotal });
            }

            recordsToUpsert.push({ user_id: currentUser.id, class_name: currentSelection.class, student_roll_no: rollNo, term: term, marks_data: newMarksData });
        }

        let success = true;

        if (recordsToUpsert.length > 0) {
            showToast(`Saving ${recordsToUpsert.length} mark records...`);
            const { error } = await supabase.from('results').upsert(recordsToUpsert, { onConflict: 'user_id,class_name,student_roll_no,term' });
            if (error) {
                console.error(error);
                showToast("Error saving marks.", "error");
                success = false;
            }
        }

        if (success && recordsToUpsert.length > 0) {
            showToast("All data saved successfully!", "success");
        } else if (recordsToUpsert.length === 0) {
            showToast("No new marks entered to save.", "info");
        }
    };

    window.updateBatchActionVisibility = () => document.getElementById('batch-actions-container').classList.toggle('hidden', document.querySelectorAll('.result-checkbox:checked').length === 0);
    window.toggleSelectAll = (checked) => { document.querySelectorAll('.result-checkbox').forEach(cb => cb.checked = checked); updateBatchActionVisibility(); };

    window.printSelectedResults = async (withAttendance = false) => {
        const selectedIds = [...document.querySelectorAll('.result-checkbox:checked')].map(cb => parseInt(cb.value));
        if (selectedIds.length === 0) return showToast("No results selected.", "error");
        const resultsToPrint = allSavedResults.filter(r => selectedIds.includes(r.id));

        showToast(`Generating ${resultsToPrint.length} cards...`, 'info');

        const allCardsHtmlPromises = resultsToPrint.map(async (result) => {
            let attendanceSummary = null;
            if (withAttendance) {
                attendanceSummary = await getAttendanceSummaryForStudent(result.class_name, result.student_roll_no);
            }
            return generateSingleResultCardHTML(result, attendanceSummary);
        });

        const htmlCards = await Promise.all(allCardsHtmlPromises);
        document.getElementById('final-result-display').innerHTML = htmlCards.join('<div class="page-break"></div>');

        navigateTo('page-results-result');
        document.getElementById('preview-controls').classList.add('hidden');
        triggerPrint('page-results-result');
        setTimeout(() => {
            document.getElementById('preview-controls').classList.remove('hidden');
        }, 1000);
    };

    window.deleteSelectedResults = async () => {
        const selectedIds = [...document.querySelectorAll('.result-checkbox:checked')].map(cb => parseInt(cb.value));
        if (selectedIds.length === 0) return;

        showToast("Deleting selected results...");
        const { error } = await supabase.from('results').delete().in('id', selectedIds);
        if (error) { showToast("Error deleting results.", "error"); console.error(error); }
        else {
            showToast("Selected results deleted.");
            allSavedResults = allSavedResults.filter(r => !selectedIds.includes(r.id));
            filterAndDisplaySavedResults();
        }
    };

    const getGradeAndRemarks = (percentage) => gradingScale.find(s => percentage >= s.percentage) || gradingScale[gradingScale.length - 1];
    const getGradeClass = (grade) => `grade-${grade.replace('+', '-plus')}`;

    /**************************************************************************/
    /* BATCH REPORT & DOWNLOADS LOGIC                                         */
    /**************************************************************************/

    const initializeBatchReportGenerator = async () => {
        populateClassSelect('batch-report-class-select', false); // Changed includeAll to false
        document.getElementById('batch-report-stream-select').disabled = true;
        document.getElementById('batch-report-group-select').disabled = true;
        document.getElementById('batch-report-term-select').disabled = true;
        document.getElementById('batch-report-subject-select').disabled = true;
    };


    window.populateTermAndSubjectDropdowns = async () => {
        const className = document.getElementById('batch-report-class-select').value;
        const stream = document.getElementById('batch-report-stream-select').value;
        const group = document.getElementById('batch-report-group-select').value;

        const termSelect = document.getElementById('batch-report-term-select');
        const subjectSelect = document.getElementById('batch-report-subject-select');

        termSelect.disabled = true;
        subjectSelect.disabled = true;
        termSelect.innerHTML = '<option value="">-- Loading... --</option>';
        subjectSelect.innerHTML = '<option value="">-- Loading... --</option>';

        if (!className || !stream || !group) return;

        showToast(`Fetching data for selected group...`, 'info');
        const { data, error } = await supabase.from('results').select('term').eq('user_id', currentUser.id).eq('class_name', className);
        if (error) return showToast("Could not fetch terms.", "error");

        const uniqueTerms = [...new Set(data.map(item => item.term))];
        if (uniqueTerms.length > 0) {
            termSelect.innerHTML = '<option value="">-- Choose a Term --</option>' + uniqueTerms.map(term => `<option value="${term}">${term}</option>`).join('');
            termSelect.disabled = false;
        } else {
            termSelect.innerHTML = '<option value="">No results found</option>';
        }

        let subjectsForClass = [];
        // Adjusted logic to handle 'all' stream/group for subject population
        if (stream === 'all') {
             const allStreamsData = registrationData.classes[className] || {};
             Object.values(allStreamsData).forEach(streamData => {
                 if (streamData.subgroups) {
                     Object.values(streamData.subgroups).forEach(groupSubjects => {
                         subjectsForClass = subjectsForClass.concat(groupSubjects);
                     });
                 }
             });
        } else if (group === 'all') {
            const streamData = registrationData.classes[className]?.[stream];
            if (streamData && streamData.subgroups) {
                 Object.values(streamData.subgroups).forEach(groupSubjects => {
                     subjectsForClass = subjectsForClass.concat(groupSubjects);
                 });
            }
        } else {
            subjectsForClass = registrationData.classes[className]?.[stream]?.subgroups?.[group] || [];
        }

        subjectsForClass = [...new Set(subjectsForClass)].sort(); // Ensure uniqueness and sort

        subjectSelect.innerHTML = '<option value="all">All Subjects</option>' + subjectsForClass.map(s => `<option value="${s}">${s}</option>`).join('');
        subjectSelect.disabled = false;
    };


    window.generateBatchReport = async () => {
        const className = document.getElementById('batch-report-class-select').value;
        const stream = document.getElementById('batch-report-stream-select').value;
        const group = document.getElementById('batch-report-group-select').value;
        const term = document.getElementById('batch-report-term-select').value;
        const subject = document.getElementById('batch-report-subject-select').value;
        const includeAttendance = document.getElementById('batch-report-include-attendance').checked;

        if (!className || !stream || !group || !term) return showToast("Please select all hierarchy levels and a term.", "error");

        showToast(`Generating report...`, 'info');

        // 1. Fetch the correctly filtered list of students FIRST
        let studentQuery = supabase.from('students').select('*').eq('user_id', currentUser.id);
        if (className !== 'all') studentQuery = studentQuery.eq('class_name', className); // Handle 'all' class if needed
        if (stream !== 'all') studentQuery = studentQuery.eq('class_type', stream);
        if (group !== 'all') studentQuery = studentQuery.eq('subgroup', group);

        const { data: studentsData, error: studentError } = await studentQuery;

        if (studentError || !studentsData || studentsData.length === 0) {
            return showToast("No students found for this specific selection.", "info");
        }

        // 2. Extract their roll numbers
        const studentRolls = studentsData.map(s => s.roll_no);

        // 3. Now, fetch only the results for THOSE students
        let resultsQuery = supabase.from('results')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('term', term)
            .in('student_roll_no', studentRolls);

        if (className !== 'all') resultsQuery = resultsQuery.eq('class_name', className);

        const { data: resultsData, error: resultsError } = await resultsQuery;


        if (resultsError || !resultsData || resultsData.length === 0) {
            return showToast("No results found for the selected students in this term.", "info");
        }

        const attendanceMap = new Map();
        if (includeAttendance) {
            // Need to fetch attendance for *all* relevant classes if 'All Classes' was selected
            const classesToFetchAttendance = className === 'all' ? [...new Set(studentsData.map(s => s.class_name))] : [className];
            const attendancePromises = [];
            studentsData.forEach(s => {
                if (classesToFetchAttendance.includes(s.class_name)) { // Only fetch if class matches
                    attendancePromises.push(getAttendanceSummaryForStudent(s.class_name, s.roll_no).then(summary => ({ roll_no: s.roll_no, summary })));
                }
            });

            const attendanceResults = await Promise.all(attendancePromises);
            attendanceResults.forEach(res => attendanceMap.set(res.roll_no, res.summary));
        }


        let reportData = studentsData.map(student => {
            const result = resultsData.find(r => r.student_roll_no === student.roll_no && r.class_name === student.class_name); // Match class too
            if (!result) return null;

            let totalObtained = 0;
            let totalMarks = 0;
            const marks = {};

            // Determine which subjects to include based on student's registered subjects
            const studentSubjects = student.subjects || [];
            const subjectsToProcess = subject === 'all' ?
                result.marks_data.filter(s => studentSubjects.includes(s.name)) :
                result.marks_data.filter(s => s.name === subject && studentSubjects.includes(s.name)); // Also check if student takes this subject


            subjectsToProcess.forEach(mark => {
                marks[mark.name] = mark.obtained;
                totalObtained += mark.obtained;
                totalMarks += mark.total;
            });

             // If filtering by a single subject and the student doesn't have marks for it, skip them
            if (subject !== 'all' && subjectsToProcess.length === 0) {
                return null;
            }


            return {
                roll: student.roll_no,
                name: student.name,
                class_name: student.class_name, // Include class name
                marks,
                totalObtained,
                totalMarks,
                percentage: totalMarks > 0 ? (totalObtained / totalMarks * 100) : 0,
                attendance: attendanceMap.get(student.roll_no),
                subjects: studentSubjects
            };
        }).filter(Boolean); // Filter out null entries

        reportData.sort((a, b) => b.totalObtained - a.totalObtained);

        // Determine subjects to display based on *all* included students if 'All Subjects' is selected
        const subjectsToDisplay = subject === 'all' ?
            [...new Set(reportData.flatMap(rd => rd.subjects))].sort() :
            [subject];


        // Add Class column if 'All Classes' was selected
        const showClassInTable = className === 'all';

        let headerHTML = `<thead><tr><th>#</th>${showClassInTable ? '<th>Class</th>' : ''}<th>Roll</th><th class="student-name-col">Student Name</th>`;
        subjectsToDisplay.forEach(s => headerHTML += `<th>${s.slice(0, 15)}</th>`); // Shorten header
        headerHTML += `<th class="summary-col">Obt.</th><th class="summary-col">Total</th><th class="summary-col">%</th><th class="summary-col">Grade</th>`;
        if (includeAttendance) headerHTML += `<th class="summary-col">Att. %</th>`;
        headerHTML += `</tr></thead>`;

        let bodyHTML = '<tbody>';
        reportData.forEach((data, index) => {
            const grade = getGradeAndRemarks(data.percentage).grade;
            let posClass = '';
            if (index === 0) posClass = 'pos-1';
            else if (index === 1) posClass = 'pos-2';
            else if (index === 2) posClass = 'pos-3';

            bodyHTML += `<tr class="${posClass}"><td>${index + 1}</td>`;
            if (showClassInTable) bodyHTML += `<td>${data.class_name}</td>`;
            bodyHTML += `<td>${data.roll}</td><td class="student-name-col">${data.name}</td>`;
            subjectsToDisplay.forEach(s => {
                const mark = data.marks[s];
                bodyHTML += `<td>${mark !== undefined ? mark : '-'}</td>`;
            });
            bodyHTML += `<td class="summary-col">${data.totalObtained}</td><td class="summary-col">${data.totalMarks}</td><td class="summary-col">${data.percentage.toFixed(1)}%</td><td class="summary-col ${getGradeClass(grade)}">${grade}</td>`;
            if (includeAttendance) bodyHTML += `<td class="summary-col">${data.attendance ? data.attendance.percentage + '%' : '-'}</td>`;
            bodyHTML += `</tr>`;
        });
        bodyHTML += '</tbody>';

        const brandingHeader = `<header class="academy-header"><img src="https://i.postimg.cc/Dzz5bbVt/Picture1.jpg?v=${new Date().getTime()}" alt="Logo" crossorigin="anonymous"><div><div class="academy-name">The I.L.M.I Academy</div><div class="academy-address">Kahna Nau, Lahore</div></div></header>`;
        const captionText = `Report for ${className === 'all' ? 'All Classes' : `Class ${className}`} ${stream !== 'all' ? `(${stream})` : ''} ${group !== 'all' ? `(${group})` : ''} - ${term} ${subject !== 'all' ? `(${subject})` : ''}`;
        const caption = `<caption>${captionText}</caption>`;
        document.getElementById('batch-report-table-display').innerHTML = `${brandingHeader}<table class="full-report-table">${caption}${headerHTML}${bodyHTML}</table>`;

        document.getElementById('batch-report-heading').textContent = `Report for ${className === 'all' ? 'All Classes' : `Class ${className}`}`;
        document.getElementById('batch-report-subheading').textContent = `Term: ${term} | Generated on: ${new Date().toLocaleDateString('en-GB')}`;

        // Determine if landscape is needed based on number of columns
        currentBatchReportData.isLandscape = (showClassInTable ? 4 : 3) + subjectsToDisplay.length + 4 + (includeAttendance ? 1 : 0) > 10; // Example threshold

        navigateTo('page-results-batch-report-display');
    };

    window.downloadBatchReportImage = async () => {
        const reportContainer = document.getElementById('batch-report-table-display');
        const heading = document.getElementById('batch-report-heading').textContent;
        const subheading = document.getElementById('batch-report-subheading').textContent;
        const filename = `${heading.replace(/ /g, '_')}-${subheading.split('|')[0].trim().replace(/ /g, '_')}.png`;

        showToast("Generating image...", 'info');
        try {
            const canvas = await html2canvas(reportContainer, { scale: 2, useCORS: true, logging: false });
            const imageURL = canvas.toDataURL('image/png');
            const downloadLink = document.createElement('a');
            downloadLink.href = imageURL;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        } catch (error) {
            console.error("Image generation failed:", error);
            showToast("Failed to download image.", "error");
        }
    };

	// ADD THIS NEW FUNCTION TO YOUR SCRIPT
	window.updateRowHierarchies = (selectElement) => {
		const row = selectElement.closest('tr');
		const classSelect = row.querySelector('.class-select');
		const streamSelect = row.querySelector('.stream-select');
		const groupSelect = row.querySelector('.group-select');

		const className = classSelect.value;
		const streamName = streamSelect.value;

		if (selectElement.classList.contains('class-select')) {
			const streams = Object.keys(registrationData.classes[className] || {});
			streamSelect.innerHTML = streams.map(s => `<option value="${s}">${s}</option>`).join('');
			const firstStream = streams[0];
			const groups = Object.keys(registrationData.classes[className]?.[firstStream]?.subgroups || {});
			groupSelect.innerHTML = groups.map(g => `<option value="${g}">${g}</option>`).join('');
		} else if (selectElement.classList.contains('stream-select')) {
			const groups = Object.keys(registrationData.classes[className]?.[streamName]?.subgroups || {});
			groupSelect.innerHTML = groups.map(g => `<option value="${g}">${g}</option>`).join('');
		}
	};

    /**************************************************************************/
    /* ATTENDANCE APP LOGIC                                                   */
    /**************************************************************************/

    window.returnToDashboard = () => navigateTo('page-attendance-action-wizard');

    window.selectClassForAttendance = async (className) => {
        currentAttendanceClass = className;
        showToast(`Loading Class ${className}...`, 'info');
        const students = await getStudentListFromSupabase(className);
        if (students && students.length > 0) {
            document.getElementById('action-wizard-heading').textContent = `Dashboard for Class ${className}`;
            navigateTo('page-attendance-action-wizard');
        } else {
            prepareStudentEntryForm(className);
            navigateTo('page-attendance-students');
        }
    };

    async function getStudentListFromSupabase(className) {
        if (!currentUser) return [];
        const { data, error } = await supabase.from('students').select('roll_no, name, fname, contact').eq('user_id', currentUser.id).eq('class_name', className).order('roll_no', { ascending: true });
        if (error) { console.error("Error fetching students:", error); showToast("Error fetching student list.", "error"); }
        return data ? data.map(s => ({ roll: s.roll_no, name: s.name, fname: s.fname, contact: s.contact })) : [];
    }

    async function saveStudentListToSupabase(className, students) {
        if (!currentUser) return false;

        const { error: deleteError } = await supabase.from('students').delete().match({ user_id: currentUser.id, class_name: className });
        if (deleteError) {
             showToast("Error clearing old student list.", "error");
             return false;
        }

        const studentsToInsert = students.filter(s => s.roll && s.name).map(s => ({ user_id: currentUser.id, class_name: className, roll_no: s.roll, name: s.name, fname: s.fname, contact: s.contact }));

        if (studentsToInsert.length > 0) {
            const { error: insertError } = await supabase.from('students').insert(studentsToInsert);
            if (insertError) {
                console.error(insertError);
                showToast("Failed to save student list.", "error");
                return false;
            }
        }
        return true;
    }

    const createStudentEntryRowHTML = (student = {}, isEditable = false) => {
        const removeButtonHtml = isEditable ? `<div class="flex items-center"><button type="button" onclick="removeStudentEntry(this)" class="btn btn-danger !p-2">🗑️</button></div>` : '';
        return `<div class="student-entry grid ${isEditable ? 'grid-cols-5' : 'grid-cols-4'} gap-4 mb-4 items-center">
            <input type="text" class="student-roll col-span-1 p-2 border rounded-lg" placeholder="Roll No." value="${student.roll || ''}" required>
            <div class="${isEditable ? 'col-span-3' : 'col-span-3'}">
                <input type="text" class="student-name w-full p-2 border rounded-lg" placeholder="Full Name" value="${student.name || ''}" required>
                <input type="text" class="student-fname w-full p-2 border rounded-lg mt-1" placeholder="Father's Name" value="${student.fname || ''}">
                <input type="tel" class="student-contact w-full p-2 border-0 bg-transparent contact-input" placeholder="Contact Number" value="${student.contact || ''}">
            </div>
            ${removeButtonHtml}
        </div>`;
    };

    window.addStudentEntryRow = (containerId, isEditable = false) => document.getElementById(containerId).insertAdjacentHTML('beforeend', createStudentEntryRowHTML({}, isEditable));

    window.removeStudentEntry = (button) => button.closest('.student-entry').remove();

    const getStudentsFromForm = (containerId) => {
        return Array.from(document.querySelectorAll(`#${containerId} .student-entry`)).map(entry => {
            const roll = entry.querySelector('.student-roll').value.trim();
            const name = entry.querySelector('.student-name').value.trim();
            const fname = entry.querySelector('.student-fname').value.trim();
            const contact = entry.querySelector('.student-contact').value.trim();
            if (roll && name) return { roll, name, fname, contact };
        }).filter(Boolean);
    }
    window.prepareStudentEntryForm = (className) => {
        document.getElementById('student-list-heading').textContent = `Create Student List for Class ${className}`;
        const formContainer = document.getElementById('student-list-form');
        formContainer.innerHTML = Array.from({ length: 15 }, () => createStudentEntryRowHTML({}, false)).join('');
    };
    window.saveStudentListAndProceed = async () => {
        const students = getStudentsFromForm('student-list-form');
        if (students.length === 0) return showToast('Please add at least one student.', 'error');
        showToast("Saving to cloud...");
        const success = await saveStudentListToSupabase(currentAttendanceClass, students);
        if (success) {
            showToast('Student List Saved! Redirecting...');
            document.getElementById('action-wizard-heading').textContent = `Dashboard for Class ${currentAttendanceClass}`;
            navigateTo('page-attendance-action-wizard');
        }
    };
    window.openStudentEditor = async () => {
        const students = await getStudentListFromSupabase(currentAttendanceClass);
        document.getElementById('edit-student-list-heading').textContent = `Edit Student List for Class ${currentAttendanceClass}`;
        document.getElementById('edit-student-list-form').innerHTML = students.map(s => createStudentEntryRowHTML(s, true)).join('');
        navigateTo('page-attendance-edit-students');
    };
    window.saveStudentChanges = async () => {
        const students = getStudentsFromForm('edit-student-list-form');
        if (students.length === 0) return showToast("Cannot save an empty student list.", "error");
        showToast("Updating student list...");
        const success = await saveStudentListToSupabase(currentAttendanceClass, students);
        if (success) {
            showToast('Student List Updated!');
            navigateTo('page-attendance-action-wizard');
        }
    };

    window.validateAttendanceInput = (input) => {
        let value = (input.value.trim().toUpperCase() || '').charAt(0);
        if (!['P', 'A', 'L', ''].includes(value)) {
            showToast("Only P, A, or L is allowed.", "error");
            input.value = '';
        } else {
            input.value = value;
        }
    };
    async function generateAttendanceSheet(className, students, year, month, isEditable) {
        sheetEditMode = isEditable;
        const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthName = new Date(year, month, 1).toLocaleString('default', { month: 'long' });

        showToast("Fetching attendance and holiday data...");
        const [attendanceData, holidays] = await Promise.all([
            getAttendanceFromSupabase(className, monthKey),
            getHolidaysFromSupabase(year, month)
        ]);
        const holidayDates = holidays.reduce((acc, h) => ({ ...acc, [new Date(h.date).getUTCDate()]: h.name }), {});

        document.getElementById('sheet-heading').textContent = `Class ${className} - ${monthName} ${year}`;

        const isAttendanceEmpty = Object.keys(attendanceData).length === 0;

        if (isAttendanceEmpty && !isEditable) {
            document.getElementById('attendance-sheet-display').innerHTML = `<div class="text-center p-12 bg-yellow-50 border border-yellow-200 rounded-lg"><p class="text-4xl mb-4">⚠️</p><h2 class="text-2xl font-bold text-yellow-800">This Sheet is Empty</h2><p class="text-yellow-700 mt-2">No attendance has been marked for ${monthName} ${year}. Please mark attendance first.</p></div>`;
            document.getElementById('print-sheet-btn').classList.add('hidden');
            document.getElementById('download-sheet-btn').classList.add('hidden');
            document.getElementById('save-sheet-btn').classList.add('hidden');
            return;
        }

        document.getElementById('print-sheet-btn').classList.toggle('hidden', isEditable);
        document.getElementById('download-sheet-btn').classList.toggle('hidden', isEditable);
        document.getElementById('save-sheet-btn').classList.toggle('hidden', !isEditable);

        let dayNamesHtml = `<thead><tr class="text-xs bg-gray-50 font-semibold"><th colspan="2" class="!bg-white border-0"></th>`;
        let tableHeaderHtml = '<tr><th class="sno-info">S.No</th><th class="student-details-col">Student Details</th>';

        for (let i = 1; i <= daysInMonth; i++) {
            const dayAbbrev = new Date(year, month, i).toLocaleDateString('en-US', { weekday: 'short' }).charAt(0);
            const headerClass = holidayDates[i] ? 'bg-red-200 text-red-800' : '';
            dayNamesHtml += `<th class="day-col ${headerClass}" title="${holidayDates[i] || ''}">${dayAbbrev}</th>`;
            tableHeaderHtml += `<th class="day-col ${headerClass}">${i}</th>`;
        }
        dayNamesHtml += '<th colspan="3" class="summary-col !bg-white border-0"></th></tr>';
        tableHeaderHtml += '<th class="summary-col">P</th><th class="summary-col">A</th><th class="summary-col">%</th></tr></thead>';

        let tableBodyHtml = '<tbody>' + students.map((student, index) => createAttendanceRowHTML(index + 1, student, daysInMonth, attendanceData[student.roll] || {}, isEditable, holidayDates)).join('') + '</tbody>';

        // --- THIS IS THE LINE THAT WAS FIXED ---
        const headerHtml = `<header class="academy-header"><img src="https://i.postimg.cc/Dzz5bbVt/Picture1.jpg?v=${new Date().getTime()}" alt="Logo" crossorigin="anonymous"><div><div class="academy-name">The I.L.M.I Academy</div><div class="academy-address">Attendance Sheet</div></div></header>`;

        document.getElementById('attendance-sheet-display').innerHTML = headerHtml + `<table class="attendance-table" id="attendance-table-dynamic" data-month-key="${monthKey}"><caption>Attendance for Class ${className} - ${monthName} ${year}</caption>${dayNamesHtml}${tableHeaderHtml}${tableBodyHtml}</table>`;
        updateAllSummaries();
    }
    const createAttendanceRowHTML = (sNo, student, daysInMonth, studentAtt, isEditable, holidays) => {
        const studentDetailsHtml = `
            <div class="student-name-main">${student.name}</div>
            <div class="student-meta-info">${student.fname || ''}</div>
            <div class="student-meta-info">R.No: ${student.roll} | ${student.contact || 'N/A'}</div>`;
        let rowHtml = `<tr data-roll="${student.roll}"><td>${sNo}</td><td class="student-details-col">${studentDetailsHtml}</td>`;

        for (let i = 1; i <= daysInMonth; i++) {
            const status = studentAtt[i] || '';
            if (holidays[i]) {
                rowHtml += `<td class="day-data status-H" data-day="${i}" title="${holidays[i]}">H</td>`;
            } else {
                rowHtml += isEditable
                    ? `<td class="day-data"><input type="text" maxlength="1" data-day="${i}" value="${status}" oninput="validateAttendanceInput(this); updateSingleSummary(this.closest('tr'))"></td>`
                    : `<td class="day-data status-${status}" data-day="${i}">${status}</td>`;
            }
        }
        rowHtml += `<td class="summary-col present-total">0</td><td class="summary-col absent-total">0</td><td class="summary-col percentage">0%</td></tr>`;
        return rowHtml;
    };
    window.openAttendanceWizard = async () => {
        const today = new Date();
        document.getElementById('wizard-heading').textContent = `Mark Attendance for ${today.toLocaleDateString('en-GB', { dateStyle: 'full' })}`;

        const [students, attendanceData, holidays] = await Promise.all([
            getStudentListFromSupabase(currentAttendanceClass),
            getAttendanceFromSupabase(currentAttendanceClass, `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`),
            getHolidaysFromSupabase(today.getFullYear(), today.getMonth())
        ]);

        const listContainer = document.getElementById('wizard-student-list');
        if (holidays.some(h => new Date(h.date).getUTCDate() === today.getDate())) {
            listContainer.innerHTML = `<div class="bg-blue-100 text-blue-800 p-6 rounded-lg text-center font-semibold text-lg">🎉 Today is a Holiday! Attendance cannot be marked.</div>`;
            document.querySelector('#page-attendance-wizard .btn-success').disabled = true;
        } else {
            listContainer.innerHTML = students.map(student => {
                const status = (attendanceData[student.roll] && attendanceData[student.roll][today.getDate()]) || '';
                return `<div class="wizard-student-card">
                    <div><p class="font-bold">${student.name}</p><p class="text-sm text-gray-500">Roll No: ${student.roll}</p></div>
                    <div class="flex gap-2" data-roll="${student.roll}" data-status="${status}">
                        <button class="wizard-btn bg-green-100 text-green-800 ${status === 'P' ? 'selected' : ''}" onclick="selectStatus(this, 'P')">Present</button>
                        <button class="wizard-btn bg-red-100 text-red-800 ${status === 'A' ? 'selected' : ''}" onclick="selectStatus(this, 'A')">Absent</button>
                        <button class="wizard-btn bg-yellow-100 text-yellow-800 ${status === 'L' ? 'selected' : ''}" onclick="selectStatus(this, 'L')">Leave</button>
                    </div>
                </div>`;
            }).join('');
            document.querySelector('#page-attendance-wizard .btn-success').disabled = false;
        }
        navigateTo('page-attendance-wizard');
    };
    window.openMonthSelectionWizard = (mode) => {
        sheetEditMode = (mode === 'edit');
        document.getElementById('month-wizard-heading').textContent = `Select Month to ${mode.charAt(0).toUpperCase() + mode.slice(1)}`;
        document.getElementById('month-wizard-continue-btn').onclick = generateSheetFromWizard;
        const now = new Date();
        document.getElementById('month-select').innerHTML = [...Array(12).keys()].map(i => `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${new Date(0, i).toLocaleString('default', { month: 'long' })}</option>`).join('');
        document.getElementById('year-select').innerHTML = [...Array(6).keys()].map(i => now.getFullYear() - i).map(y => `<option value="${y}">${y}</option>`).join('');
        navigateTo('page-attendance-month-wizard');
    };
    window.generateSheetFromWizard = async () => {
        const month = document.getElementById('month-select').value;
        const year = document.getElementById('year-select').value;
        const students = await getStudentListFromSupabase(currentAttendanceClass);
        if (students.length === 0) return showToast("No students found. Please set up list first.", "error");
        await generateAttendanceSheet(currentAttendanceClass, students, year, parseInt(month), sheetEditMode);
        navigateTo('page-attendance-sheet');
    };
    window.selectStatus = (btn, status) => {
        const parent = btn.parentElement;
        parent.querySelectorAll('.wizard-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        parent.dataset.status = status;
    };
    window.markAll = (status) => document.querySelectorAll('#wizard-student-list .wizard-btn').forEach(btn => { if (btn.textContent.startsWith(status === 'P' ? 'Present' : 'Absent')) selectStatus(btn, status); });

    window.saveWizardAttendance = async () => {
        const today = new Date();
        const monthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        const records = {};
        let marked = 0;
        document.querySelectorAll('#wizard-student-list div[data-roll]').forEach(group => {
            if (group.dataset.status) {
                records[group.dataset.roll] = { [today.getDate()]: group.dataset.status };
                marked++;
            }
        });
        if (marked === 0) return showToast("No attendance marked.", "error");
        await saveAttendanceToSupabase(currentAttendanceClass, monthKey, records);
        returnToDashboard();
    };
    window.saveAdvancedAttendanceChanges = async () => {
        const table = document.getElementById('attendance-table-dynamic');
        if (!table) return;
        const monthKey = table.dataset.monthKey;
        const records = {};
        let total = 0;
        table.querySelectorAll('tbody tr').forEach(row => {
            const roll = row.dataset.roll;
            records[roll] = {};
            row.querySelectorAll('.day-data input').forEach(input => {
                const status = input.value.trim().toUpperCase();
                if (['P', 'A', 'L'].includes(status)) {
                    records[roll][input.dataset.day] = status;
                    total++;
                }
            });
        });
        if (total > 0) {
            await saveAttendanceToSupabase(currentAttendanceClass, monthKey, records);
            showToast("Sheet updated successfully!");
        } else {
            showToast("No data to save.", "info");
        }
        returnToDashboard();
    };
    const updateSingleSummary = (row) => {
        if (!row || !sheetEditMode) return;
        let p = 0, a = 0;
        row.querySelectorAll('.day-data input').forEach(i => { if (i.value === 'P') p++; else if (i.value === 'A') a++; });
        const total = p + a;
        row.querySelector('.present-total').textContent = p;
        row.querySelector('.absent-total').textContent = a;
        row.querySelector('.percentage').textContent = `${total > 0 ? ((p / total) * 100).toFixed(0) : 0}%`;
    };
    const updateAllSummaries = () => document.querySelectorAll('#attendance-table-dynamic tbody tr').forEach(row => {
        let p = 0, a = 0;
        row.querySelectorAll('.day-data').forEach(cell => {
            const val = (cell.querySelector('input')?.value || cell.textContent).trim().toUpperCase();
            if (val === 'P') p++; else if (val === 'A') a++;
        });
        const total = p + a;
        row.querySelector('.present-total').textContent = p;
        row.querySelector('.absent-total').textContent = a;
        row.querySelector('.percentage').textContent = `${total > 0 ? ((p / total) * 100).toFixed(0) : 0}%`;
    });

    window.openHolidayManager = async () => {
        const now = new Date();
        document.getElementById('holiday-date-input').value = now.toISOString().split('T')[0];
        const holidays = await getHolidaysFromSupabase(now.getFullYear(), now.getMonth());
        updateHolidayListUI(holidays);
        navigateTo('page-attendance-manage-holidays');
    };
    window.addHoliday = async () => {
        const name = document.getElementById('holiday-name-input').value.trim();
        const date = document.getElementById('holiday-date-input').value;
        if (!name || !date) return showToast("Name and date are required.", "error");
        await saveHolidayToSupabase({ name, date });
        document.getElementById('holiday-name-input').value = '';
        const d = new Date(date);
        updateHolidayListUI(await getHolidaysFromSupabase(d.getFullYear(), d.getMonth()));
    };
    function updateHolidayListUI(holidays) {
        const list = document.getElementById('holidays-list');
        if (holidays.length === 0) return list.innerHTML = '<p class="text-gray-500 text-center py-4">No holidays defined for this period.</p>';
        holidays.sort((a, b) => new Date(b.date) - new Date(a.date));
        list.innerHTML = holidays.map(h => `<div class="flex justify-between items-center p-2 border-b">
            <p class="text-sm font-medium">${new Date(h.date).toLocaleDateString('en-GB', { dateStyle: 'full' })}: <span class="text-indigo-600">${h.name}</span></p>
            <button onclick="deleteHoliday('${h.date}')" class="text-red-500 text-xs">🗑️</button>
        </div>`).join('');
    }
    window.deleteHoliday = async (date) => {

        await supabase.from('holidays').delete().match({ user_id: currentUser.id, date });
        showToast("Holiday deleted.");
        const d = new Date(date);
        updateHolidayListUI(await getHolidaysFromSupabase(d.getFullYear(), d.getMonth()));
    }

    window.openDeleteWizard = () => {
        const now = new Date();
        document.getElementById('delete-month-select').innerHTML = [...Array(12).keys()].map(i => `<option value="${i + 1}">${new Date(0, i).toLocaleString('default', { month: 'long' })}</option>`).join('');
        document.getElementById('delete-year-select').innerHTML = [...Array(6).keys()].map(i => now.getFullYear() - i).map(y => `<option value="${y}">${y}</option>`).join('');
        navigateTo('page-attendance-delete-wizard');
    };
    window.confirmDeleteRecords = async () => {
        const month = document.getElementById('delete-month-select').value;
        const year = document.getElementById('delete-year-select').value;

        showToast("Deleting records...");
        await deleteAttendanceForMonth(currentAttendanceClass, year, month);
    };
    async function deleteAttendanceForMonth(className, year, month) {
        if (!currentUser) return;
        const { error } = await supabase.from('attendance').delete().match({ user_id: currentUser.id, class_name: className }).gte('date', `${year}-${String(month).padStart(2, '0')}-01`).lte('date', new Date(year, month, 0).toISOString().split('T')[0]);
        if (error) { console.error(error); showToast("Failed to delete records.", "error"); }
        else { showToast("Records deleted successfully!"); navigateTo('page-attendance-action-wizard'); }
    }

    async function getAttendanceFromSupabase(className, monthKey) {
        if (!currentUser) return {};
        const [year, month] = monthKey.split('-');
        const { data } = await supabase.from('attendance').select('student_roll_no, date, status').eq('user_id', currentUser.id).eq('class_name', className).gte('date', `${year}-${month}-01`).lte('date', new Date(year, month, 0).toISOString().split('T')[0]);
        const records = {};
        (data || []).forEach(r => {
            if (!records[r.student_roll_no]) records[r.student_roll_no] = {};
            records[r.student_roll_no][new Date(r.date).getUTCDate()] = r.status;
        });
        return records;
    }
    async function saveAttendanceToSupabase(className, monthKey, records) {
        if (!currentUser) return;
        const [year, month] = monthKey.split('-');
        const upsertData = [];
        for (const roll in records) {
            for (const day in records[roll]) {
                const status = records[roll][day];
                if (['P', 'A', 'L'].includes(status)) {
                    upsertData.push({ user_id: currentUser.id, class_name: className, student_roll_no: roll, date: `${year}-${month}-${String(day).padStart(2, '0')}`, status });
                }
            }
        }
        if (upsertData.length === 0) return showToast("No valid data to save.", "info");
        const { error } = await supabase.from('attendance').upsert(upsertData, { onConflict: 'user_id,class_name,student_roll_no,date' });
        if (error) {
            console.error(error);
            showToast("Failed to save attendance.", "error");
        }
        else {
            showToast("Attendance saved to cloud!");
        }
    }
    async function getHolidaysFromSupabase(year, month) {
        if (!currentUser) return [];
        const { data } = await supabase.from('holidays').select('date, name').eq('user_id', currentUser.id).gte('date', `${year}-${String(month + 1).padStart(2, '0')}-01`).lte('date', new Date(year, month + 1, 0).toISOString().split('T')[0]);
        return data || [];
    }
    async function saveHolidayToSupabase(holiday) {
        if (!currentUser) return;
        const { error } = await supabase.from('holidays').upsert({ user_id: currentUser.id, date: holiday.date, name: holiday.name }, { onConflict: 'user_id,date' });
        if (error) { showToast("Failed to save holiday.", "error"); }
        else { showToast("Holiday saved!"); }
    }

    async function getAllAttendanceForStudent(className, rollNo) {
        if (!currentUser) return [];
        const { data, error } = await supabase.from('attendance').select('status').match({ user_id: currentUser.id, class_name: className, student_roll_no: rollNo });
        if (error) { console.error("Error fetching student attendance:", error); showToast("Could not fetch student report.", "error"); return []; }
        return data || [];
    }

    async function getAttendanceSummaryForStudent(className, rollNo) {
        const allRecords = await getAllAttendanceForStudent(className, rollNo);
        if (allRecords.length === 0) {
            return null;
        }
        let presents = 0, absents = 0, leaves = 0;
        allRecords.forEach(record => {
            if (record.status === 'P') presents++;
            else if (record.status === 'A') absents++;
            else if (record.status === 'L') leaves++;
        });
        const totalForPercent = presents + absents;
        const percentage = totalForPercent > 0 ? ((presents / totalForPercent) * 100).toFixed(0) : 0;
        return { presents, absents, leaves, percentage };
    }

    window.openStudentReportWizard = async () => {
        const students = await getStudentListFromSupabase(currentAttendanceClass);
        const selectEl = document.getElementById('student-report-select');
        document.getElementById('student-report-results').innerHTML = '<p class="text-gray-500">Select a student and click "Generate Report".</p>';
        if (students.length === 0) {
            selectEl.innerHTML = '<option>No students found in this class.</option>';
            return;
        }
        selectEl.innerHTML = students.map(s => `<option value="${s.roll}">${s.name} (R.No: ${s.roll})</option>`).join('');
        navigateTo('page-attendance-student-report');
    };

    window.generateFullStudentReport = async () => {
        const selectEl = document.getElementById('student-report-select');
        const studentRoll = selectEl.value;
        const studentName = selectEl.options[selectEl.selectedIndex].text;
        const resultsContainer = document.getElementById('student-report-results');

        if (!studentRoll) return showToast("Please select a student.", "error");

        showToast(`Fetching report for ${studentName}...`);
        resultsContainer.innerHTML = '<p class="text-gray-500">Calculating...</p>';
        const summary = await getAttendanceSummaryForStudent(currentAttendanceClass, studentRoll);

        if (!summary) {
            resultsContainer.innerHTML = `<p class="font-semibold text-gray-800">${studentName}</p><p class="text-gray-600 mt-2">No attendance records found.</p>`;
            return;
        }
        resultsContainer.innerHTML = `
            <p class="font-bold text-lg text-gray-800">${studentName}</p>
            <div class="mt-4 space-y-2 text-sm">
                <p><span class="font-semibold text-green-600">Total Presents:</span> ${summary.presents}</p>
                <p><span class="font-semibold text-red-600">Total Absents:</span> ${summary.absents}</p>
                <p><span class="font-semibold text-yellow-600">Total Leaves:</span> ${summary.leaves}</p>
                <hr class="my-2">
                <p class="font-bold text-base"><span class="font-semibold text-indigo-600">Overall Percentage:</span> ${summary.percentage}%</p>
            </div>`;
    };

    window.downloadSheetAsImage = async () => {
        const sheetContainer = document.getElementById('attendance-sheet-display');
        const sheetHeading = document.getElementById('sheet-heading').textContent;
        const filename = `${sheetHeading.replace(/ /g, '-')}.png`;
        showToast("Generating image, please wait...");

        const originalShadow = sheetContainer.style.boxShadow;
        sheetContainer.style.boxShadow = 'none';

        try {
            const canvas = await html2canvas(sheetContainer, { scale: 2, useCORS: true, logging: false });
            sheetContainer.style.boxShadow = originalShadow;
            const imageURL = canvas.toDataURL('image/png');
            const downloadLink = document.createElement('a');
            downloadLink.href = imageURL;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            showToast("Image download started!", "success");
        } catch (error) {
            console.error("Error generating image:", error);
            showToast("Failed to generate image.", "error");
            sheetContainer.style.boxShadow = originalShadow;
        }
    };
	
/**************************************************************************/
    /* STUDENT SHEET DOWNLOADER LOGIC                                         */
    /**************************************************************************/

    window.generateStudentSheetForClass = async (className) => {
        showToast(`Generating sheet for Class ${className}...`, 'info');

        // Fetch students with all required fields for the sheet
        const { data: students, error } = await supabase
            .from('students')
            .select('roll_no, name, fname, contact')
            .eq('user_id', currentUser.id)
            .eq('class_name', className)
            .order('roll_no', { ascending: true });

        if (error) {
            return showToast("Error fetching student data.", "error");
        }
        if (!students || students.length === 0) {
            return showToast(`No students found for Class ${className}.`, "info");
        }

        // Generate the table HTML using the helper function
        const sheetHTML = generateStudentSheetHTML(students, `Student List - Class ${className}`, false);

        // Display the generated sheet in the preview area
        document.getElementById('student-sheet-display-area').innerHTML = sheetHTML;
        document.getElementById('student-sheet-heading').textContent = `Preview for Class ${className} Student List`;
        navigateTo('page-student-sheets-preview');
    };

    window.generateAllStudentSheets = async () => {
        showToast('Fetching all student data...', 'info');

        // Fetch all students, ordering by class then roll number
        const { data: allStudents, error } = await supabase
            .from('students')
            .select('class_name, roll_no, name, fname, contact')
            .eq('user_id', currentUser.id)
            .order('class_name')
            .order('roll_no');

        if (error) {
            return showToast('Error fetching student data.', 'error');
        }
        if (!allStudents || allStudents.length === 0) {
            return showToast('No students found across all classes.', 'info');
        }

        // Generate a single, collective table. The 'true' flag adds the 'Class' column.
        const sheetHTML = generateStudentSheetHTML(allStudents, 'Complete Student List (All Classes)', true);

        document.getElementById('student-sheet-display-area').innerHTML = sheetHTML;
        document.getElementById('student-sheet-heading').textContent = `Preview for All Student Lists`;
        navigateTo('page-student-sheets-preview');
    };


    const generateStudentSheetHTML = (students, captionText, showClassColumn) => {
        const headerHtml = `<header class="academy-header">
    <img src="https://i.postimg.cc/Dzz5bbVt/Picture1.jpg?v=${new Date().getTime()}" alt="Logo" crossorigin="anonymous">
        <div>
            <div class="academy-name">The I.L.M.I Academy Science & Commerce</div>
            <div class="academy-address">Kahna Nau, Lahore</div>
        </div>
    </header>`;

        const tableRows = students.map((student, index) => `
        <tr class="border-b">
            <td class="px-4 py-3">${index + 1}</td>
            ${showClassColumn ? `<td class="px-4 py-3 font-semibold">${student.class_name}</td>` : ''}
            <td class="px-4 py-3">${student.roll_no || '-'}</td>
            <td class="px-4 py-3 font-medium">${student.name || '-'}</td>
            <td class="px-4 py-3">${student.fname || '-'}</td>
            <td class="px-4 py-3">${student.contact || '-'}</td>
        </tr>
    `).join('');

        return `${headerHtml}
        <table class="full-report-table">
            <caption>${captionText}</caption>
            <thead>
                <tr>
                    <th>Sr. No.</th>
                    ${showClassColumn ? '<th>Class</th>' : ''}
                    <th>Roll Number</th>
                    <th class="student-name-col">Full Name</th>
                    <th>Father Name</th>
                    <th>Contact Number</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>`;
    };

    window.downloadStudentSheetImage = () => {
        const sheetContainer = document.getElementById('student-sheet-display-area');
        const heading = document.getElementById('student-sheet-heading').textContent;
        const filename = `${heading.replace(/ /g, '_')}.html`;

        // Create a full HTML document structure for the download
        const fullHtml = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>${heading}</title>
            <script src="https://cdn.tailwindcss.com"><\/script>
            <style>
                body { font-family: 'Inter', sans-serif; }
                .full-report-container { background: white; padding: 1rem; margin: 1rem auto; border-radius: 0.5rem; max-width: 1200px; }
                .full-report-table { width: 100%; border-collapse: collapse; font-size: 11px; }
                .full-report-table caption { font-size: 1.5rem; font-weight: bold; padding-bottom: 1rem; text-align: left; }
                .full-report-table th, .full-report-table td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: center; }
                .full-report-table thead th { background-color: #f3f4f6; }
                .full-report-table tbody tr:nth-child(even) { background-color: #f9fafb; }
                .full-report-table .student-name-col { text-align: left; font-weight: 600; color: #111827; } /* Corrected styling */
                .academy-header { text-align: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 1.25rem; }
                .academy-header img { width: 60px; height: 60px; border-radius: 50%; }
                .academy-name { font-size: 24px; font-weight: 700; color: #111827; }
                .academy-address { font-size: 13px; color: #52525b; }
            </style>
        </head>
        <body>
            ${sheetContainer.innerHTML}
        </body>
        </html>
    `;

        const blob = new Blob([fullHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("HTML file download started!", "success");
    };

    /**************************************************************************/
    /* STUDENT REGISTRATION LOGIC                                             */
    /**************************************************************************/
    const initializeStudentRegistration = () => {
        const classSelect = document.getElementById('reg-class-select');
        classSelect.innerHTML = '<option value="">-- Select a Class --</option>';
        Object.keys(registrationData.classes).forEach(className => {
            classSelect.innerHTML += `<option value="${className}">${className}</option>`;
        });
        resetRegistrationForm();
    };

    window.populateClassTypeDropdown = () => {
        const classSelect = document.getElementById('reg-class-select');
        const classTypeWrapper = document.getElementById('reg-class-type-wrapper');
        const classTypeSelect = document.getElementById('reg-class-type-select');

        const selectedClass = classSelect.value;
        resetRegistrationForm(2); // Reset from step 2 onwards

        if (!selectedClass) {
            classTypeWrapper.classList.add('hidden');
            return;
        }

        const classTypes = Object.keys(registrationData.classes[selectedClass]);
        classTypeSelect.innerHTML = '<option value="">-- Select a Type --</option>';
        classTypes.forEach(type => {
            classTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
        });
        classTypeWrapper.classList.remove('hidden');
    };

    window.populateSubgroupDropdown = () => {
        const classSelect = document.getElementById('reg-class-select').value;
        const classTypeSelect = document.getElementById('reg-class-type-select').value;
        const subgroupWrapper = document.getElementById('reg-subgroup-wrapper');
        const subgroupSelect = document.getElementById('reg-subgroup-select');

        resetRegistrationForm(3); // Reset from step 3 onwards

        if (!classTypeSelect) {
            subgroupWrapper.classList.add('hidden');
            return;
        }

        const classTypeData = registrationData.classes[classSelect][classTypeSelect];
        const subgroups = classTypeData.subgroups ? Object.keys(classTypeData.subgroups) : null;

        if (subgroups && subgroups.length > 1) {
            subgroupSelect.innerHTML = '<option value="">-- Select a Subgroup --</option>';
            subgroups.forEach(group => {
                subgroupSelect.innerHTML += `<option value="${group}">${group}</option>`;
            });
            subgroupWrapper.classList.remove('hidden');
        } else {
            subgroupWrapper.classList.add('hidden');
            displaySubjects(); // Auto-display if no subgroups or only one
        }
    };

    window.displaySubjects = () => {
        const classSelect = document.getElementById('reg-class-select').value;
        const classTypeSelect = document.getElementById('reg-class-type-select').value;
        const subgroupSelect = document.getElementById('reg-subgroup-select').value;
        const subjectsWrapper = document.getElementById('reg-subjects-wrapper');
        const subjectsDisplay = document.getElementById('reg-subjects-display');
        const studentInfoForm = document.getElementById('reg-student-info-form');
        const submitBtn = document.getElementById('reg-submit-btn');
        const submitAddNewBtn = document.getElementById('reg-submit-add-new-btn');

        resetRegistrationForm(4);

        if (!classTypeSelect) return;

        const classTypeData = registrationData.classes[classSelect][classTypeSelect];
        let subjects = [];

        if (classTypeData.subgroups) {
            const subgroupKeys = Object.keys(classTypeData.subgroups);
            const selectedSubgroup = subgroupKeys.length > 1 ? subgroupSelect : subgroupKeys[0];
            if (selectedSubgroup) {
                subjects = classTypeData.subgroups[selectedSubgroup];
            }
        }

        if (subjects && subjects.length > 0) {
            subjectsDisplay.innerHTML = subjects.map(subject => {
                const colors = ['bg-blue-100 text-blue-800', 'bg-green-100 text-green-800', 'bg-purple-100 text-purple-800', 'bg-yellow-100 text-yellow-800', 'bg-pink-100 text-pink-800'];
                const colorClass = colors[Math.floor(Math.random() * colors.length)];
                return `<span class="subject-tag ${colorClass}">${subject}</span>`;
            }).join('');
            subjectsWrapper.classList.remove('hidden');
            studentInfoForm.classList.remove('hidden');
            submitBtn.disabled = false;
            submitAddNewBtn.disabled = false;
        }
    };

    const resetRegistrationForm = (step = 1) => {
        if (step <= 1) { document.getElementById('reg-class-select').value = ''; }
        if (step <= 2) {
            document.getElementById('reg-class-type-select').innerHTML = '';
            document.getElementById('reg-class-type-wrapper').classList.add('hidden');
        }
        if (step <= 3) {
            document.getElementById('reg-subgroup-select').innerHTML = '';
            document.getElementById('reg-subgroup-wrapper').classList.add('hidden');
        }
        if (step <= 4) {
            document.getElementById('reg-subjects-display').innerHTML = '';
            document.getElementById('reg-subjects-wrapper').classList.add('hidden');
            document.getElementById('reg-student-info-form').classList.add('hidden');
            document.getElementById('reg-submit-btn').disabled = true;
            document.getElementById('reg-submit-add-new-btn').disabled = true;
            clearStudentInfoForm();
        }
    };

    const clearStudentInfoForm = () => {
        document.getElementById('reg-student-name').value = '';
        document.getElementById('reg-father-name').value = '';
        document.getElementById('reg-roll-number').value = '';
        document.getElementById('reg-dob').value = '';
        document.getElementById('reg-contact-number').value = '';
    }

    async function registerStudent() {
        if (!currentUser) {
            showToast("You must be logged in to register students.", "error");
            return { success: false };
        }

        const studentName = document.getElementById('reg-student-name').value.trim();
        const fatherName = document.getElementById('reg-father-name').value.trim();
        const rollNo = document.getElementById('reg-roll-number').value.trim();
        const selectedClass = document.getElementById('reg-class-select').value;
        const selectedClassType = document.getElementById('reg-class-type-select').value;
        const subgroupSelect = document.getElementById('reg-subgroup-select');
        const selectedSubgroup = subgroupSelect.parentElement.classList.contains('hidden') ? Object.keys(registrationData.classes[selectedClass][selectedClassType].subgroups)[0] : subgroupSelect.value;

        if (!studentName || !fatherName || !rollNo || !selectedClass || !selectedClassType || !selectedSubgroup) {
            showToast("All required fields must be filled.", "error");
            return { success: false };
        }

        const subjects = Array.from(document.querySelectorAll('#reg-subjects-display .subject-tag')).map(tag => tag.textContent);

        const studentPayload = {
            user_id: currentUser.id,
            name: studentName,
            fname: fatherName,
            roll_no: rollNo,
            class_name: selectedClass,
            class_type: selectedClassType,
            subgroup: selectedSubgroup,
            subjects: subjects,
            gender: document.getElementById('reg-gender-select').value,
            dob: document.getElementById('reg-dob').value || null,
            contact: document.getElementById('reg-contact-number').value.trim() || null
        };

        showToast("Registering student...", "info");
        const { error } = await supabase.from('students').insert([studentPayload]);

        if (error) {
            console.error("Registration error:", error);
            if (error.message.includes('unique constraint')) { // Simplified check
                showToast(`Error: A student with Roll No. ${rollNo} already exists in Class ${selectedClass}.`, "error");
            } else {
                showToast(`Error: ${error.message}`, "error");
            }
            return { success: false };
        } else {
            showToast("✅ Student registered successfully!", "success");
            return { success: true };
        }
    }

    window.handleRegistrationSubmit = async () => {
        const { success } = await registerStudent();
        if (success) {
            resetRegistrationForm();
        }
    };

    window.handleRegistrationAndAddNew = async () => {
        const { success } = await registerStudent();
        if (success) {
            clearStudentInfoForm();
            document.getElementById('reg-student-name').focus();
        }
    };

	// 1. Initialization and Data Fetch
	window.initializeStudentManagement = async () => {
		if (!currentUser) {
			return showToast("Please log in to manage students.", "error");
		}
		showToast("Fetching all student records...", 'info');
		
		// Fetch ALL students for the current user
		const { data, error } = await supabase.from('students')
			.select('*')
			.eq('user_id', currentUser.id)
			.order('class_name')
			.order('roll_no');

		if (error) {
			console.error("Error fetching all students:", error);
			return showToast("Failed to load student data.", "error");
		}

		allStudentsCache = data || [];
		filteredStudents = [...allStudentsCache];
		
		populateClassFilter();
		renderStudentsList(filteredStudents);
		showToast(`Loaded ${allStudentsCache.length} students.`, 'success');
		
		// --- 1. Fetch User Emails (For Audit Log Display) ---
		// Fetch all user emails to map UUIDs to human-readable names/emails
		// This is run only for Admin/Editor roles as they manage other users/audit logs
		if (currentUserRole === 'admin' || currentUserRole === 'editor') {
			const { data: userData } = await supabase.from('user_roles').select('user_id, email');
			if (userData) {
				userEmailMap = new Map(userData.map(u => [u.user_id, u.email]));
			}
		}	
	};

	// Helper function to populate the class dropdown filter
	const populateClassFilter = () => {
		const filterSelect = document.getElementById('mgmt-class-filter');
		const uniqueClasses = ['All', ...new Set(allStudentsCache.map(s => s.class_name))].sort();
		
		filterSelect.innerHTML = uniqueClasses.map(c => 
			`<option value="${c}">${c}</option>`
		).join('');
	};

	// REPLACE THE ENTIRE FUNCTION WITH THIS
	const renderStudentsList = (students) => {
		const tableBody = document.getElementById('student-management-table-body');
		if (students.length === 0) {
			tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No students match the current filter.</td></tr>`;
			return;
		}

		const classOptions = Object.keys(registrationData.classes).map(c => `<option value="${c}">${c}</option>`).join('');

		tableBody.innerHTML = students.map((student, index) => {
			const uniqueId = `student-row-${student.id}`;
			const classTypeOptions = student.class_name ? Object.keys(registrationData.classes[student.class_name] || {}).map(ct => `<option value="${ct}" ${student.class_type === ct ? 'selected' : ''}>${ct}</option>`).join('') : '';
			const subgroupOptions = student.class_name && student.class_type ? Object.keys(registrationData.classes[student.class_name]?.[student.class_type]?.subgroups || {}).map(sg => `<option value="${sg}" ${student.subgroup === sg ? 'selected' : ''}>${sg}</option>`).join('') : '';

			return `
				<tr id="${uniqueId}" data-id="${student.id}" class="border-b hover:bg-gray-50 align-top">
					<td class="px-2 py-3 text-center">${index + 1}</td>
					<td class="px-2 py-3">
						<label class="text-xs font-semibold">Name</label>
						<input type="text" class="w-full p-1 border rounded-md name-input" value="${student.name}">
						<label class="text-xs font-semibold mt-1 block">Father's Name</label>
						<input type="text" class="w-full p-1 border rounded-md fname-input" value="${student.fname}">
					</td>
					<td class="px-2 py-3">
						<label class="text-xs font-semibold">Roll No.</label>
						<input type="text" class="w-full p-1 border rounded-md roll-input" value="${student.roll_no}">
						<label class="text-xs font-semibold mt-1 block">Contact</label>
						<input type="text" class="w-full p-1 border rounded-md contact-input" value="${student.contact || ''}">
					</td>
					<td class="px-2 py-3">
						<label class="text-xs font-semibold">Class</label>
						<select class="w-full p-1 border rounded-md class-select" onchange="updateRowHierarchies(this)">
							${classOptions.replace(`value="${student.class_name}"`, `value="${student.class_name}" selected`)}
						</select>
					</td>
					<td class="px-2 py-3">
						<label class="text-xs font-semibold">Stream</label>
						<select class="w-full p-1 border rounded-md stream-select" onchange="updateRowHierarchies(this)">
							${classTypeOptions}
						</select>
					</td>
					<td class="px-2 py-3">
						<label class="text-xs font-semibold">Group</label>
						<select class="w-full p-1 border rounded-md group-select">
							${subgroupOptions}
						</select>
					</td>
					<td class="px-2 py-3 text-center">
						<button onclick="deleteStudent(${student.id}, '${student.name}')" class="btn btn-danger !p-1 text-xs mt-4">🗑️</button>
					</td>
				</tr>
			`;
		}).join('');
	};

	// 3. Filtering Logic
	window.filterStudentsList = () => {
		const classFilter = document.getElementById('mgmt-class-filter').value;
		const searchFilter = document.getElementById('mgmt-search-filter').value.toLowerCase();
		
		filteredStudents = allStudentsCache.filter(student => {
			const classMatch = classFilter === 'All' || student.class_name === classFilter;
			
			const searchMatch = !searchFilter || 
				student.name.toLowerCase().includes(searchFilter) ||
				student.roll_no.toString().includes(searchFilter);
				
			return classMatch && searchMatch;
		});

		renderStudentsList(filteredStudents);
	};

	// 4. CRUD Logic
	window.deleteStudent = async (studentId, studentName) => {
		if (!confirm(`Are you sure you want to permanently delete ${studentName}? This cannot be undone.`)) return;
		
		showToast(`Deleting ${studentName}...`, 'danger');
		
		// RLS must allow DELETE based on user_id
		const { error } = await supabase.from('students').delete().eq('id', studentId);
		
		if (error) {
			console.error("Delete error:", error);
			return showToast("Failed to delete student. Check RLS policy.", 'error');
		}
		
		showToast(`${studentName} deleted successfully.`, 'success');
		
		// Remove from cache and re-render
		allStudentsCache = allStudentsCache.filter(s => s.id !== studentId);
		filterStudentsList(); 
	};

	// REPLACE THE ENTIRE FUNCTION WITH THIS CORRECTED VERSION
	window.saveAllStudentChanges = async () => {
		showToast("Collecting changes...", 'info');
		const changesToUpsert = [];
		let hasError = false;

		document.querySelectorAll('#student-management-table-body tr').forEach(row => {
			if(hasError) return;

			const id = parseInt(row.dataset.id); // We still need the ID to find the original data
			const originalStudent = allStudentsCache.find(s => s.id === id);
			if (!originalStudent) return;

			// Collect new values from the form
			const newName = row.querySelector('.name-input').value.trim();
			const newFname = row.querySelector('.fname-input').value.trim();
			const newRollNo = row.querySelector('.roll-input').value.trim();
			const newContact = row.querySelector('.contact-input').value.trim() || null;
			const newClassName = row.querySelector('.class-select').value;
			const newStream = row.querySelector('.stream-select').value;
			const newGroup = row.querySelector('.group-select').value;

			if(!newName || !newRollNo || !newClassName || !newStream || !newGroup) {
				showToast(`Error: Missing required fields for student "${originalStudent.name}".`, 'error');
				hasError = true;
				return;
			}
			
			const newSubjects = registrationData.classes[newClassName]?.[newStream]?.subgroups?.[newGroup] || [];

			// *** THE FIX IS HERE: 'id' is REMOVED from the payload ***
			const payload = {
				// id: originalStudent.id, <-- REMOVED THIS LINE
				name: newName,
				fname: newFname,
				roll_no: newRollNo,
				contact: newContact,
				class_name: newClassName,
				class_type: newStream,
				subgroup: newGroup,
				subjects: newSubjects,
				user_id: currentUser.id // Ensure user_id is included for RLS and onConflict
			};
			changesToUpsert.push(payload);
		});

		if(hasError) return;
		if (changesToUpsert.length === 0) return showToast("No changes detected to save.", "info");

		showToast(`Saving ${changesToUpsert.length} records... This will override duplicates.`, 'primary');
		
		// The 'onConflict' option tells Supabase to find the row to update
		// based *only* on these columns, now that 'id' is not sent.
		const { error } = await supabase.from('students').upsert(changesToUpsert, {
			onConflict: 'user_id,class_name,roll_no' 
		});

		if (error) {
			console.error("Save error:", error); // Log the full error
			// Check for specific Supabase error codes if needed
			if (error.code === '42501') { // RLS violation code
				 return showToast("Save failed: Permission denied. Check RLS policies.", 'error');
			}
			return showToast(`Failed to save changes: ${error.message}`, 'error');
		}

		showToast("All changes saved successfully!", 'success');
		initializeStudentManagement(); // Refresh the list
	};
    /**************************************************************************/
    /* ANALYTICS LOGIC                                                        */
    /**************************************************************************/

    const initializeAnalyticsDashboard = () => {
        populateClassSelect('analytics-class-select', false);
        document.getElementById('analytics-content').classList.add('hidden');
        document.getElementById('analytics-no-data').classList.remove('hidden');
    };

    window.populateAnalyticsTermDropdown = async () => {
        const className = document.getElementById('analytics-class-select').value;
        const stream = document.getElementById('analytics-stream-select').value;
        const group = document.getElementById('analytics-group-select').value;
        const termSelect = document.getElementById('analytics-term-select');

        termSelect.innerHTML = '<option value="">-- Loading... --</option>';
        termSelect.disabled = true;
        if (!className || !stream || !group) return;

        const { data, error } = await supabase.from('results').select('term').eq('user_id', currentUser.id).eq('class_name', className);
        if (error) return showToast("Could not fetch terms.", "error");

        const uniqueTerms = [...new Set(data.map(item => item.term))];
        if (uniqueTerms.length > 0) {
            termSelect.innerHTML = '<option value="">-- Choose a Term --</option>' + uniqueTerms.map(term => `<option value="${term}">${term}</option>`).join('');
            termSelect.disabled = false;
        } else {
            termSelect.innerHTML = '<option value="">No results found</option>';
        }
    };

    window.runAnalytics = async () => {
        const className = document.getElementById('analytics-class-select').value;
        const stream = document.getElementById('analytics-stream-select').value;
        const group = document.getElementById('analytics-group-select').value;
        const term = document.getElementById('analytics-term-select').value;
        const includeAttendance = document.getElementById('analytics-include-attendance').checked;
        if (!className || !stream || !group || !term) return showToast("Please select all filters and a term.", "error");

        showToast("Running analysis...", "info");

        let studentQuery = supabase.from('students').select('*').eq('user_id', currentUser.id).eq('class_name', className);
        if (stream !== 'all') studentQuery = studentQuery.eq('class_type', stream);
        if (group !== 'all') studentQuery = studentQuery.eq('subgroup', group);

        const { data: students, error: studentError } = await studentQuery;
        if (studentError || !students || students.length === 0) {
            document.getElementById('analytics-content').classList.add('hidden');
            document.getElementById('analytics-no-data').classList.remove('hidden');
            return showToast("No students found for this selection.", "info");
        }

        const studentRolls = students.map(s => s.roll_no);
        const { data: resultsData, error } = await supabase.from('results').select('student_roll_no, marks_data').eq('user_id', currentUser.id).eq('class_name', className).eq('term', term).in('student_roll_no', studentRolls);

        if (error || !resultsData || resultsData.length === 0) {
            document.getElementById('analytics-content').classList.add('hidden');
            document.getElementById('analytics-no-data').classList.remove('hidden');
            return showToast("No result data found for this selection.", "info");
        }

        const subjectStats = {};
        const relevantSubjects = [...new Set(students.flatMap(s => s.subjects))];

        relevantSubjects.forEach(subjectName => {
            const firstMark = resultsData.flatMap(r => r.marks_data).find(m => m.name === subjectName);
            subjectStats[subjectName] = { scores: [], totalPossible: firstMark ? firstMark.total : 100, highest: 0, lowest: firstMark ? firstMark.total : 100, passed: 0, failed: 0 };
        });

        resultsData.forEach(result => {
            result.marks_data.forEach(mark => {
                if (subjectStats[mark.name]) {
                    const stats = subjectStats[mark.name];
                    stats.scores.push(mark.obtained);
                    if (mark.obtained > stats.highest) stats.highest = mark.obtained;
                    if (mark.obtained < stats.lowest) stats.lowest = mark.obtained;
                    if (mark.obtained >= mark.total * 0.40) stats.passed++; else stats.failed++;
                }
            });
        });

        Object.keys(subjectStats).forEach(name => {
            const stats = subjectStats[name];
            if (stats.scores.length > 0) {
                stats.average = stats.scores.reduce((a, b) => a + b, 0) / stats.scores.length;
            } else {
                stats.average = 0;
                stats.lowest = 0;
            }
        });

        if (includeAttendance) {
            const attendanceSummaries = await Promise.all(studentRolls.map(roll => getAttendanceSummaryForStudent(className, roll)));
            const validSummaries = attendanceSummaries.filter(s => s);
            const classAvgAttendance = validSummaries.length > 0 ? validSummaries.reduce((acc, s) => acc + parseFloat(s.percentage), 0) / validSummaries.length : 0;
            Object.values(subjectStats).forEach(stats => { stats.avgAttendance = classAvgAttendance; });
        }

        document.getElementById('analytics-no-data').classList.add('hidden');
        document.getElementById('analytics-content').classList.remove('hidden');
        renderAnalyticsCharts(subjectStats);
        renderSubjectRankings(subjectStats);
        renderSummaryTable(subjectStats, includeAttendance);
        document.getElementById('analytics-report-info').innerHTML = `<h2 class="text-xl font-bold">Analysis for ${className} > ${stream} > ${group} - Term: ${term}</h2><p class="text-sm text-gray-500">Generated on: ${new Date().toLocaleString('en-GB')}</p>`;
    };

    const renderAnalyticsCharts = (subjectStats) => {
        const labels = Object.keys(subjectStats).filter(key => subjectStats[key].scores.length > 0);
        const avgScores = labels.map(label => (subjectStats[label].average / subjectStats[label].totalPossible * 100).toFixed(2));
        const avgCtx = document.getElementById('subject-avg-chart').getContext('2d');
        if (analyticsChartAvg) analyticsChartAvg.destroy();
        analyticsChartAvg = new Chart(avgCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Performance (%)',
                    data: avgScores,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true, max: 100 } }, responsive: true }
        });
        let excellent = 0, good = 0, average = 0, poor = 0;
        Object.values(subjectStats).forEach(stats => {
            if (stats.scores.length === 0) return;
            const avgPercent = stats.average / stats.totalPossible * 100;
            if (avgPercent >= 80) excellent++;
            else if (avgPercent >= 60) good++;
            else if (avgPercent >= 40) average++;
            else poor++;
        });
        const distCtx = document.getElementById('performance-dist-chart').getContext('2d');
        if (analyticsChartDist) analyticsChartDist.destroy();
        analyticsChartDist = new Chart(distCtx, {
            type: 'pie',
            data: {
                labels: ['Excellent (80%+)', 'Good (60-79%)', 'Average (40-59%)', 'Poor (<40%)'],
                datasets: [{
                    data: [excellent, good, average, poor],
                    backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444']
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' } } }
        });
    };

    const renderSubjectRankings = (subjectStats) => {
        const listContainer = document.getElementById('subject-ranking-list');
        const sortedSubjects = Object.entries(subjectStats).sort(([, a], [, b]) => b.average - a.average);
        listContainer.innerHTML = sortedSubjects.map(([name, stats], index) => {
            const percentage = (stats.totalPossible > 0 && stats.scores.length > 0) ? (stats.average / stats.totalPossible * 100) : 0;
            let rankClass = 'bg-gray-100', rankEmoji = '';
            if (index === 0) { rankClass = 'subject-rank-1'; rankEmoji = '🥇'; }
            else if (index === 1) { rankClass = 'subject-rank-2'; rankEmoji = '🥈'; }
            else if (index === 2) { rankClass = 'subject-rank-3'; rankEmoji = '🥉'; }
            else if (percentage < 40 && percentage > 0) { rankClass = 'subject-rank-weak'; }
            return `<div class="p-4 rounded-lg flex justify-between items-center ${rankClass}">
                <div>
                    <span class="font-bold text-lg">${rankEmoji} ${index + 1}. ${name}</span>
                    ${(percentage < 40 && stats.scores.length > 0) ? '<span class="ml-2 text-xs font-bold p-1 rounded bg-white/50">⚠️ Needs Improvement</span>' : ''}
                </div>
                <div class="text-right">
                    ${stats.scores.length > 0 ? `<p class="font-bold text-xl">${percentage.toFixed(1)}%</p><p class="text-xs">Avg. ${stats.average.toFixed(1)} / ${stats.totalPossible}</p>` : `<p class="font-bold text-sm">No Data</p>`}
                </div>
            </div>`;
        }).join('');
    };

    const renderSummaryTable = (subjectStats, includeAttendance) => {
        const tableBody = document.getElementById('analytics-summary-table');
        tableBody.innerHTML = Object.entries(subjectStats).map(([name, stats]) => `
            <tr class="border-b">
                <td class="px-4 py-3 font-medium">${name}</td>
                <td class="px-4 py-3">${stats.scores.length > 0 ? (stats.average / stats.totalPossible * 100).toFixed(1) + '%' : 'N/A'}</td>
                <td class="px-4 py-3 text-green-600 font-semibold">${stats.scores.length > 0 ? stats.highest : 'N/A'}</td>
                <td class="px-4 py-3 text-red-600 font-semibold">${stats.scores.length > 0 ? stats.lowest : 'N/A'}</td>
                <td class="px-4 py-3">${stats.passed}</td>
                <td class="px-4 py-3">${stats.failed}</td>
                <td class="px-4 py-3 attendance-col ${includeAttendance ? '' : 'hidden'}">${stats.avgAttendance ? stats.avgAttendance.toFixed(1) + '%' : 'N/A'}</td>
            </tr>`).join('');
        document.querySelectorAll('.attendance-col').forEach(el => el.classList.toggle('hidden', !includeAttendance));
    };

    window.downloadAnalytics = async (format) => {
        const exportContainer = document.getElementById('analytics-export-container');
        const header = document.getElementById('analytics-header-export');
        const className = document.getElementById('analytics-class-select').value;
        const term = document.getElementById('analytics-term-select').value;
        const filename = `Analytics_${className}_${term}_${new Date().toISOString().slice(0, 10)}`;

        if (format === 'pdf') return triggerPrint('page-analytics-dashboard', true);

        showToast(`Preparing image download...`, 'info');
        header.classList.remove('hidden');
        const canvas = await html2canvas(exportContainer, { scale: 2, useCORS: true });
        header.classList.add('hidden');

        const imageURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imageURL;
        link.download = `${filename}.png`;
        link.click();
        showToast("Download started!", "success");
    };

    /**************************************************************************/
    /* FEEDBACK SYSTEM LOGIC                                                  */
    /**************************************************************************/

    // This function shows the text input only when "custom" is selected
    window.toggleCustomClassInput = () => {
        const select = document.getElementById('feedback-class-select');
        const customInputWrapper = document.getElementById('custom-class-input-wrapper');
        if (select.value === 'custom') {
            customInputWrapper.classList.remove('hidden');
        } else {
            customInputWrapper.classList.add('hidden');
        }
    };

    const initializeFeedbackSystem = () => {
        populateFeedbackClasses();
        loadFeedback();
        if (feedbackRefreshInterval) clearInterval(feedbackRefreshInterval);
        feedbackRefreshInterval = setInterval(loadFeedback, 30000); // Refresh every 30 seconds
    };

    const populateFeedbackClasses = async () => {
        if (!currentUser) return;
        const { data, error } = await supabase.from('classes').select('id, class_name').eq('user_id', currentUser.id).order('class_name');
        if (error) return showToast("Could not load classes.", "error");

        const classListContainer = document.getElementById('feedback-classes-list');
        const filterClassSelect = document.getElementById('feedback-class-filter');
        const optionsHtml = data.map(c => `<option value="${c.class_name}">${c.class_name}</option>`).join('');

        if (filterClassSelect) filterClassSelect.innerHTML = '<option value="">All Classes</option>' + optionsHtml;

        if (classListContainer) {
            if (data.length > 0) {
                classListContainer.innerHTML = data.map(c => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                        <span class="font-medium text-gray-700">${c.class_name}</span>
                        <button onclick="deleteFeedbackClass(${c.id}, '${c.class_name}')" class="text-red-500 hover:text-red-700 text-xs">🗑️</button>
                    </div>
                `).join('');
            } else {
                classListContainer.innerHTML = '<p class="text-sm text-gray-500 text-center">No classes added yet.</p>';
            }
        }
    };

    // NEW FUNCTION
    window.addFeedbackClass = async () => {
        const classSelect = document.getElementById('feedback-class-select');
        const customInput = document.getElementById('new-class-name');

        let className = '';
        // Check if the user wants to add a custom class or one from the dropdown
        if (classSelect.value === 'custom') {
            className = customInput.value.trim();
        } else {
            className = classSelect.value;
        }

        if (!className) return showToast("Please select a class or enter a custom name.", "error");

        const { data: existing } = await supabase.from('classes').select('id').eq('user_id', currentUser.id).eq('class_name', className);
        if (existing && existing.length > 0) return showToast(`⚠️ Class "${className}" already exists.`, "info");

        const { error } = await supabase.from('classes').insert({ class_name: className, user_id: currentUser.id });
        if (error) {
            showToast(`Failed to add class: ${error.message}`, "error");
        } else {
            showToast(`✅ Class "${className}" added successfully!`, "success");
            customInput.value = '';
            classSelect.value = '';
            document.getElementById('custom-class-input-wrapper').classList.add('hidden');
            populateFeedbackClasses();
        }
    };

    const populateFeedbackSubjectFilter = (feedbackData) => {
        const filterClass = document.getElementById('feedback-class-filter').value;
        const subjectFilter = document.getElementById('feedback-subject-filter');

        let subjects = filterClass
            ? [...new Set(feedbackData.filter(f => f.class === filterClass).map(f => f.subject))]
            : [...new Set(feedbackData.map(f => f.subject))];

        subjectFilter.innerHTML = '<option value="">All Subjects</option>' + subjects.sort().map(s => `<option value="${s}">${s}</option>`).join('');
    };

    window.loadFeedback = async () => {
        if (!currentUser) return;
        const classFilter = document.getElementById('feedback-class-filter').value;
        const subjectFilter = document.getElementById('feedback-subject-filter').value;
        const listContainer = document.getElementById('feedback-list');

        let query = supabase.from('feedback_data').select('*').eq('user_id', currentUser.id);
        if (classFilter) query = query.eq('class', classFilter);
        if (subjectFilter) query = query.eq('subject', subjectFilter);
        query = query.order('timestamp', { ascending: false });

        const { data, error } = await query;
        if (error) return showToast("Could not load feedback.", "error");

        loadedFeedbackData = data;
        // Populate subject filter only if it wasn't the trigger for this load
        const shouldPopulateSubjects = !subjectFilter || document.activeElement !== document.getElementById('feedback-subject-filter');
        if (shouldPopulateSubjects) {
           populateFeedbackSubjectFilter(data);
           // Restore previous subject selection if possible
           if (subjectFilter) document.getElementById('feedback-subject-filter').value = subjectFilter;
        }


        if (data.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-500 p-8">No feedback found for this filter.</p>';
            return;
        }

        const subjectColors = ['#3B82F6', '#10B981', '#8B5CF6', '#EC4899', '#F59E0B', '#6366F1'];
        const getSubjectColor = (subject) => {
            let hash = 0;
            for (let i = 0; i < subject.length; i++) { hash = subject.charCodeAt(i) + ((hash << 5) - hash); }
            return subjectColors[Math.abs(hash % subjectColors.length)];
        };

        listContainer.innerHTML = data.map(item => `
            <div class="feedback-card" style="border-left-color: ${getSubjectColor(item.subject)};">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-gray-800">${item.subject} <span class="text-sm font-medium text-gray-500">- ${item.class}</span></p>
                        <p class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString()}</p>
                    </div>
                    <button onclick="deleteFeedback(${item.id})" class="btn btn-danger !p-2 text-xs">🗑️ Delete</button>
                </div>
                <p class="mt-3 text-gray-700 whitespace-pre-wrap">${item.feedback}</p>
            </div>
        `).join('');
    };

    window.deleteFeedback = async (id) => {
        const { error } = await supabase.from('feedback_data').delete().match({ id: id, user_id: currentUser.id });
        if (error) {
            showToast("Failed to delete feedback.", "error");
        } else {
            showToast("Feedback deleted.", "success");
            loadFeedback();
        }
    };

    window.deleteAllFeedbackForClass = async () => {
        const className = document.getElementById('feedback-class-filter').value;
        if (!className) return showToast("Please select a class to delete feedback from.", "error");

        showToast("Deleting feedback...", "info");

        const { error } = await supabase.from('feedback_data').delete().match({ class: className, user_id: currentUser.id });
        if (error) {
            showToast("Failed to delete feedback.", "error");
        } else {
            showToast(`All feedback for ${className} deleted.`, "success");
            loadFeedback();
        }
    };

    window.exportFeedback = () => {
        if (loadedFeedbackData.length === 0) return showToast("No data to export.", "info");

        const headers = "ID,Class,Subject,Feedback,Timestamp\n";
        const csvContent = loadedFeedbackData.map(row => {
            const feedback = `"${row.feedback.replace(/"/g, '""')}"`; // Handle quotes in feedback
            return [row.id, row.class, row.subject, feedback, new Date(row.timestamp).toISOString()].join(',');
        }).join('\n');

        const blob = new Blob([headers + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `feedback_export_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url); // Clean up the object URL
    };

    // NEW, UPDATED FUNCTION
    window.deleteFeedbackClass = async (id, name) => {
        showToast(`Deleting class ${name}...`, "info");

        // We no longer delete feedback data
        // const { error: feedbackError } = ... (this line is removed)

        const { error: classError } = await supabase.from('classes').delete().eq('id', id);
        if (classError) return showToast("Could not delete class.", "error");

        showToast(`Class "${name}" has been deleted. Feedback is retained.`, "success");
        populateFeedbackClasses();
        loadFeedback();
    };
    /**************************************************************************/
    /* DATA MANAGEMENT LOGIC                                                  */
    /**************************************************************************/

    window.updateStorageInfo = async () => {
        if (!currentUser) return;

        const usageText = document.getElementById('storage-usage-text');
        const progressBar = document.getElementById('storage-progress-bar');
        usageText.textContent = 'Calculating...';
        progressBar.style.width = '0%';

        try {
            let totalBytes = 0;
            const tableEstimates = { // Rough estimates in bytes per row
                students: 1024,
                results: 2048,
                attendance: 256,
                holidays: 128,
                classes: 128,
                feedback_data: 512,
                user_roles: 256, // Added estimate
                teachers: 512, // Added estimate
                teaching_logs: 1024 // Added estimate
            };

            const tablesToCheck = currentUser.email === PERMANENT_ADMIN_EMAIL ? TABLES : USER_DATA_TABLES;

            for (const table of tablesToCheck) {
                let query = supabase.from(table).select('*', { count: 'exact', head: true });
                // Admin sees all, others see only their own
                if (currentUser.email !== PERMANENT_ADMIN_EMAIL) {
                    query = query.eq('user_id', currentUser.id);
                }
                const { count, error } = await query;

                if (!error && count > 0) {
                    totalBytes += count * (tableEstimates[table] || 512); // Use estimate or default
                }
            }

            const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);
            const storageLimitMB = 300; // Your limit
            const percentage = Math.min((totalMB / storageLimitMB) * 100, 100);

            usageText.textContent = `${totalMB} MB`;
            progressBar.style.width = `${percentage}%`;
            document.getElementById('storage-limit-text').textContent = `${storageLimitMB} MB Limit`;


        } catch (error) {
            console.error("Error calculating storage:", error);
            usageText.textContent = 'Error calculating usage';
        }
    };


    // 🟢 REPLACE the old downloadOfflineBackup function with this one

    window.downloadOfflineBackup = async () => {
        if (!currentUser) return showToast("Please log in.", "error");
        showToast("Fetching all data for backup...", 'info');

        try {
            // 👇 START OF NEW LOGIC
            // Decide which list of tables to use based on the user's role.
            let tablesToBackup;
            if (currentUser.email === PERMANENT_ADMIN_EMAIL) {
                // If the user is the admin, back up EVERYTHING.
                tablesToBackup = TABLES;
                showToast("Admin mode: Performing a full system backup.", 'info');
            } else {
                // For regular users, only back up their own data to avoid permission errors.
                tablesToBackup = USER_DATA_TABLES;
            }
            // 👆 END OF NEW LOGIC

            // The rest of the function now uses the correct list of tables.
            const fetchPromises = tablesToBackup.map(table => {
                // For the admin, we fetch all records. For others, only their own.
                let query = supabase.from(table).select('*');
                if (currentUser.email !== PERMANENT_ADMIN_EMAIL && USER_DATA_TABLES.includes(table)) { // Check if it's user data table
                    query = query.eq('user_id', currentUser.id);
                }
                return query;
            });


            const results = await Promise.all(fetchPromises);

            const backupData = {};
            tablesToBackup.forEach((table, index) => {
                const { data, error } = results[index];
                if (error) {
                    // If there's an error fetching a table, we log it but continue.
                    console.warn(`Could not back up table "${table}": ${error.message}`);
                    backupData[table] = []; // Add an empty array for the failed table
                } else {
                    backupData[table] = data;
                }
            });
            backupData.exportedAt = new Date().toISOString();

            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `ilmi_academy_backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Backup downloaded successfully!", "success");


        } catch (error) {
            console.error("Backup failed:", error);
            showToast("Failed to create backup.", "error");
        }
    };

    // 🟢 REPLACE the old handleRestoreFile function with this one

    window.handleRestoreFile = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const restoredData = JSON.parse(e.target.result);
                // Basic validation: Check for at least one expected table and exportedAt
                const expectedTables = currentUser.email === PERMANENT_ADMIN_EMAIL ? TABLES : USER_DATA_TABLES;
                const hasExpectedTable = expectedTables.some(table => restoredData.hasOwnProperty(table));
                if (!hasExpectedTable || !restoredData.exportedAt) {
                     throw new Error("Invalid backup file format or missing data.");
                }


                if (!confirm("Are you sure you want to restore from this file? This will PERMANENTLY overwrite all existing data associated with your account (or the entire system if you are admin).")) {
                    event.target.value = null; // Clear the file input
                    return;
                }

                showToast("Restoring data... Please wait.", 'info');

                let tablesToRestore;
                let tablesToClear;

                // 👇 START OF NEW LOGIC
                if (currentUser.email === PERMANENT_ADMIN_EMAIL) {
                    // --- ADMIN PATH ---
                    showToast("Admin mode: Clearing ALL existing data...", 'info');
                    // 1. Clear ALL tables listed in TABLES (includes user_roles)
                    tablesToClear = TABLES;
                    tablesToRestore = TABLES.filter(table => restoredData.hasOwnProperty(table)); // Only restore tables present in backup

                    for (const table of tablesToClear) {
                        // Use a filter that deletes everything unconditionally for the admin
                        const { error } = await supabase.from(table).delete().neq('id', 0); // Example: delete where id is not 0 (effectively all)
                        if (error) console.warn(`Could not clear table ${table}:`, error.message);
                    }
                    // Re-insert the admin's role if it was cleared
                     const { error: adminRoleError } = await supabase.from('user_roles').upsert({
                         user_id: currentUser.id,
                         email: currentUser.email,
                         role: 'admin'
                     }, { onConflict: 'user_id' }); // Use onConflict to handle if it wasn't deleted
                     if (adminRoleError) console.warn("Failed to ensure admin role exists:", adminRoleError.message);


                } else {
                    // --- REGULAR USER PATH ---
                    showToast("Clearing your old data...", 'info');
                    tablesToClear = USER_DATA_TABLES;
                    tablesToRestore = USER_DATA_TABLES.filter(table => restoredData.hasOwnProperty(table)); // Only restore user tables present in backup

                    for (const table of tablesToClear) {
                        const { error } = await supabase.from(table).delete().eq('user_id', currentUser.id);
                        if (error) throw new Error(`Failed to clear table ${table}: ${error.message}`);
                    }
                }
                // 👆 END OF NEW LOGIC

                showToast("Existing data cleared. Uploading new data...", 'info');

                for (const table of tablesToRestore) {
                    if (restoredData[table] && restoredData[table].length > 0) {
                        // Prepare data for insertion
                        let dataToInsert = restoredData[table].map(record => {
                            const { id, ...rest } = record; // Remove old primary key 'id'
                            // For user data, ensure it's assigned to the current user.
                            if (USER_DATA_TABLES.includes(table)) {
                                return { ...rest, user_id: currentUser.id };
                            }
                            // For user_roles, keep the user_id from the backup (admin restore)
                            return rest;
                        });

                        // Filter out the current admin's role if restoring user_roles as admin
                        if (table === 'user_roles' && currentUser.email === PERMANENT_ADMIN_EMAIL) {
                             dataToInsert = dataToInsert.filter(role => role.user_id !== currentUser.id);
                        }


                        // Use upsert carefully - define onConflict strategy if needed, else insert
                         if (dataToInsert.length > 0) {
                            const { error } = await supabase.from(table).insert(dataToInsert); // Use insert for clean restore

                            if (error) {
                                // Provide more specific error info
                                throw new Error(`Failed to restore ${table}: ${error.message} (Code: ${error.code})`);
                            }
                        }

                    }
                }
                showToast("✅ Data restored successfully! Refreshing...", "success");
                setTimeout(() => window.location.reload(), 1500);

            } catch (error) {
                console.error("Restore failed:", error);
                showToast(`Restore failed: ${error.message}`, "error");
            } finally {
                event.target.value = null; // Clear the file input regardless of outcome
            }
        };
        reader.readAsText(file);
    };

    window.deleteAllCloudData = async () => {
        if (!currentUser || !confirm("Are you absolutely sure you want to delete ALL of your cloud data? This action is permanent and cannot be undone.")) return;

        showToast("Deleting all your cloud data...", 'info');
        try {
            // Delete only from user-specific tables
            const deletePromises = USER_DATA_TABLES.map(table =>
                supabase.from(table).delete().eq('user_id', currentUser.id)
            );
            await Promise.all(deletePromises);
            showToast("All your cloud data has been successfully deleted.", "success");
            updateStorageInfo(); // Refresh storage info
        } catch (error) {
            console.error("Deletion failed:", error);
            showToast("An error occurred during deletion.", "error");
        }
    };

    // UPDATED: Added a helper function here to prevent code duplication
    async function getStudentFromSupabase(className, rollNo) {
        if (!currentUser) return null;
        const { data, error } = await supabase.from('students').select('*').eq('user_id', currentUser.id).eq('class_name', className).eq('roll_no', rollNo).single();
        if (error && error.code !== 'PGRST116') { // Ignore 'No rows found' error
             console.warn("Could not fetch student details:", error.message);
        }
        return data;
    }


	// PASTE THESE THREE NEW FUNCTIONS INTO YOUR SCRIPT TAG

	const initializePrintLogPage = async () => {
		await fetchFacultyList();
		const teacherSelect = document.getElementById('print-log-teacher-select');
		teacherSelect.innerHTML = '<option value="all">All Teachers</option>';
		teacherSelect.innerHTML += facultyListCache.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
		populatePrintLogSubjects();
	};

	const populatePrintLogSubjects = () => {
		const teacherName = document.getElementById('print-log-teacher-select').value;
		const subjectSelect = document.getElementById('print-log-subject-select');
		let allSubjects = new Set();

		if (teacherName === 'all') {
			facultyListCache.forEach(teacher => {
				if (teacher.assigned_subjects) {
					Object.values(teacher.assigned_subjects).forEach(subjects => subjects.forEach(s => allSubjects.add(s)));
				}
			});
		} else {
			const teacher = facultyListCache.find(t => t.name === teacherName);
			if (teacher && teacher.assigned_subjects) {
				 Object.values(teacher.assigned_subjects).forEach(subjects => subjects.forEach(s => allSubjects.add(s)));
			}
		}
		
		subjectSelect.innerHTML = '<option value="all">All Subjects</option>';
		subjectSelect.innerHTML += [...allSubjects].sort().map(s => `<option value="${s}">${s}</option>`).join('');
	};

	// PASTE THIS ENTIRE FUNCTION INSIDE YOUR <script type="module"> TAG

	// REPLACE THE OLD FUNCTION WITH THIS NEW, UPGRADED VERSION
	window.generateAndPrintLogs = async () => {
		const teacherName = document.getElementById('print-log-teacher-select').value;
		const subjectName = document.getElementById('print-log-subject-select').value;
		const startDate = document.getElementById('print-log-date-filter').value;
		const displayArea = document.getElementById('log-print-display-area');

		showToast('Fetching logs for printing...', 'info');

		let query = supabase.from('teaching_logs').select('*').eq('user_id', currentUser.id);
		if (teacherName !== 'all') query = query.eq('teacher_name', teacherName);
		if (subjectName !== 'all') query = query.eq('subject_name', subjectName);
		if (startDate) query = query.gte('week_start_date', startDate);
		query = query.order('week_start_date', { ascending: false }).order('teacher_name');
		
		const { data: logs, error } = await query;

		if (error) return showToast('Failed to fetch logs.', 'error');
		if (!logs || logs.length === 0) {
			displayArea.innerHTML = '<div class="text-center p-12 text-gray-500">No logs found for the selected filters.</div>';
			return showToast('No logs found.', 'info');
		}

		// --- NEW TABLE STRUCTURE ---
		const headerHtml = `<header class="academy-header"><img src="https://i.postimg.cc/Dzz5bbVt/Picture1.jpg" alt="Logo"><div><div class="academy-name">The I.L.M.I Academy</div><div class="academy-address">Teaching Log Report</div></div></header>`;
		
		let tableRowsHtml = '';
		// Loop through each weekly log
		logs.forEach(log => {
			// Loop through each day of the week
			daysOfWeek.forEach(day => {
				const topic = log.weekly_topics[day];
				if (topic) { // Only create a row if a topic was taught
					tableRowsHtml += `
						<tr class="border-b">
							<td class="px-4 py-3">${new Date(log.week_start_date).toLocaleDateString('en-GB')}</td>
							<td class="px-4 py-3">${day}</td>
							<td class="px-4 py-3 font-medium">${log.teacher_name}</td>
							<td class="px-4 py-3">${log.class_name}</td>
							<td class="px-4 py-3">${log.subject_name}</td>
							<td class="px-4 py-3 text-left">${topic}</td>
						</tr>
					`;
				}
			});
		});

		// Build the final table HTML
		const tableHtml = `
			<table class="full-report-table">
				<caption>Teacher Log Report</caption>
				<thead>
					<tr>
						<th>Week Starting</th>
						<th>Day</th>
						<th>Teacher</th>
						<th>Class</th>
						<th>Subject</th>
						<th class="text-left">Topic Covered</th>
					</tr>
				</thead>
				<tbody>
					${tableRowsHtml}
				</tbody>
			</table>
		`;

		// Put the header and the new table into the display area
		displayArea.innerHTML = headerHtml + tableHtml;
		showToast('✅ Report generated. Creating PDF...', 'success');

		// Wait for the browser to render the new HTML, then call our new PDF function
		setTimeout(() => {
			const filename = `Teacher_Logs_${new Date().toLocaleDateString('en-CA')}.pdf`;
			downloadReportAsPDF('log-print-display-area', filename);
		}, 100); // 100ms delay to ensure rendering
	};

    /**************************************************************************/
    /* NEW: ORGANIZATION MANAGEMENT LOGIC                                     */
    /**************************************************************************/

    /**
     * Initializes the Organization Management page.
     * Checks if the user is the permanent admin. If not, shows an access restricted message.
     * If admin, fetches all user roles from the database.
     */
    const orgMgmt_initializePage = async () => {
        const contentDiv = document.getElementById('org-management-content');
        const restrictedDiv = document.getElementById('org-management-restricted');

        if (!currentUser || currentUser.email !== PERMANENT_ADMIN_EMAIL) {
            contentDiv.classList.add('hidden');
            restrictedDiv.classList.remove('hidden');
            return;
        }

        contentDiv.classList.remove('hidden');
        restrictedDiv.classList.add('hidden');

        showToast("Fetching user data...", 'info');
        const { data, error } = await supabase.from('user_roles').select('*').order('created_at', { ascending: false });

        if (error) {
            console.error('Error fetching users:', error);
            showToast("Could not fetch user list.", "error");
            return;
        }

        allUsersCache = data;
        orgMgmt_renderTable(allUsersCache);
    };

    /**
     * Renders the user roles table.
     * @param {Array} users - An array of user objects from the `user_roles` table.
     */
    const orgMgmt_renderTable = (users) => {
        const tableBody = document.getElementById('org-management-table-body');
        if (!users || users.length === 0) { // Added check for undefined users
             tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">No users found.</td></tr>`;
             return;
        }


        tableBody.innerHTML = users.map((user, index) => {
            const isPermanentAdmin = user.email === PERMANENT_ADMIN_EMAIL;
            const joinedDate = new Date(user.created_at).toLocaleDateString('en-GB');

            const roleSelectHTML = `
                <select
                    class="role-select p-2 border rounded-md bg-white w-full"
                    onchange="orgMgmt_updateUserRole('${user.user_id}', '${user.email}', this)"
                    ${isPermanentAdmin ? 'disabled' : ''}>
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                    <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                </select>
            `;

            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3 font-medium">${user.email}</td>
                    <td class="px-4 py-3">
                        <span class="role-tag role-tag-${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span>
                    </td>
                    <td class="px-4 py-3">${joinedDate}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex justify-center gap-2">
                            ${roleSelectHTML}
                            <button
                                class="btn btn-danger !p-2"
                                title="Delete User"
                                onclick="orgMgmt_deleteUser('${user.user_id}', '${user.email}')"
                                ${isPermanentAdmin ? 'disabled' : ''}>
                                🗑️
                            </button>
                            <button
                                class="btn btn-secondary !p-2"
                                title="Reset Password"
                                onclick="orgMgmt_resetUserPassword('${user.email}')"
                                ${isPermanentAdmin ? 'disabled' : ''}>
                                🔄
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    };

    /**
     * Filters the displayed users based on the search input.
     */
    window.orgMgmt_filterUsers = () => {
        const searchTerm = document.getElementById('org-user-search').value.toLowerCase();
        const filteredUsers = allUsersCache.filter(user => user.email.toLowerCase().includes(searchTerm));
        orgMgmt_renderTable(filteredUsers);
    };

    /**
     * Updates a user's role in the database.
     * @param {string} userId - The UUID of the user to update.
     * @param {string} userEmail - The email of the user (for checks).
     * @param {HTMLElement} selectElement - The dropdown select element.
     */
    window.orgMgmt_updateUserRole = async (userId, userEmail, selectElement) => {
        const newRole = selectElement.value;
        if (userEmail === PERMANENT_ADMIN_EMAIL) {
            showToast("Cannot change the permanent admin's role.", "error");
            selectElement.value = 'admin'; // Revert change
            return;
        }

        showToast(`Updating ${userEmail} to ${newRole}...`, 'info');
        const { error } = await supabase
            .from('user_roles')
            .update({ role: newRole })
            .eq('user_id', userId);

        if (error) {
            console.error("Role update error:", error);
            showToast("Failed to update role.", "error");
        } else {
            showToast("User role updated successfully!", "success");
            // Update cache and re-render to show new color tag
            const userInCache = allUsersCache.find(u => u.user_id === userId);
            if (userInCache) userInCache.role = newRole;
            orgMgmt_filterUsers();
        }
    };

    /**
     * Deletes a user from the `auth.users` table via the `user_roles` table cascade.
     * @param {string} userId - The UUID of the user to delete.
     * @param {string} userEmail - The email of the user to delete.
     */
    window.orgMgmt_deleteUser = async (userId, userEmail) => {
        if (userEmail === PERMANENT_ADMIN_EMAIL) {
            showToast("The permanent admin cannot be deleted.", "error");
            return;
        }

        if (!confirm(`Are you sure you want to permanently delete the user: ${userEmail}? This action cannot be undone.`)) {
            return;
        }

        showToast(`Deleting user ${userEmail}...`, 'info');
        // RLS policy on `user_roles` allows admin to delete.
        // The `ON DELETE CASCADE` on the `user_id` foreign key will auto-delete the user from `auth.users`.
        const { error } = await supabase
            .from('user_roles')
            .delete()
            .eq('user_id', userId);

        if (error) {
            console.error("Delete user error:", error);
            showToast("Failed to delete user.", "error");
        } else {
            showToast("User deleted successfully.", "success");
            // Refetch all users to update the list
            orgMgmt_initializePage();
        }
    };

    /**
     * Sends a password reset email to a user.
     * @param {string} userEmail - The email to send the reset link to.
     */
    window.orgMgmt_resetUserPassword = async (userEmail) => {
        if (!confirm(`Send a password reset link to ${userEmail}?`)) {
            return;
        }

        showToast(`Sending reset link to ${userEmail}...`, 'info');
        const { error } = await supabase.auth.resetPasswordForEmail(userEmail, {
            redirectTo: window.location.origin, // Redirect to the app's base URL after reset
        });


        if (error) {
            console.error("Password reset error:", error);
            showToast("Failed to send reset email.", "error");
        } else {
            showToast("Password reset email sent successfully!", "success");
        }
    };

    // --- TEACHER PORTAL STATE & LOGIC ---
    let facultyListCache = [];
    let currentEditingTeacherId = null;

    const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    // Helper to compile all unique options for hierarchy assignment
    const getAllHierarchyOptions = () => {
        let classes = Object.keys(registrationData.classes);
        let subjects = [];

        classes.forEach(className => {
            Object.values(registrationData.classes[className]).forEach(streamData => {
                if (streamData.subgroups) {
                    Object.values(streamData.subgroups).forEach(groupSubjects => {
                        subjects = subjects.concat(groupSubjects);
                    });
                }
            });
        });
        return {
            classes: classes.sort(), // Sort classes alphabetically
            subjects: [...new Set(subjects)].sort() // Sort subjects alphabetically
        };
    };

	// NEW HELPER: Function to dynamically render subject lists for ADD NEW teacher
	window.renderSubjectAssignmentFields = (assignedSubjectsMap = {}) => {
		const classCheckboxes = document.querySelectorAll('#new-teacher-classes-container input[type="checkbox"]');
		const dynamicContainer = document.getElementById('dynamic-subject-containers');
		const allSubjects = getAllHierarchyOptions().subjects;

		let html = '';
		let activeClasses = 0;

		classCheckboxes.forEach(classCheckbox => {
			const className = classCheckbox.value;

			if (classCheckbox.checked) {
				activeClasses++;
				const currentAssignments = assignedSubjectsMap[className] || [];
				
				// Generate a dedicated box for this class's subjects
				html += `
					<div class="sub-block">
						<h4 class="font-bold text-gray-700 mb-3 border-b pb-2">Subjects for ${className}</h4>
						<div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-1">
							${allSubjects.map(subject => `
								<label for="subject-new-${className}-${subject}" class="checkbox-item">
									<input type="checkbox" 
										   id="subject-new-${className}-${subject}" 
										   data-class="${className}" 
										   value="${subject}"
										   ${currentAssignments.includes(subject) ? 'checked' : ''}>
									<span class="text-sm">${subject}</span>
								</label>
							`).join('')}
						</div>
					</div>
				`;
			}
		});

		if (activeClasses === 0) {
			dynamicContainer.innerHTML = '<p class="text-sm text-gray-500 text-center p-4">Select classes above to see subject assignments here.</p>';
		} else {
			dynamicContainer.innerHTML = html;
		}
	}


	// NEW HELPER: For rendering subjects in the EDIT MODAL
	window.renderEditSubjectAssignmentFields = (teacherId, initialAssignmentsMap = {}) => {
		let assignedSubjectsMap = initialAssignmentsMap;
		
		// If not called with a map (i.e., called via onchange), get data from cache
		if (Object.keys(assignedSubjectsMap).length === 0) {
			const teacher = facultyListCache.find(t => t.id === teacherId);
			if (teacher) assignedSubjectsMap = teacher.assigned_subjects || {};
		}

		const classCheckboxes = document.querySelectorAll('#edit-teacher-classes-container input[type="checkbox"]');
		const dynamicContainer = document.getElementById('edit-dynamic-subject-containers');
		const allSubjects = getAllHierarchyOptions().subjects;

		let html = '';
		let activeClasses = 0;

		classCheckboxes.forEach(classCheckbox => {
			const className = classCheckbox.value;

			if (classCheckbox.checked) {
				activeClasses++;
				const currentAssignments = assignedSubjectsMap[className] || [];
				
				html += `
					<div class="sub-block">
						<h4 class="font-bold text-gray-700 mb-3 border-b pb-2">Subjects for ${className}</h4>
						<div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-1">
							${allSubjects.map(subject => `
								<label for="edit-subject-${className}-${subject}" class="checkbox-item">
									<input type="checkbox" 
										   id="edit-subject-${className}-${subject}" 
										   data-class="${className}" 
										   value="${subject}"
										   ${currentAssignments.includes(subject) ? 'checked' : ''}>
									<span class="text-sm">${subject}</span>
								</label>
							`).join('')}
						</div>
					</div>
				`;
			}
		});

		if (activeClasses === 0) {
			dynamicContainer.innerHTML = '<p class="text-sm text-gray-500 text-center p-4">Select classes above to see subject assignments here.</p>';
		} else {
			dynamicContainer.innerHTML = html;
		}
	}

	window.initializeTeacherDashboard = async () => {
		// 1. Fetch and cache the faculty list 
		await fetchFacultyList();

		const selectEl = document.getElementById('log-teacher-select');
		selectEl.innerHTML = facultyListCache.map(t => `<option value="${t.name}" data-id="${t.id}">${t.name}</option>`).join('') ||
			'<option value="">-- No Teachers Added --</option>';

		selectEl.onchange = applySubmissionFilter;

		if (currentPageId === 'page-teacher-faculty-management') {
			renderFacultyListUI();

			const hierarchyOptions = getAllHierarchyOptions();

			const classContainer = document.getElementById('new-teacher-classes-container');
			
			// Render Assigned Classes with the crucial onchange handler
			classContainer.innerHTML = hierarchyOptions.classes.map(c => `
				<label for="class-new-${c}" class="checkbox-item">
					<input type="checkbox" id="class-new-${c}" value="${c}" onchange="renderSubjectAssignmentFields()">
					<span class="text-sm">${c}</span>
				</label>
			`).join('');
			
			// Initial render of the dynamic subject area (shows placeholder initially)
			renderSubjectAssignmentFields();


		} else if (currentPageId === 'page-teacher-log-entry') {
			renderWeeklyLogBody();
			applySubmissionFilter(); // Apply filters based on the selected teacher
		}
	};

    // --- FIND THE EXISTING 'window.fetchFacultyList' FUNCTION AND REPLACE IT WITH THIS DEBUG VERSION ---

    window.fetchFacultyList = async () => {
        if (!currentUser) return [];

        const { data, error } = await supabase.from('teachers')
            .select('id, name, assigned_classes, assigned_subjects')
            .eq('user_id', currentUser.id)
            .order('name');

        if (error) {
            // 🛑 DEBUG HOOK: Display the exact database error message in the toast
            let errorMessage = "DB Error: Could not load faculty list.";
            if (error.message) {
                errorMessage += ` ${error.message.substring(0, 80)}`; // Show first 80 chars of the message
            } else if (error.details) {
                errorMessage += ` ${error.details.substring(0, 80)}`;
            }

            showToast(errorMessage, "error");
            console.error("DB Error fetching faculty:", error);

            // This is where the function was hanging. We'll add debug toast and return empty array.
            facultyListCache = []; // Ensure cache is empty on error
            return [];
        }

        // Original logic continues:
        facultyListCache = data || []; // Ensure cache is an array even if data is null
        return facultyListCache;
    };


    // --- Faculty Management ---

	window.addTeacherWithHierarchy = async () => {
		const name = document.getElementById('new-teacher-name').value.trim();

		// 1. Collect the Class-Specific Subject Map
		const assignedSubjectsMap = {};
		const classCheckboxes = document.querySelectorAll('#new-teacher-classes-container input[type="checkbox"]:checked');
		
		// Check if any classes were selected
		if (classCheckboxes.length === 0) {
			return showToast("Please select at least one class taught.", "error");
		}

		let totalSubjectsAssigned = 0;
		
		// Iterate over selected classes and collect their associated subjects
		classCheckboxes.forEach(classCheckbox => {
			const className = classCheckbox.value;
			const selectedSubjects = Array.from(
				document.querySelectorAll(`#dynamic-subject-containers input[data-class="${className}"]:checked`)
			).map(cb => cb.value);

			if (selectedSubjects.length > 0) {
				assignedSubjectsMap[className] = selectedSubjects;
				totalSubjectsAssigned += selectedSubjects.length;
			}
		});
		
		// 2. Validate Assignment
		if (totalSubjectsAssigned === 0) {
			return showToast("Please assign at least one subject to a selected class.", "error");
		}
		
		if (!name) return showToast("Please enter a teacher's name.", "error");

		const exists = facultyListCache.some(t => t.name === name);
		if (exists) return showToast("Teacher already exists.", "info");

		showToast("Adding teacher and saving hierarchy...", 'info');

		// 3. INSERT the new, structured data
		const { error } = await supabase.from('teachers').insert({
			name: name,
			user_id: currentUser.id,
			assigned_classes: Object.keys(assignedSubjectsMap), // Class list (used for filters)
			assigned_subjects: assignedSubjectsMap // JSONB Map (the actual assignments)
		});

		if (error) {
			console.error("DB Error on Add Teacher:", error);
			return showToast("Failed to add teacher. (Check RLS and DB column types)", "error");
		}

		// 4. Clear and refresh UI on success
		document.getElementById('new-teacher-name').value = '';
		document.querySelectorAll('#new-teacher-classes-container input[type="checkbox"]').forEach(cb => cb.checked = false);
		renderSubjectAssignmentFields(); // Clears the dynamic subject area

		await fetchFacultyList();
		renderFacultyListUI();
		showToast(`${name} added with class-specific hierarchy successfully!`, "success");
	};

    window.deleteTeacher = async (id, name) => {
        if (!confirm(`Are you sure you want to delete ${name}? This will not delete saved teaching logs.`)) return;

        const { error } = await supabase.from('teachers').delete().eq('id', id);
        if (error) {
            return showToast("Failed to delete teacher.", "error");
        }

        await fetchFacultyList();
        renderFacultyListUI();
        showToast(`${name} deleted.`, "success");
    };

	window.renderFacultyListUI = () => {
		const container = document.getElementById('faculty-list-container');
		container.innerHTML = facultyListCache.map(t => {
			const assignedClassesArray = t.assigned_classes || [];
			const assignedSubjectsMap = t.assigned_subjects || {};
			
			let subjectCount = 0;
			// Count all subjects across all assigned classes
			Object.values(assignedSubjectsMap).forEach(subjects => {
				subjectCount += subjects.length;
			});

			return `
				<div class="flex justify-between items-center p-3 bg-white border rounded-md">
					<span class="font-bold text-gray-800">${t.name}</span>
					<div class="text-right text-sm text-gray-600">
						Classes: ${assignedClassesArray.length} | Total Subjects: ${subjectCount}
					</div>
					<button onclick="openAssignHierarchyModal(${t.id})" class="btn btn-secondary !p-2 text-xs">
						📐 Edit
					</button>
					<button onclick="deleteTeacher(${t.id}, '${t.name}')" class="btn btn-danger !p-2 text-xs">🗑️</button>
				</div>
			`;
		}).join('') || '<p class="text-center text-gray-500 p-4">No faculty members found.</p>';
	};

    // --- Hierarchy Assignment Modal (for editing existing teachers) ---

	window.openAssignHierarchyModal = (teacherId) => {
		currentEditingTeacherId = teacherId;
		const teacher = facultyListCache.find(t => t.id === teacherId);
		if (!teacher) return;

		const modal = document.getElementById('modal-assign-hierarchy');
		const hierarchyOptions = getAllHierarchyOptions();
		// Use the map/object from the teacher record
		const assignedSubjectsMap = teacher.assigned_subjects || {}; 

		// 1. Prepare Classes Checkboxes with change listener, pre-checked based on assigned_classes
		const classesHtml = hierarchyOptions.classes.map(c =>
			`
			<label for="edit-class-${c}" class="checkbox-item">
				<input type="checkbox" 
					   id="edit-class-${c}" 
					   value="${c}" 
					   onchange="renderEditSubjectAssignmentFields(${teacherId})" 
					   ${teacher.assigned_classes?.includes(c) ? 'checked' : ''}>
				<span class="text-sm">${c}</span>
			</label>
			`
		).join('');

		// 2. Inject this new dynamic structure into the modal
		modal.querySelector('.card').innerHTML = `
			<h1 id="assign-hierarchy-title" class="text-2xl font-bold text-gray-900 mb-6">Permissions for ${teacher.name}</h1>
			<p class="text-gray-600 mb-4">Select the specific classes and subjects this teacher is responsible for.</p>

			<div class="input-group">
				<label class="block font-medium text-gray-700">✅ Step 1: Classes Taught</label>
				<div id="edit-teacher-classes-container" class="bg-white border rounded-lg p-2 h-32 overflow-y-auto space-y-1">
					${classesHtml}
				</div>
			</div>

			<div id="edit-class-subjects-wrapper" class="mt-6 border-t pt-4">
				<h3 class="text-md font-semibold text-gray-600 mb-3">📝 Step 2: Assign Subjects per Class</h3>
				<div id="edit-dynamic-subject-containers" class="space-y-4">
					</div>
			</div>

			<div class="mt-8 flex justify-end gap-4">
				<button onclick="closeAssignHierarchyModal()" class="btn btn-secondary">Cancel</button>
				<button onclick="saveTeacherHierarchy()" class="btn btn-success">💾 Save Permissions</button>
			</div>
		`;

		// 3. Initial subject rendering for the edit view, passing the current assignments
		renderEditSubjectAssignmentFields(teacherId, assignedSubjectsMap);

		window.navigateTo('modal-assign-hierarchy');
	};


    window.closeAssignHierarchyModal = () => {
         // Use navigateTo to go back (e.g., to the faculty management page)
         window.navigateTo('page-teacher-faculty-management');
        currentEditingTeacherId = null;
    };

	window.saveTeacherHierarchy = async () => {
		if (currentEditingTeacherId === null) return showToast("Error: Cannot save, no teacher selected.", "error");

		const assignedSubjectsMap = {};
		const classCheckboxes = document.querySelectorAll('#edit-teacher-classes-container input[type="checkbox"]:checked');
		
		// 1. Collect the new class-to-subject mapping from the edit modal
		classCheckboxes.forEach(classCheckbox => {
			const className = classCheckbox.value;
			const selectedSubjects = Array.from(
				document.querySelectorAll(`#edit-dynamic-subject-containers input[data-class="${className}"]:checked`)
			).map(cb => cb.value);

			if (selectedSubjects.length > 0) {
				assignedSubjectsMap[className] = selectedSubjects;
			}
		});
		
		// 2. Prepare the payload (class list from map keys)
		const selectedClasses = Object.keys(assignedSubjectsMap);
		
		if (selectedClasses.length === 0) {
			 if (!confirm("No classes or subjects are assigned. Proceed to remove all permissions?")) return;
		}

		showToast("Saving permissions...", 'info');

		// 3. Perform the update with the new structure
		const { error } = await supabase.from('teachers')
			.update({ assigned_classes: selectedClasses, assigned_subjects: assignedSubjectsMap })
			.eq('id', currentEditingTeacherId);

		if (error) {
			console.error("Hierarchy save error:", error);
			return showToast("Failed to save permissions. (Check RLS and DB column types)", "error");
		} else {
			showToast("Permissions saved successfully!", "success");
			closeAssignHierarchyModal();
			await fetchFacultyList();
			renderFacultyListUI();
		}
	};

    // --- Log Submission ---

    window.renderWeeklyLogBody = () => {
        const container = document.getElementById('weekly-log-body');
        // Generates the 7 rows for Mon-Sun
        container.innerHTML = daysOfWeek.map(day => `
			<tr>
				<td class="px-3 py-2 text-center font-semibold bg-gray-50">${day}</td>
				<td class="px-3 py-2"><input type="text" class="w-full p-1 border-none bg-transparent" data-day="${day}" placeholder="e.g., Chapter 5: Kinematics / Assignment Review"></td>
			</tr>
		`).join('');
    };

	window.filterSubjectDropdown = (teacherName, className) => {
		const subjectSelect = document.getElementById('log-subject');
		subjectSelect.innerHTML = '<option value="" selected disabled>-- Select Subject --</option>';
		subjectSelect.disabled = true;

		if (!teacherName || !className) return;

		const teacher = facultyListCache.find(t => t.name === teacherName);
		const assignedSubjectsMap = teacher?.assigned_subjects || {};
		
		// CRITICAL: Filter the subject list specifically by the selected class key
		const subjectsForClass = assignedSubjectsMap[className] || [];

		if (subjectsForClass.length > 0) {
			// Ensure subject dropdown contains only the subjects assigned to the SELECTED class
			subjectSelect.innerHTML = subjectsForClass.map(s =>
				`<option value="${s}">${s}</option>`
			).join('');
			subjectSelect.insertAdjacentHTML('afterbegin', '<option value="" selected disabled>-- Select Subject --</option>');
			subjectSelect.disabled = false;
		}
	};

		// (REPLACE THE EXISTING FUNCTION ENTIRELY)
	window.applySubmissionFilter = () => {
		const teacherSelect = document.getElementById('log-teacher-select');
		const classSelect = document.getElementById('log-class');
		const subjectSelect = document.getElementById('log-subject');

		const selectedTeacherName = teacherSelect.value;
		const teacher = facultyListCache.find(t => t.name === selectedTeacherName);

		// Reset fields to placeholders and disable them
		classSelect.innerHTML = '<option value="">-- Select Class --</option>';
		subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
		classSelect.disabled = true;
		subjectSelect.disabled = true;

		if (!teacher || !teacher.assigned_classes || !teacher.assigned_subjects) {
			renderWeeklyLogBody();
			return;
		}

		// 1. Populate Classes
		const assignedClasses = teacher.assigned_classes || [];
		if (assignedClasses.length > 0) {
			classSelect.innerHTML = assignedClasses.map(c =>
				`<option value="${c}">${c}</option>`
			).join('');
			classSelect.insertAdjacentHTML('afterbegin', '<option value="" selected disabled>-- Select Class --</option>');
			classSelect.disabled = false;
		}

		// 2. Define the final action function (checkAndLoad)
		const checkAndLoad = () => {
			const className = classSelect.value;
			const subjectName = subjectSelect.value;

			if (selectedTeacherName && className && className !== '' && subjectName && subjectName !== '') {
				// If all 3 are selected, attempt to load the log
				loadPreviousWeeklyTopics(selectedTeacherName, className, subjectName);
			} else {
				// Otherwise, just render an empty form
				renderWeeklyLogBody();
			}
		};
		
		// 3. CRITICAL FIX: Class selection triggers Subject filter and local reset.
		classSelect.onchange = () => {
			const className = classSelect.value;
			window.filterSubjectDropdown(selectedTeacherName, className);
			renderWeeklyLogBody(); 
			// Check if a subject was auto-selected (e.g., if there's only one option)
			if (subjectSelect.options.length === 2 && subjectSelect.options[1].value !== '') {
				 subjectSelect.value = subjectSelect.options[1].value; // Auto-select single subject
				 checkAndLoad();
			}
		};

		// 4. Attach the final loader/checker to the subject dropdown
		subjectSelect.onchange = checkAndLoad;

		// 5. Initial state cleanup
		renderWeeklyLogBody();
	};


    window.saveTeachingLog = async () => {
        const teacherName = document.getElementById('log-teacher-select').value;
        const className = document.getElementById('log-class').value.trim();
        const subject = document.getElementById('log-subject').value.trim();

        if (!teacherName || !className || !subject) {
            return showToast("Teacher, Class, and Subject are required.", "error");
        }

        const logData = {};
        let entriesFound = 0;
        document.querySelectorAll('#weekly-log-body input').forEach(input => {
            const topic = input.value.trim();
            if (topic) entriesFound++;
            logData[input.dataset.day] = topic;
        });

        if (entriesFound === 0) {
            return showToast("Please fill out at least one topic taught.", "error");
        }

        // Get week start date (Monday) using the helper function
        const weekStartDate = getWeekStartDate();

        const logPayload = {
            user_id: currentUser.id,
            teacher_name: teacherName,
            class_name: className,
            subject_name: subject,
            week_start_date: weekStartDate,
            weekly_topics: logData
        };

        showToast("Saving teaching log...", 'info');
        // RLS HINT: The INSERT requires RLS WRITE policy on 'teaching_logs'
        const { error } = await supabase.from('teaching_logs').upsert([logPayload], {
            onConflict: 'user_id,teacher_name,class_name,subject_name,week_start_date'
        });

        if (error) {
            console.error("Error saving teaching log:", error);
            return showToast("Failed to save log. (Check RLS WRITE policy on 'teaching_logs')", "error");
        }

        showToast("Weekly Log Saved Successfully!", "success");
        // Don't reset teacher select, just class/subject and topics
        document.getElementById('log-class').value = '';
        document.getElementById('log-subject').value = '';
        renderWeeklyLogBody();
    };


	  // (REPLACE THE EXISTING FUNCTION ENTIRELY)
	window.loadPreviousWeeklyTopics = async (teacherName, className, subjectName) => {
		// 1. Determine the week start date for the current week
		const weekStartDate = getWeekStartDate();

		// 2. Query the database using ALL the unique constraints
		const { data: log, error } = await supabase.from('teaching_logs')
			.select('weekly_topics')
			.eq('user_id', currentUser.id)
			.eq('teacher_name', teacherName)
			.eq('class_name', className)
			.eq('subject_name', subjectName)
			.eq('week_start_date', weekStartDate)
			.maybeSingle(); 

		// 3. Reset the input grid first (clears fields before populating them)
		renderWeeklyLogBody();

		if (error && error.code !== 'PGRST116') { // PGRST116 is 'No rows found' (expected case)
			console.error("DB Error fetching previous log:", error);
			showToast("Error retrieving previous data. Check Supabase RLS policies.", "error");
			return;
		}

		// 4. Populate fields if a log is found
		if (log && log.weekly_topics) {
			const topics = log.weekly_topics;
			let foundCount = 0;

			document.querySelectorAll('#weekly-log-body input').forEach(input => {
				const day = input.dataset.day;
				if (topics[day]) {
					input.value = topics[day];
					foundCount++;
				}
				input.readOnly = false;
			});

			if (foundCount > 0) {
				showToast("Previous submission for this week loaded! You may edit it.", "success");
			}
		} else {
			showToast("No previous submission found for this week. Start fresh.", "info");
		}
	};


    // --- FIND AND REPLACE THE ENTIRE 'window.loadAndDisplayTeachingLogs' FUNCTION ---
    window.loadAndDisplayTeachingLogs = async () => {
        if (!currentUser) {
            return showToast("Please log in.", "error");
        }
        showToast("Preparing filter...", 'info'); // Changed toast message

        try {
            // 1. Fetch faculty list (this must succeed due to RLS fixes)
            const facultyList = await fetchFacultyList();

            if (facultyList.length === 0) {
                showToast("No faculty members found. Please add a teacher first.", "warning");
                 // Don't show the modal if there are no teachers
                 return;
            }

            // 2. Setup UI
            const teacherSelect = document.getElementById('filter-teacher-select');
            teacherSelect.innerHTML = facultyList.map(t =>
                `<option value="${t.name}" data-id="${t.id}">${t.name}</option>`
            ).join('');

            teacherSelect.insertAdjacentHTML('afterbegin', '<option value="" selected disabled>-- Select Teacher --</option>');

            document.getElementById('filter-week-start').value = getWeekStartDate();
            document.getElementById('filter-class-select').innerHTML = '<option value="">-- Select Class --</option>';
            document.getElementById('filter-subject-select').innerHTML = '<option value="">-- Select Subject --</option>';
            document.getElementById('view-logs-button').disabled = true;

            // 3. CRITICAL: Use navigateTo for modal display.
            window.navigateTo('modal-log-filter');

            // 4. Final filter setup
            applyLogViewFilter(true);

            //showToast("Filter ready.", "success"); // Removed redundant toast

        } catch (error) {
            console.error("Critical Failure in loadAndDisplayTeachingLogs:", error);
            showToast("CRITICAL ERROR: Failed to prepare filter data. Check console.", "error");
        }
    };

	// (REPLACE THE EXISTING FUNCTION ENTIRELY)
	window.applyLogViewFilter = (resetSecondary) => {
		const teacherSelect = document.getElementById('filter-teacher-select');
		const classSelect = document.getElementById('filter-class-select');
		const subjectSelect = document.getElementById('filter-subject-select');
		const weekStartInput = document.getElementById('filter-week-start');
		const viewButton = document.getElementById('view-logs-button');

		const teacherName = teacherSelect.value;
		const className = classSelect.value; // Get selected class name
		const teacher = facultyListCache.find(t => t.name === teacherName);

		// Only reset the Class/Subject lists if the Teacher changed or a full reset is forced
		if (resetSecondary || !teacherName) {
			classSelect.innerHTML = '<option value="" selected disabled>-- Select Class --</option>';
			subjectSelect.innerHTML = '<option value="" selected disabled>-- Select Subject --</option>';
			classSelect.disabled = true;
			subjectSelect.disabled = true;
		}

		if (teacher) {
			// 1. Populate Classes (always update if teacher is selected)
			const assignedClasses = teacher.assigned_classes || [];
			if (assignedClasses.length > 0) {
				// Only update the options if resetSecondary is true or if the dropdown is empty
				if (classSelect.options.length <= 1 || resetSecondary) {
					classSelect.innerHTML = assignedClasses.map(c => `<option value="${c}" ${c === className ? 'selected' : ''}>${c}</option>`).join('');
					classSelect.insertAdjacentHTML('afterbegin', '<option value="" selected disabled>-- Select Class --</option>');
				}
				classSelect.disabled = false;
			} else {
				classSelect.innerHTML = '<option value="">-- No Classes Assigned --</option>';
				classSelect.disabled = true;
			}

			// 2. CRITICAL FIX: Populate Subjects based on the SELECTED CLASS
			const assignedSubjectsMap = teacher.assigned_subjects || {};
			const subjectsForSelectedClass = assignedSubjectsMap[className] || [];
			
			if (className && subjectsForSelectedClass.length > 0) {
				// Only update the options if resetSecondary is true or if the dropdown is empty
				if (subjectSelect.options.length <= 1 || resetSecondary || subjectSelect.value === '') {
					subjectSelect.innerHTML = subjectsForSelectedClass.map(s => `<option value="${s}">${s}</option>`).join('');
					subjectSelect.insertAdjacentHTML('afterbegin', '<option value="" selected disabled>-- Select Subject --</option>');
				}
				subjectSelect.disabled = false;
			} else if (className) {
				subjectSelect.innerHTML = '<option value="" selected disabled>-- No Subjects Assigned --</option>';
				subjectSelect.disabled = true;
			} else {
				// Keep placeholder if no class is selected
				subjectSelect.innerHTML = '<option value="" selected disabled>-- Select Subject --</option>';
				subjectSelect.disabled = true;
			}
		}

		// 3. Update Week Display
		const startDate = weekStartInput.value;
		document.getElementById('filter-week-display').textContent = startDate
			? `Week selected: ${new Date(startDate).toLocaleDateString()}`
			: `Week selected: (Date required)`;

		// 4. Enable Button if all necessary fields are selected
		if (teacherName && classSelect.value && classSelect.value !== '' && subjectSelect.value && subjectSelect.value !== '' && startDate) {
			viewButton.disabled = false;
		} else {
			viewButton.disabled = true;
		}
	};

    // --- FIND AND REPLACE THE ENTIRE 'window.queryTeachingLogs' FUNCTION ---
    window.queryTeachingLogs = async () => {
        const teacherName = document.getElementById('filter-teacher-select').value;
        const className = document.getElementById('filter-class-select').value;
        const subjectName = document.getElementById('filter-subject-select').value;
        const weekStartDate = document.getElementById('filter-week-start').value;

        if (!teacherName || !className || !subjectName || !weekStartDate) {
            // Re-show the filter modal (in case it was hidden by a prior attempt)
            window.navigateTo('modal-log-filter'); // Use navigateTo
            return showToast("Please select all filters.", "error");
        }

        showToast("Fetching filtered logs...", 'info');

        // 1. Hide filter modal immediately using navigateTo back to dashboard temporarily
        window.navigateTo('page-teacher-dashboard'); // Go back to dashboard while loading

        // Run the query (removed error handling here to simplify, relying on fetch to throw/return)
        const { data: logs, error } = await supabase.from('teaching_logs')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('teacher_name', teacherName)
            .eq('class_name', className)
            .eq('subject_name', subjectName)
            .eq('week_start_date', weekStartDate)
            .order('week_start_date', { ascending: false });

        if (error) {
            console.error("Error fetching filtered logs:", error);
            // Show generic app error modal if database query fails
            showSimpleModal('Database Error', `<p class="text-red-600">The server failed to retrieve the logs. Please check your network and Supabase connection.</p><p class="text-xs mt-3">${error.message}</p>`);
            // Don't show toast here as the modal handles it
            return;
        }

        // 2. Display the results in the simple message box (app-message-box) using the dedicated function
        displayLogsInModal(logs); // This function now calls showSimpleModal internally
        //showToast("Logs loaded.", "success"); // Toast might be confusing if modal pops up
    };


</script>

	<div id="page-teacher-log-print" class="page">
		<main class="flex-grow p-2 md:p-4">
			<div class="max-w-7xl mx-auto mb-4 p-4 card no-print">
				<div class="flex justify-between items-center flex-wrap gap-4">
					<div>
						<h2 class="text-xl font-bold text-slate-800 text-left">Print Teacher Logs</h2>
						<p class="text-sm text-slate-600">Select filters to generate a printable report.</p>
					</div>
					<div class="flex justify-center gap-4 flex-wrap">
						<button onclick="navigateTo('page-teacher-dashboard')" class="btn btn-secondary">⬅️ Back</button>
						<button onclick="generateAndPrintLogs()" class="btn btn-primary">🖨️ Generate & Print</button>
					</div>
				</div>
				<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 border-t pt-4">
					<div class="input-group !mb-0">
						<label for="print-log-teacher-select">Teacher</label>
						<select id="print-log-teacher-select" onchange="populatePrintLogSubjects()"></select>
					</div>
					<div class="input-group !mb-0">
						<label for="print-log-subject-select">Subject (Optional)</label>
						<select id="print-log-subject-select"></select>
					</div>
					 <div class="input-group !mb-0">
						<label for="print-log-date-filter">Start Date (Optional)</label>
						<input type="date" id="print-log-date-filter">
					</div>
				</div>
			</div>
			<div id="log-print-display-area" class="printable-area full-report-container bg-white">
				<div class="text-center p-12 text-gray-500">Select filters and click "Generate & Print" to see the report here.</div>
			</div>
		</main>
	</div>

	<div id="modal-invite-user" class="page items-center justify-center modal-backdrop hidden z-40">
		<div class="w-full max-w-lg card p-8 m-4">
			<h1 class="text-2xl font-bold text-gray-900 mb-6">Create New User Account</h1>
			<p class="text-sm text-gray-500 -mt-4 mb-6">You are creating this account. You must share the password with the user yourself.</p>
			<div class="space-y-4">
				<div class="input-group">
					<label for="invite-email">User's Email Address</label>
					<input type="email" id="invite-email" placeholder="e.g., teacher@example.com">
				</div>
				<div class="input-group">
					<label for="invite-password">Create Temporary Password</label>
					<input type="password" id="invite-password" placeholder="Min. 6 characters. Share this with the user.">
				</div>
				<div class="input-group">
					<label for="invite-role">Assign Role</label>
					<select id="invite-role">
						<option value="viewer">Viewer (Read-Only)</option>
						<option value="editor">Editor (Can add/edit data)</option>
					</select>
				</div>
			</div>
			<div class="mt-8 flex justify-end gap-4">
				<button onclick="navigateTo('page-organization-management')" class="btn btn-secondary">Cancel</button>
				<button onclick="orgMgmt_createNewUser()" class="btn btn-primary">✅ Create Account</button>
			</div>
		</div>
	</div>

</body>
</html>



